<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-bust" content="v2.0.1">
    <title>ZABAL Live Hub ‚Äî Stream Coordination</title>
    <meta name="description" content="Vote daily on ZABAL's creative stream direction! Community-driven Farcaster miniapp for choosing Studio, Market, Social, or Battle mode. Join the ZABAL community and shape the stream.">
    <meta name="keywords" content="ZABAL, Farcaster, miniapp, voting, stream, NFT, art, community, web3, crypto art, social voting">
    <meta name="author" content="ZABAL">
    <meta name="theme-color" content="#141e27">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#141e27">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://zabal.art/">
    
    <!-- CRITICAL: Call ready() when DOM is loaded -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ DOM loaded, attempting to dismiss splash...');
            
            // Method 1: Direct postMessage
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({ type: 'ready' }, '*');
                console.log('üì§ Sent ready postMessage to parent');
            }
            
            // Method 2: Try SDK if available
            if (window.sdk && window.sdk.actions && window.sdk.actions.ready) {
                window.sdk.actions.ready().then(function() {
                    console.log('‚úÖ SDK ready() succeeded');
                }).catch(function(err) {
                    console.log('‚ö†Ô∏è SDK ready() failed:', err);
                });
            }
        });
    </script>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ZABAL Live Hub - Vote on Stream Direction">
    <meta property="og:description" content="Vote daily on ZABAL's direction! Choose Studio, Market, Social, or Battle mode to shape the stream.">
    <meta property="og:image" content="https://zabal.art/assets/preview.png">
    <meta property="og:url" content="https://zabal.art">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="ZABAL Live Hub">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ZABAL Live Hub - Vote on Stream Direction">
    <meta name="twitter:description" content="Vote daily on ZABAL's direction! Choose Studio, Market, Social, or Battle mode to shape the stream.">
    <meta name="twitter:image" content="https://zabal.art/assets/preview.png">
    <meta name="twitter:site" content="@zabal">
    <meta name="twitter:creator" content="@zabal">
    
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "ZABAL Live Hub",
      "description": "Community-driven voting platform for ZABAL's stream direction. Vote daily on Studio, Market, Social, or Battle mode.",
      "url": "https://zabal.art",
      "applicationCategory": "SocialNetworkingApplication",
      "operatingSystem": "Web",
      "browserRequirements": "Requires JavaScript. Works on mobile and desktop.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
      },
      "creator": {
        "@type": "Person",
        "name": "ZABAL",
        "url": "https://warpcast.com/zaal",
        "sameAs": [
          "https://twitter.com/zabal",
          "https://warpcast.com/zaal"
        ]
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5",
        "ratingCount": "1"
      },
      "potentialAction": {
        "@type": "VoteAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://zabal.art",
          "actionPlatform": [
            "http://schema.org/DesktopWebPlatform",
            "http://schema.org/MobileWebPlatform"
          ]
        }
      }
    }
    </script>
    
    <!-- Additional Geo-targeting and Language Meta Tags -->
    <meta name="geo.region" content="US">
    <meta name="geo.placename" content="United States">
    <meta name="language" content="en">
    <meta name="distribution" content="global">
    <meta name="rating" content="general">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    
    <!-- Performance and Preconnect Hints -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://esm.sh">
    <link rel="dns-prefetch" href="https://zabal.art">
    
    <!-- Farcaster Mini App Embed Meta Tag -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://zabal.art/assets/preview.png","button":{"title":"üé® Vote Now","action":{"type":"launch_frame","name":"ZABAL Live Hub","url":"https://zabal.art","splashImageUrl":"https://zabal.art/assets/splash.png","splashBackgroundColor":"#141e27"}}}' />
    <!-- For backward compatibility -->
    <meta name="fc:frame" content='{"version":"1","imageUrl":"https://zabal.art/assets/preview.png","button":{"title":"üé® Vote Now","action":{"type":"launch_frame","name":"ZABAL Live Hub","url":"https://zabal.art","splashImageUrl":"https://zabal.art/assets/splash.png","splashBackgroundColor":"#141e27"}}}' />
    
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script type="module">
        // Import Farcaster SDK and wait for it to load
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        window.farcasterSDK = sdk;
        window.farcasterSDKLoaded = true;
        console.log('‚úÖ Farcaster SDK loaded');
        
        // Immediately call ready() to dismiss splash screen
        try {
            await sdk.actions.ready();
            window.splashDismissed = true;
            console.log('‚úÖ Splash screen dismissed immediately via SDK');
        } catch (err) {
            console.log('‚ö†Ô∏è Immediate ready() failed:', err);
        }
    </script>
    <script>
        // Aggressive fallback: Force hide splash screen after 3 seconds
        window.splashDismissed = false;
        
        setTimeout(() => {
            if (!window.splashDismissed) {
                console.log('üö® FORCING splash screen removal after 1s timeout');
                
                // Try multiple methods to hide splash screen
                const splashSelectors = [
                    '.fc-splash-screen',
                    '[class*="splash"]',
                    '[class*="Splash"]',
                    'iframe[src*="splash"]'
                ];
                
                splashSelectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.remove();
                    });
                });
                
                // Ensure body is scrollable
                document.body.style.overflow = 'auto';
                document.documentElement.style.overflow = 'auto';
                
                // Mark as dismissed
                window.splashDismissed = true;
                console.log('‚úÖ Splash screen forcefully removed');
            }
        }, 1000);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #141e27;
            --accent-yellow: #e0ddaa;
            --bg-black: #000000;
            --text-white: #ffffff;
            --text-gray: #a0a0a0;
            --border-color: #2a3a47;
            --hover-glow: rgba(224, 221, 170, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--bg-black);
            color: var(--text-white);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            padding: 1.5rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--text-white) 0%, var(--accent-yellow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            white-space: nowrap;
        }

        nav {
            display: flex;
            gap: 2rem;
        }

        nav a {
            color: var(--text-gray);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }

        nav a:hover {
            color: var(--accent-yellow);
        }

        nav a.active {
            color: var(--accent-yellow);
        }

        /* Live State Hero */
        .live-hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 120px 20px 60px;
            position: relative;
        }

        .hero-state {
            margin-bottom: 2rem;
            font-size: 0.9rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .hero-state.deciding {
            color: var(--accent-yellow);
            animation: pulse-text 2s ease-in-out infinite;
        }

        .hero-state.locked {
            color: #4a9eff;
        }

        .hero-state.live {
            color: #ff4444;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
        }

        /* Settings Toggle */
        .settings-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(20, 30, 39, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .settings-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 0.85rem;
            color: var(--text-gray);
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .setting-description {
            font-size: 0.7rem;
            color: var(--text-gray);
            opacity: 0.7;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .toggle-switch.active {
            background: var(--accent-yellow);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: var(--secondary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }

        .toast.success {
            border-color: #4ade80;
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, var(--secondary-blue) 100%);
        }

        .toast.error {
            border-color: #f87171;
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.1) 0%, var(--secondary-blue) 100%);
        }

        .toast.info {
            border-color: var(--accent-yellow);
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.1) 0%, var(--secondary-blue) 100%);
        }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-white);
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 0.85rem;
            color: var(--text-gray);
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: var(--text-white);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease-in forwards;
        }

        @media (max-width: 768px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .toast {
                min-width: auto;
            }
        }

        /* Share Modal */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px 0;
        }

        .share-modal.active {
            display: flex;
        }

        .share-modal-content {
            background: linear-gradient(135deg, #141e27 0%, #1a2a37 100%);
            border: 2px solid var(--accent-yellow);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            -webkit-overflow-scrolling: touch;
        }

        .share-modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .share-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 8px;
        }

        .share-modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .share-link-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .share-link-text {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-white);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .copy-link-btn {
            padding: 8px 16px;
            background: var(--accent-yellow);
            color: var(--primary-blue);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-link-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .share-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .share-action-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-farcaster-btn {
            background: linear-gradient(135deg, #8a63d2 0%, #7c4dff 100%);
            color: white;
        }

        .share-farcaster-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(138, 99, 210, 0.4);
        }

        .share-close-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-gray);
        }

        .share-close-btn:hover {
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        /* User Profile Badge */
        .user-profile-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px 4px 4px;
            background: rgba(224, 221, 170, 0.08);
            border: 1px solid rgba(224, 221, 170, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--accent-yellow);
            font-weight: 600;
            transition: all 0.3s ease;
            max-width: 200px;
        }

        .user-profile-badge {
            cursor: pointer;
            position: relative;
        }

        .user-profile-badge:hover {
            background: rgba(224, 221, 170, 0.15);
            border-color: var(--accent-yellow);
        }

        /* Settings Dropdown */
        .settings-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .settings-dropdown.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .settings-dropdown-header {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-dropdown-item:last-child {
            border-bottom: none;
        }

        .settings-dropdown-label {
            font-size: 0.85rem;
            color: var(--text-gray);
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .settings-dropdown-description {
            font-size: 0.7rem;
            color: var(--text-gray);
            opacity: 0.7;
        }

        .settings-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }

        .enable-notifications-btn {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #c9b961 100%);
            color: var(--primary-blue);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .enable-notifications-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .enable-notifications-btn.enabled {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .settings-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }

        .enable-notifications-btn {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #c9b961 100%);
            color: var(--primary-blue);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .enable-notifications-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .enable-notifications-btn.enabled {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        /* Friend Tagging Section */
        .friend-tag-section {
            margin: 20px 0;
            padding: 16px;
            background: rgba(20, 30, 39, 0.5);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .friend-tag-header {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .reconnect-btn {
            background: rgba(224, 221, 170, 0.1);
            border: 1px solid var(--accent-yellow);
            color: var(--accent-yellow);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reconnect-btn:hover {
            background: rgba(224, 221, 170, 0.2);
            transform: scale(1.05);
        }
        
        .selected-friends-indicator {
            width: 100%;
            padding: 8px 12px;
            background: rgba(224, 221, 170, 0.15);
            border: 1px solid var(--accent-yellow);
            border-radius: 8px;
            color: var(--accent-yellow);
            font-size: 0.85rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
        }

        .friend-tag-count {
            font-size: 0.8rem;
            color: var(--accent-yellow);
            font-weight: 600;
        }

        .show-more-friends {
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--secondary-blue);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-white);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .show-more-friends:hover {
            border-color: var(--accent-yellow);
            background: rgba(224, 221, 170, 0.1);
        }

        .friend-tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .friend-tag-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--secondary-blue);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-tag-item:hover {
            border-color: var(--accent-yellow);
            background: rgba(224, 221, 170, 0.1);
        }

        .friend-tag-item.selected {
            background: var(--accent-yellow);
            color: var(--bg-black);
            border-color: var(--accent-yellow);
            transform: scale(1.05);
        }

        .friend-tag-item.selected .friend-tag-username {
            color: var(--bg-black);
            font-weight: 700;
        }
        
        .friend-tag-item.selected::before {
            content: '‚úì';
            margin-right: 4px;
            font-weight: 900;
        }
        
        .inactive-badge {
            margin-left: 4px;
            opacity: 0.7;
        }

        .friend-tag-pfp {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--accent-yellow);
        }

        .friend-tag-username {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Top Friend Invitation */
        .top-friend-invite {
            margin: 20px 0;
            padding: 16px;
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.1) 0%, rgba(224, 221, 170, 0.05) 100%);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
        }

        .invite-header {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 12px;
        }

        .top-friend-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--secondary-blue);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .top-friend-pfp {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-yellow);
        }

        .top-friend-info {
            flex: 1;
        }

        .top-friend-username {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-white);
        }

        .top-friend-label {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .invite-friend-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-yellow);
            color: var(--bg-black);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .invite-friend-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .challenge-friends-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .challenge-friends-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        /* Now Live Banner */
        .now-live-banner {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 99;
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
            animation: slideDown 0.5s ease;
        }

        .live-pulse {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .live-text {
            color: white;
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        .watch-now-btn {
            padding: 8px 20px;
            background: white;
            color: #ff0000;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watch-now-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        /* Live Share Modal */
        .live-share-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .live-share-modal.active {
            display: flex;
        }

        .live-share-content {
            background: var(--primary-blue);
            border: 2px solid var(--accent-yellow);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            position: relative;
        }

        .live-share-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .live-share-title {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--accent-yellow);
            margin-bottom: 8px;
        }

        .live-share-subtitle {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .platform-links {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .platform-link-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--secondary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .platform-link-card:hover {
            border-color: var(--accent-yellow);
            transform: translateX(4px);
        }

        .platform-icon {
            font-size: 2rem;
        }

        .platform-info {
            flex: 1;
        }

        .platform-name {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 4px;
        }

        .platform-url {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .platform-btn {
            padding: 8px 16px;
            background: var(--accent-yellow);
            color: var(--bg-black);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .platform-btn:hover {
            transform: scale(1.05);
        }

        .live-share-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .share-live-btn {
            padding: 15px;
            background: linear-gradient(135deg, #8a63d2 0%, #7c4dff 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-live-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(138, 99, 210, 0.4);
        }

        .close-live-modal-btn {
            padding: 12px;
            background: transparent;
            color: var(--text-gray);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-live-modal-btn:hover {
            border-color: var(--accent-yellow);
            color: var(--text-white);
        }

        /* Vote History Accordion Section */
        .vote-history-accordion-section {
            background: linear-gradient(180deg, var(--bg-black) 0%, #0a0a0a 100%);
            padding: 40px 20px 60px;
            border-top: 1px solid var(--border-color);
        }

        .vote-history-accordion {
            max-width: 1200px;
            margin: 0 auto;
        }

        .accordion-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 30px;
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: inherit;
            font-family: inherit;
        }

        .accordion-header:hover {
            border-color: var(--accent-yellow);
            background: var(--secondary-blue);
            transform: translateY(-2px);
        }

        .accordion-header.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: transparent;
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: 20px;
            text-align: left;
        }

        .accordion-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        .accordion-text h3 {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text-white);
            margin: 0 0 4px 0;
        }

        .accordion-text p {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin: 0;
        }

        .accordion-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--secondary-blue);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .accordion-header:hover .accordion-toggle {
            background: var(--accent-yellow);
        }

        .chevron-icon {
            color: var(--text-white);
            transition: transform 0.3s ease;
        }

        .accordion-header:hover .chevron-icon {
            color: var(--bg-black);
        }

        .accordion-header.active .chevron-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-top: none;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        .accordion-content.expanded {
            max-height: 5000px;
        }

        .accordion-inner {
            padding: 30px;
        }

        .vote-history-timeline {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .vote-day-card {
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .vote-day-card:hover {
            border-color: var(--accent-yellow);
            transform: translateY(-2px);
        }

        .vote-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .vote-day-date {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .vote-day-winner {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-white);
        }

        .winner-badge {
            padding: 4px 12px;
            background: var(--accent-yellow);
            color: var(--bg-black);
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .vote-day-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .mode-stat {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--secondary-blue);
            border-radius: 8px;
        }

        .mode-stat-icon {
            font-size: 1.5rem;
        }

        .mode-stat-info {
            flex: 1;
        }

        .mode-stat-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 2px;
        }

        .mode-stat-votes {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .vote-day-voters {
            margin-top: 15px;
        }

        .voters-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .voters-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .voter-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(26, 42, 55, 0.4);
            border: 1px solid rgba(224, 221, 170, 0.15);
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .voter-tag:hover {
            background: var(--primary-blue);
            border-color: var(--accent-yellow);
            transform: translateY(-1px);
        }

        .voter-pfp {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1.5px solid rgba(224, 221, 170, 0.3);
            object-fit: cover;
        }

        .voter-mode-icon {
            font-size: 0.9rem;
            line-height: 1;
        }

        .voter-username {
            color: var(--text-white);
            font-weight: 500;
            opacity: 0.9;
        }

        .voter-display-name {
            color: var(--text-gray);
            font-size: 0.75rem;
            margin-left: 4px;
        }

        .loading-votes {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-size: 0.95rem;
        }

        .no-history {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }

        @media (max-width: 768px) {
            .now-live-banner {
                top: 50px;
                padding: 10px 15px;
                gap: 10px;
            }

            .live-text {
                font-size: 0.85rem;
            }

            .watch-now-btn {
                padding: 6px 15px;
                font-size: 0.85rem;
            }

            .live-share-content {
                padding: 20px;
            }

            .vote-day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .vote-day-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        .user-pfp {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--accent-yellow);
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .user-name-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .verified-badge {
            font-size: 0.7rem;
            color: var(--accent-yellow);
        }

        .user-fid {
            font-size: 0.65rem;
            color: var(--text-gray);
            opacity: 0.8;
        }

        /* Personal Stats Section */
        .personal-stats {
            background: linear-gradient(135deg, rgba(20, 30, 39, 0.5) 0%, rgba(26, 42, 55, 0.5) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            display: block;
        }

        .personal-stats.active {
            display: block;
        }

        .stats-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            display: block;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 4px;
        }

        .stat-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hero-title {
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 900;
            margin-bottom: 1.5rem;
            line-height: 1.1;
        }

        .hero-subtitle {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: var(--text-gray);
            margin-bottom: 3rem;
            max-width: 700px;
        }

        .countdown {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: rgba(20, 30, 39, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .countdown-label {
            font-size: 0.9rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .countdown-time {
            color: var(--accent-yellow);
            font-variant-numeric: tabular-nums;
        }

        .hero-cta {
            display: none;
        }

        /* Stream Wheel Section */
        .wheel-section {
            padding: 60px 20px;
            background: linear-gradient(180deg, var(--bg-black) 0%, #0a0a0a 100%);
            position: relative;
        }

        .wheel-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 100px;
            background: linear-gradient(180deg, transparent 0%, var(--border-color) 100%);
        }

        .wheel-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .wheel-header h2 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 900;
            margin-bottom: 1rem;
        }

        .wheel-header p {
            font-size: 1.2rem;
            color: var(--text-gray);
            max-width: 600px;
            margin: 0 auto;
        }

        .wheel-container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            gap: 1.25rem;
        }

        .mode-card {
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.25rem;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-yellow);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .mode-card:hover {
            border-color: var(--accent-yellow);
            transform: translateX(5px);
        }

        .mode-card:hover::before {
            transform: scaleX(1);
        }

        .mode-card.leading {
            border-color: var(--accent-yellow);
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.05) 0%, var(--primary-blue) 100%);
        }

        .mode-card.leading::before {
            transform: scaleX(1);
        }

        .mode-icon {
            font-size: 2.25rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .mode-info {
            flex: 1;
        }

        .mode-name {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 0.35rem;
            color: var(--text-white);
        }

        .mode-description {
            color: var(--text-gray);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .mode-votes {
            text-align: center;
            min-width: 90px;
        }

        .vote-count {
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent-yellow);
            display: block;
            margin-bottom: 0.15rem;
        }

        .vote-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vote-checkbox-hidden {
            display: none;
        }

        .selectable-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .selectable-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(224, 221, 170, 0.3);
        }

        .selectable-card.selected {
            border-color: var(--accent-yellow);
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.1) 0%, var(--primary-blue) 100%);
            box-shadow: 0 0 20px rgba(224, 221, 170, 0.4);
        }

        .selectable-card.selected::before {
            content: '';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: var(--accent-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selectable-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            font-size: 1.2rem;
            font-weight: 900;
            z-index: 1;
        }

        .selection-indicator {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .selectable-card.selected .selection-indicator {
            display: block;
        }

        .submit-votes-container {
            margin-top: 32px;
            text-align: center;
        }

        .submit-votes-btn {
            padding: 16px 48px;
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #c9b961 100%);
            color: var(--primary-blue);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .submit-votes-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(224, 221, 170, 0.5);
        }

        .submit-votes-btn:disabled {
            background: var(--border-color);
            color: var(--text-gray);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        /* Today/Yesterday Section */
        .stream-history {
            padding: 80px 20px;
            background: var(--bg-black);
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        .history-card {
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .history-label {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(224, 221, 170, 0.1);
            border: 1px solid var(--accent-yellow);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--accent-yellow);
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-mode {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 1rem;
        }

        .history-description {
            color: var(--text-gray);
            margin-bottom: 1.5rem;
        }

        .history-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-yellow);
            text-decoration: none;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .history-link:hover {
            gap: 0.75rem;
        }

        /* Built on Stream Section */
        .artifacts-section {
            padding: 100px 20px;
            background: linear-gradient(180deg, var(--bg-black) 0%, #0a0a0a 100%);
        }

        .artifacts-header {
            text-align: center;
            margin-bottom: 4rem;
        }

        .artifacts-header h2 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 900;
            margin-bottom: 1rem;
        }

        .artifacts-header p {
            font-size: 1.2rem;
            color: var(--text-gray);
        }

        .artifacts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .artifact-card {
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .artifact-card:hover {
            border-color: var(--accent-yellow);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--hover-glow);
        }

        .artifact-type {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            font-size: 0.85rem;
            color: var(--accent-yellow);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .artifact-content {
            padding: 1.5rem;
        }

        .artifact-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .artifact-meta {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 1rem;
        }

        .artifact-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-yellow);
            text-decoration: none;
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Proof Section */
        .proof-section {
            padding: 80px 20px;
            background: var(--bg-black);
            text-align: center;
        }

        .proof-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 3rem;
            max-width: 1000px;
            margin: 3rem auto 0;
        }

        .proof-item {
            text-align: center;
        }

        .proof-number {
            font-size: clamp(3rem, 6vw, 5rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--text-white) 0%, var(--accent-yellow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
            margin-bottom: 0.5rem;
        }

        .proof-label {
            font-size: 1rem;
            color: var(--text-gray);
            font-weight: 600;
        }

        /* Footer */
        footer {
            padding: 60px 20px;
            background: var(--bg-black);
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--text-gray);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--accent-yellow);
        }

        .footer-tagline {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            header {
                padding: 10px 16px;
            }

            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
            }

            .logo {
                font-size: 1.1rem;
                flex-shrink: 0;
            }

            nav {
                gap: 0.8rem;
            }
            
            nav a {
                font-size: 0.75rem;
            }

            .user-profile-badge {
                display: none;
            }

            .user-pfp {
                width: 24px;
                height: 24px;
            }

            .user-fid {
                font-size: 0.6rem;
            }

            .container {
                padding: 0 16px;
            }

            section {
                padding: 20px 0;
            }

            .personal-stats {
                margin: 8px 16px;
                padding: 10px;
            }

            .stats-header {
                margin-bottom: 8px;
                padding-bottom: 6px;
            }

            .stats-title {
                font-size: 0.85rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .stat-item {
                padding: 6px 4px;
            }

            .stat-value {
                font-size: 1.1rem;
                margin-bottom: 2px;
            }

            .stat-label {
                font-size: 0.55rem;
                line-height: 1.2;
            }

            .live-hero {
                padding: 20px 20px 25px;
                min-height: auto;
            }

            .hero-state {
                font-size: 0.7rem;
                padding: 4px 12px;
                margin-bottom: 10px;
            }

            .hero-title {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
                line-height: 1.2;
            }

            .hero-subtitle {
                font-size: 0.85rem;
                margin-bottom: 1rem;
            }

            .countdown {
                margin-top: 1rem;
            }

            .countdown-label {
                font-size: 0.75rem;
            }

            .countdown-time {
                font-size: 1.5rem;
            }

            .hero-cta {
                display: none;
            }

            .wheel-section {
                padding: 25px 0;
            }

            .wheel-header h2 {
                font-size: 1.3rem;
                margin-bottom: 0.5rem;
            }

            .wheel-header p {
                font-size: 0.85rem;
            }

            .mode-card {
                grid-template-columns: 1fr;
                text-align: center;
                padding: 0.5rem;
                gap: 0.3rem;
                border-radius: 6px;
                border-width: 1px;
            }

            .mode-icon {
                margin: 0 auto;
                width: 28px;
                height: 28px;
                font-size: 1.1rem;
                border-radius: 4px;
            }

            .mode-name {
                font-size: 0.8rem;
                margin-bottom: 0.1rem;
                font-weight: 700;
            }

            .mode-description {
                display: none;
            }

            .mode-votes {
                min-width: auto;
                margin-top: 0.15rem;
            }

            .vote-count {
                font-size: 1rem;
                margin-bottom: 0.05rem;
            }

            .vote-label {
                font-size: 0.5rem;
            }

            .vote-button {
                margin-top: 0.3rem;
                padding: 5px 10px;
                font-size: 0.7rem;
            }

            .mode-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            nav {
                gap: 0.75rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            nav a {
                font-size: 0.85rem;
            }

            .share-modal-content {
                width: 95%;
                padding: 24px;
            }

            .share-link-box {
                flex-direction: column;
                gap: 8px;
            }

            .copy-link-btn {
                width: 100%;
            }

            .history-grid {
                grid-template-columns: 1fr;
            }

            .artifacts-grid {
                grid-template-columns: 1fr;
            }

            .vote-day-stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 12px;
                margin-bottom: 15px;
            }

        @media (max-width: 480px) {
            header {
                padding: 8px 12px;
            }

            .logo {
                font-size: 1rem;
            }

            .user-profile-badge {
                padding: 2px 8px 2px 2px;
                font-size: 0.65rem;
                max-width: 140px;
                border-radius: 14px;
                gap: 5px;
            }

            .user-pfp {
                width: 22px;
                height: 22px;
            }

            .user-name {
                font-size: 0.65rem;
            }

            .user-fid {
                font-size: 0.55rem;
            }

            .verified-badge {
                font-size: 0.6rem;
            }

            .container {
                padding: 0 12px;
            }

            section {
                padding: 15px 0;
            }

            .personal-stats {
                margin: 6px 12px;
                padding: 8px;
            }

            .stats-header {
                margin-bottom: 6px;
                padding-bottom: 4px;
            }

            .stats-title {
                font-size: 0.75rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .stat-item {
                padding: 4px 2px;
            }

            .stat-value {
                font-size: 1rem;
                margin-bottom: 2px;
            }

            .stat-label {
                font-size: 0.5rem;
                line-height: 1.1;
            }

            .live-hero {
                padding: 15px 16px 20px;
            }

            .hero-state {
                font-size: 0.65rem;
                padding: 3px 10px;
                margin-bottom: 8px;
            }

            .hero-title {
                font-size: 1.3rem;
                margin-bottom: 0.4rem;
                line-height: 1.15;
            }

            .hero-subtitle {
                font-size: 0.8rem;
                margin-bottom: 0.75rem;
            }

            .countdown {
                margin-top: 0.75rem;
            }

            .countdown-label {
                font-size: 0.7rem;
                margin-bottom: 0.25rem;
            }

            .countdown-time {
                font-size: 1.3rem;
            }

            .hero-cta {
                display: none;
            }

            .wheel-section {
                padding: 20px 0;
            }

            .wheel-header h2 {
                font-size: 1.1rem;
                margin-bottom: 0.4rem;
            }

            .wheel-header p {
                font-size: 0.8rem;
            }

            .mode-card {
                padding: 0.45rem;
                gap: 0.25rem;
                border-radius: 6px;
                border-width: 1px;
            }

            .mode-icon {
                width: 26px;
                height: 26px;
                font-size: 1rem;
                border-radius: 3px;
            }

            .mode-name {
                font-size: 0.75rem;
                margin-bottom: 0.08rem;
                font-weight: 700;
            }

            .mode-description {
                display: none;
            }

            .mode-votes {
                min-width: auto;
                margin-top: 0.12rem;
            }

            .vote-count {
                font-size: 0.95rem;
                margin-bottom: 0.05rem;
            }

            .vote-label {
                font-size: 0.48rem;
                letter-spacing: 0.1px;
            }

            .mode-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.4rem;
            }

            .vote-button {
                width: 100%;
                padding: 4px;
                font-size: 0.65rem;
                margin-top: 0.25rem;
            }

            .history-grid,
            .artifacts-grid {
                gap: 0.65rem;
            }

            .history-card,
            .artifact-card {
                padding: 0.875rem;
            }
        }
    </style>
    
    <!-- Production Enhancement Styles -->
    <link rel="stylesheet" href="css/production-styles.css">
    
    <!-- Core Modules (Load First) -->
    <script src="js/config.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/lifecycle.js"></script>
    <script src="js/state-manager.js"></script>
    <script src="js/database.js"></script>
    <script src="js/api-throttle.js"></script>
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#votingSection" class="skip-to-content">Skip to voting</a>
    
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
        ‚ö†Ô∏è You're offline. Some features may not work.
    </div>
    
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">ZABAL</a>
            <nav>
                <a href="index.html" class="active">Vote</a>
                <a href="submissions.html">Submit</a>
                <a href="gallery.html">Research</a>
                <a href="chat.html">Chat</a>
                <a href="https://www.thezao.com/nexus" target="_blank">ZAO Nexus</a>
            </nav>
            <div id="userProfile" class="user-profile-badge" style="display: none;" onclick="toggleSettingsDropdown()">
                <img id="userPfp" class="user-pfp" src="" alt="Profile" onerror="this.style.display='none'">
                <div class="user-info">
                    <div class="user-name-row">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="verified-badge" id="verifiedBadge" style="display: none;">‚úì</span>
                    </div>
                    <span class="user-fid" id="userFidDisplay"></span>
                </div>
                
                <!-- Settings Dropdown -->
                <div id="settingsDropdown" class="settings-dropdown" onclick="event.stopPropagation()">
                    <div class="settings-dropdown-header">
                        ‚öôÔ∏è Share Settings
                    </div>
                    
                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>Auto-share votes</span>
                            <span class="settings-dropdown-description">Automatically share when you vote</span>
                        </div>
                        <div class="toggle-switch" id="autoShareToggleProfile" onclick="toggleSetting('autoShare')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>Share only when leading</span>
                            <span class="settings-dropdown-description">Only auto-share if your mode is winning</span>
                        </div>
                        <div class="toggle-switch" id="shareLeadingToggleProfile" onclick="toggleSetting('shareLeading')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>Milestone celebrations</span>
                            <span class="settings-dropdown-description">Share on 10th, 50th, 100th vote</span>
                        </div>
                        <div class="toggle-switch" id="shareMilestonesToggleProfile" onclick="toggleSetting('shareMilestones')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="settings-dropdown-divider"></div>

                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>üîî Daily Reminders</span>
                            <span class="settings-dropdown-description">Get notified at 11 AM EST to vote</span>
                        </div>
                        <button class="enable-notifications-btn" id="enableNotificationsBtn" onclick="enableNotifications()">
                            Enable
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Now Live Banner -->
    <div id="nowLiveBanner" class="now-live-banner" style="display: none;">
        <div class="live-pulse"></div>
        <span class="live-text">üî¥ ZABAL IS LIVE NOW!</span>
        <button class="watch-now-btn" onclick="openLiveShareModal()">üì∫ Share Stream</button>
    </div>

    <!-- Personal Stats -->
    <section class="container" style="padding-top: 70px;">
        <div id="personalStats" class="personal-stats">
            <div class="stats-header">
                <span class="stats-title">üìä Your Stats</span>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="statTotalVotes">0</span>
                    <span class="stat-label">Total Votes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statStreak">0</span>
                    <span class="stat-label">Day Streak</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statFavoriteMode">‚Äî</span>
                    <span class="stat-label">Favorite Mode</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statVotePower">1x</span>
                    <span class="stat-label">Vote Power</span>
                </div>
            </div>
            
            <!-- Vote Power Breakdown -->
            <div id="votePowerBreakdown" style="margin-top: 20px; background: rgba(224, 221, 170, 0.05); border: 1px solid rgba(224, 221, 170, 0.2); border-radius: 12px;">
                <button onclick="toggleBreakdown()" style="width: 100%; padding: 12px 16px; background: transparent; border: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--accent-yellow); font-size: 0.85rem; font-weight: 600;">
                    <span>Vote Power Breakdown</span>
                    <span id="breakdownToggleIcon" style="transition: transform 0.3s ease;">‚ñº</span>
                </button>
                <div id="breakdownContent" style="display: none; padding: 0 16px 12px 16px;">
                <div style="display: grid; gap: 6px; font-size: 0.8rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary);">/zao Channel Posts:</span>
                        <span id="breakdownZaoPosts" style="color: var(--text-primary); font-weight: 600;">‚Äî</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary);">Neynar Score:</span>
                        <span id="breakdownNeynarScore" style="color: var(--text-primary); font-weight: 600;">‚Äî</span>
                    </div>
                    <div style="height: 1px; background: rgba(224, 221, 170, 0.2); margin: 8px 0;"></div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary);">Base Power:</span>
                        <span id="breakdownBasePower" style="color: var(--text-primary); font-weight: 600;">‚Äî</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary);">Quality Multiplier:</span>
                        <span id="breakdownMultiplier" style="color: var(--text-primary); font-weight: 600;">‚Äî</span>
                    </div>
                    <div style="height: 1px; background: rgba(224, 221, 170, 0.2); margin: 8px 0;"></div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--accent-yellow); font-weight: 600;">Final Power:</span>
                        <span id="breakdownFinalPower" style="color: var(--accent-yellow); font-weight: 700; font-size: 1.1rem;">‚Äî</span>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px; text-align: center; opacity: 0.8;" id="breakdownFormula">
                        Formula: Base √ó Multiplier = Final
                    </div>
                </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Live State Hero -->
    <section class="live-hero">
        <div class="hero-state deciding" id="heroState">Stream Being Decided</div>
        <h1 class="hero-title" id="heroTitle">Today's Stream Is Being Decided</h1>
        <p class="hero-subtitle" id="heroSubtitle">Show up early. Influence the outcome.</p>
        
        <div class="countdown" id="countdown">
            <span class="countdown-label">Voting ends in</span>
            <span class="countdown-time" id="countdownTime">2:34:12</span>
        </div>

    </section>

    <!-- Stream Wheel Section -->
    <section class="wheel-section" id="wheel">
        <div class="container">
            <div class="wheel-header">
                <h2>The stream isn't scheduled. It's decided.</h2>
                <p>Vote for today's mode. Leader locks at stream time.</p>
            </div>

            <div class="wheel-container">
                <!-- Studio Mode -->
                <div class="mode-card leading selectable-card" data-mode="studio" onclick="toggleModeSelection('studio')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="studio">
                    <div class="mode-icon">üé®</div>
                    <div class="mode-info">
                        <div class="mode-name">Studio Mode</div>
                        <div class="mode-description">We create live. Music, art, experiments.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="studio">42</span>
                        <span class="vote-label">Votes</span>
                        <div class="selection-indicator">‚úì Selected</div>
                    </div>
                </div>

                <!-- Market Mode -->
                <div class="mode-card selectable-card" data-mode="market" onclick="toggleModeSelection('market')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="market">
                    <div class="mode-icon">üìä</div>
                    <div class="mode-info">
                        <div class="mode-name">Market Mode</div>
                        <div class="mode-description">We analyze culture. Trends, tokens, movements.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="market">28</span>
                        <span class="vote-label">Votes</span>
                        <div class="selection-indicator">‚úì Selected</div>
                    </div>
                </div>

                <!-- Social Mode -->
                <div class="mode-card selectable-card" data-mode="social" onclick="toggleModeSelection('social')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="social">
                    <div class="mode-icon">üåê</div>
                    <div class="mode-info">
                        <div class="mode-name">Social Mode</div>
                        <div class="mode-description">We break algorithms. Farcaster, X, distribution.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="social">35</span>
                        <span class="vote-label">Votes</span>
                        <div class="selection-indicator">‚úì Selected</div>
                    </div>
                </div>

                <!-- Battle Mode -->
                <div class="mode-card selectable-card" data-mode="battle" onclick="toggleModeSelection('battle')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="battle">
                    <div class="mode-icon">‚öîÔ∏è</div>
                    <div class="mode-info">
                        <div class="mode-name">Battle Mode</div>
                        <div class="mode-description">We trade music live. WaveWarZ, submissions, discovery.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="battle">31</span>
                        <span class="vote-label">Votes</span>
                        <div class="selection-indicator">‚úì Selected</div>
                    </div>
                </div>
            </div>

            <!-- Submit Votes Button -->
            <div class="submit-votes-container">
                <button class="submit-votes-btn" id="submitVotesBtn" onclick="submitVotes()" disabled>
                    Submit Votes (<span id="selectedCount">0</span> selected)
                </button>
            </div>
        </div>
    </section>

    <!-- Live Share Modal -->
    <div id="liveShareModal" class="live-share-modal">
        <div class="live-share-content">
            <div class="live-share-header">
                <div class="live-share-title">üî¥ ZABAL IS LIVE!</div>
                <div class="live-share-subtitle">Watch and share the stream</div>
            </div>

            <div class="platform-links">
                <div class="platform-link-card">
                    <div class="platform-icon">üì∫</div>
                    <div class="platform-info">
                        <div class="platform-name">Twitch</div>
                        <div class="platform-url">twitch.tv/bettercallzaal</div>
                    </div>
                    <a href="https://twitch.tv/bettercallzaal" target="_blank" class="platform-btn">Watch</a>
                </div>

                <div class="platform-link-card">
                    <div class="platform-icon">üé¨</div>
                    <div class="platform-info">
                        <div class="platform-name">Retake.tv</div>
                        <div class="platform-url">retake.tv/zaal</div>
                    </div>
                    <a href="https://retake.tv/zaal" target="_blank" class="platform-btn">Watch</a>
                </div>
            </div>

            <div class="live-share-actions">
                <button class="share-live-btn" onclick="shareLiveStream()">
                    üü£ Share to Farcaster
                </button>
                <button class="close-live-modal-btn" onclick="closeLiveShareModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <div class="share-modal-title">üì¢ Share Your Vote</div>
                <div class="share-modal-subtitle">Spread the word and get more people voting!</div>
            </div>
            
            <div class="share-link-box">
                <div class="share-link-text">https://zabal.art</div>
                <button class="copy-link-btn" onclick="copyMiniappLink()">Copy Link</button>
            </div>
            
            <!-- Friend Tagging Section -->
            <div id="friendTagSection" class="friend-tag-section" style="display: none;">
                <div class="friend-tag-header">
                    üë• Tag Friends
                    <button class="reconnect-btn" onclick="showInactiveContacts()" title="Reach out to people you haven't talked to in a while">
                        üí§ Reconnect
                    </button>
                </div>
                <div id="friendTagList" class="friend-tag-list"></div>
            </div>

            <!-- Top Friend Invitation -->
            <div id="topFriendInvite" class="top-friend-invite" style="display: none;">
                <div class="invite-header">üí¨ Invite Your Top Friend</div>
                <div id="topFriendCard" class="top-friend-card"></div>
                <button class="invite-friend-btn" onclick="inviteTopFriend()">
                    üì® Invite to Vote
                </button>
            </div>
            
            <div class="share-buttons">
                <button class="share-action-btn share-farcaster-btn" onclick="shareVote(currentVotedModes)">
                    üü£ Share to Farcaster
                </button>
                <button class="share-action-btn challenge-friends-btn" onclick="challengeFriends()" style="display: none;">
                    ‚öîÔ∏è Challenge Friends
                </button>
                <button class="share-action-btn share-close-btn" onclick="closeShareModal()">
                    Close
                </button>
            </div>

            <!-- Share Settings -->
            <div class="settings-section">
                <div class="settings-title">‚öôÔ∏è Share Preferences</div>
                
                <div class="setting-item">
                    <div class="setting-label">
                        <span>Auto-share votes</span>
                        <span class="setting-description">Automatically share when you vote</span>
                    </div>
                    <div class="toggle-switch" id="autoShareToggle" onclick="toggleSetting('autoShare')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <span>Share only when leading</span>
                        <span class="setting-description">Only auto-share if your mode is winning</span>
                    </div>
                    <div class="toggle-switch" id="shareLeadingToggle" onclick="toggleSetting('shareLeading')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <span>Milestone celebrations</span>
                        <span class="setting-description">Share on 10th, 50th, 100th vote</span>
                    </div>
                    <div class="toggle-switch" id="shareMilestonesToggle" onclick="toggleSetting('shareMilestones')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today/Yesterday Section -->
    <section class="stream-history">
        <div class="container">
            <div class="history-grid">
                <div class="history-card">
                    <span class="history-label">Today</span>
                    <div class="history-mode" id="todayMode">Studio Mode</div>
                    <p class="history-description" id="todayDesc">Leading with 42 votes</p>
                    <a href="#wheel" class="history-link">
                        Change it ‚Üí
                    </a>
                </div>

                <div class="history-card">
                    <span class="history-label">Yesterday</span>
                    <div class="history-mode">Battle Mode</div>
                    <p class="history-description">Won with 38 votes</p>
                    <a href="https://twitch.tv/bettercallzaal/videos" target="_blank" class="history-link">
                        Watch replay ‚Üí
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Built on Stream Section -->
    <section class="artifacts-section">
        <div class="container">
            <div class="artifacts-header">
                <h2>Built on ZABAL Streams</h2>
                <p>This isn't content. It's coordination.</p>
            </div>

            <div class="artifacts-grid">
                <div class="artifact-card">
                    <div class="artifact-type">üéµ Song</div>
                    <div class="artifact-content">
                        <div class="artifact-title">Coming Soon</div>
                        <div class="artifact-meta">Created live ‚Ä¢ Studio Mode</div>
                        <a href="https://twitch.tv/bettercallzaal" target="_blank" class="artifact-link">Watch streams ‚Üí</a>
                    </div>
                </div>

                <div class="artifact-card">
                    <div class="artifact-type">üìä Decision</div>
                    <div class="artifact-content">
                        <div class="artifact-title">Stream Format</div>
                        <div class="artifact-meta">Decided by community ‚Ä¢ Market Mode</div>
                        <a href="#wheel" class="artifact-link">Vote now ‚Üí</a>
                    </div>
                </div>

                <div class="artifact-card">
                    <div class="artifact-type">‚úÇÔ∏è Clip</div>
                    <div class="artifact-content">
                        <div class="artifact-title">Best Moments</div>
                        <div class="artifact-meta">Highlights ‚Ä¢ All Modes</div>
                        <a href="https://twitch.tv/bettercallzaal/videos" target="_blank" class="artifact-link">Watch clips ‚Üí</a>
                    </div>
                </div>

                <div class="artifact-card">
                    <div class="artifact-type">üß™ Experiment</div>
                    <div class="artifact-content">
                        <div class="artifact-title">Live Coordination</div>
                        <div class="artifact-meta">Community driven ‚Ä¢ Battle Mode</div>
                        <a href="https://www.thezao.com/nexus" target="_blank" class="artifact-link">Visit ZAO Nexus ‚Üí</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Vote History Accordion -->
    <section class="vote-history-accordion-section">
        <div class="container">
            <div class="vote-history-accordion">
                <button class="accordion-header" onclick="toggleVoteHistory()">
                    <div class="accordion-title">
                        <span class="accordion-icon">üìä</span>
                        <div class="accordion-text">
                            <h3>Recent Voting Activity</h3>
                            <p>See who voted for what over the past week</p>
                        </div>
                    </div>
                    <div class="accordion-toggle">
                        <svg class="chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </button>
                <div class="accordion-content" id="voteHistoryAccordion">
                    <div class="accordion-inner">
                        <div id="voteHistoryTimeline" class="vote-history-timeline">
                            <div class="loading-votes">Loading vote history...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="https://zao.xyz" target="_blank">ZAO</a>
                <a href="https://zabal.xyz" target="_blank">ZABAL</a>
                <a href="https://wavewarz.xyz" target="_blank">WaveWarZ</a>
                <a href="https://bettercallzaal.com" target="_blank">BetterCallZaal</a>
            </div>
            <p class="footer-tagline">Built for the ZABAL network of creators.</p>
        </div>
    </footer>

    <script>
        // Stream State Management
        const StreamState = {
            DECIDING: 'deciding',
            LOCKED: 'locked',
            LIVE: 'live'
        };

        let currentState = StreamState.DECIDING;
        
        // Helper: Get current date in EST timezone
        function getESTDate() {
            const now = new Date();
            // Convert to EST (UTC-5)
            const estOffset = -5 * 60; // EST offset in minutes
            return new Date(now.getTime() + (now.getTimezoneOffset() + estOffset) * 60000);
        }
        
        // Helper: Get vote date string (resets at 5 PM EST)
        function getVoteDate() {
            const estNow = getESTDate();
            
            // If before 5 PM EST, use previous day's date
            if (estNow.getHours() < 17) {
                estNow.setDate(estNow.getDate() - 1);
            }
            
            return estNow.toISOString().split('T')[0];
        }
        
        // Calculate lock time: Today at 5 PM EST (resets daily)
        function calculateLockTime() {
            const estNow = getESTDate();
            const now = new Date();
            
            // Set to today 5 PM EST
            const lockTimeEST = new Date(estNow);
            lockTimeEST.setHours(17, 0, 0, 0);
            
            // If already past 5 PM EST today, set to tomorrow 5 PM EST
            if (estNow.getHours() >= 17) {
                lockTimeEST.setDate(lockTimeEST.getDate() + 1);
            }
            
            // Convert back to local time
            const estOffset = -5 * 60;
            return new Date(lockTimeEST.getTime() - (now.getTimezoneOffset() + estOffset) * 60000);
        }
        
        let lockTime = calculateLockTime();

        // Update hero based on state
        function updateHeroState() {
            const heroState = document.getElementById('heroState');
            const heroTitle = document.getElementById('heroTitle');
            const heroSubtitle = document.getElementById('heroSubtitle');
            const heroCTA = document.getElementById('heroCTA');
            const countdown = document.getElementById('countdown');

            if (currentState === StreamState.DECIDING) {
                heroState.textContent = 'Voting Open';
                heroState.className = 'hero-state deciding';
                heroTitle.textContent = "Vote for Today's Stream";
                heroSubtitle.textContent = "Voting closes at 5 PM EST when Zaal gets home.";
                // CTA removed
                countdown.style.display = 'inline-flex';
            } else if (currentState === StreamState.LOCKED) {
                heroState.textContent = 'Voting Closed';
                heroState.className = 'hero-state locked';
                const leader = getLeader();
                const modeName = document.querySelector(`[data-mode="${leader}"] .mode-name`).textContent;
                heroTitle.textContent = `Winner: ${modeName}`;
                heroSubtitle.textContent = `The community chose ${modeName}. Results locked at 5 PM EST.`;
                heroCTA.textContent = 'See Results';
                heroCTA.href = '#wheel';
                countdown.style.display = 'inline-flex';
            } else if (currentState === StreamState.LIVE) {
                heroState.textContent = 'üî¥ Live Now';
                heroState.className = 'hero-state live';
                const leader = getLeader();
                const modeName = document.querySelector(`[data-mode="${leader}"] .mode-name`).textContent;
                heroTitle.textContent = `${modeName} ‚Äî Live`;
                heroSubtitle.textContent = "Join the stream. Watch us build.";
                heroCTA.textContent = 'Join Stream';
                heroCTA.href = 'https://twitch.tv/bettercallzaal';
                heroCTA.target = '_blank';
                countdown.style.display = 'none';
            }
        }

        // Countdown timer
        function updateCountdown() {
            const now = new Date();
            const diff = lockTime - now;

            if (diff <= 0) {
                currentState = StreamState.LOCKED;
                updateHeroState();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const countdownTime = document.getElementById('countdownTime');
            countdownTime.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Toast Notification System
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: 'üí°'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'üí°'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Initialize Supabase using config
        console.log('üé™ ZABAL Live Hub - Initializing Supabase...');
        
        let supabase;
        try {
            if (!window.supabase) {
                console.error('‚ùå Supabase library not loaded');
                showToast('error', 'Database Error', 'Connection failed. Please refresh the page.');
            } else if (!window.appConfig) {
                console.error('‚ùå App configuration not loaded');
                showToast('error', 'Configuration Error', 'App not configured. Please refresh the page.');
            } else {
                supabase = window.supabase.createClient(
                    window.appConfig.SUPABASE_URL,
                    window.appConfig.SUPABASE_ANON_KEY
                );
                console.log('‚úÖ Supabase client initialized');
            }
        } catch (err) {
            console.error('‚ùå Error initializing Supabase:', err);
            window.errorHandler?.handleError(err, { type: 'database_error', context: 'initialization' });
            showToast('error', 'Database Error', 'Could not connect to database.');
        }

        // Get Farcaster user context
        let userFID = null;
        let username = null;
        let isAuthenticated = false;
        let userVotePower = 1; // Cache user's vote power

        async function initializeFarcaster() {
            console.log('üîê Initializing Farcaster authentication...');
            
            // Wait for SDK to load (max 3 seconds)
            let sdkReady = false;
            for (let i = 0; i < 30; i++) {
                if (window.farcasterSDK && window.farcasterSDK.actions) {
                    sdkReady = true;
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            try {
                if (sdkReady && window.farcasterSDK) {
                    const context = await window.farcasterSDK.context;
                    
                    if (context && context.user) {
                        userFID = context.user.fid;
                        username = context.user.username;
                        isAuthenticated = true;
                        
                        console.log('‚úÖ Farcaster user authenticated:', { fid: userFID, username, user: context.user });
                        
                        // Show enhanced user profile in header
                        const userProfileEl = document.getElementById('userProfile');
                        const userNameEl = document.getElementById('userName');
                        const userPfpEl = document.getElementById('userPfp');
                        const userFidEl = document.getElementById('userFidDisplay');
                        const verifiedBadgeEl = document.getElementById('verifiedBadge');
                        
                        if (userProfileEl && userNameEl) {
                            userNameEl.textContent = `@${username}`;
                            userFidEl.textContent = `FID: ${userFID}`;
                            
                            // Set profile picture if available
                            if (context.user.pfpUrl) {
                                userPfpEl.src = context.user.pfpUrl;
                                userPfpEl.style.display = 'block';
                            }
                            
                            // Show verification badge if user has it
                            if (context.user.verified || context.user.verifications?.length > 0) {
                                verifiedBadgeEl.style.display = 'inline';
                            }
                            
                            userProfileEl.style.display = 'flex';
                        }
                        
                        // Show personal stats and load user data
                        loadPersonalStats();
                        
                        // Load best friends data
                        loadBestFriends(userFID);
                    } else {
                        console.warn('‚ö†Ô∏è No Farcaster user context found');
                        throw new Error('Not in Farcaster context');
                    }
                    
                    // CRITICAL: Always call ready() to hide splash screen
                    await window.farcasterSDK.actions.ready();
                    console.log('‚úÖ Splash screen hidden, app ready');
                } else {
                    console.warn('‚ö†Ô∏è Farcaster SDK not loaded after 3s timeout');
                    throw new Error('Farcaster SDK not available');
                }
            } catch (err) {
                console.log('‚ÑπÔ∏è Not running in Farcaster, using fallback FID');
                // Fallback for testing outside Farcaster
                userFID = localStorage.getItem('userFID') || Math.floor(Math.random() * 1000000);
                localStorage.setItem('userFID', userFID);
                username = 'Test User';
                isAuthenticated = false;
                
                // Try to call ready() even in fallback mode
                try {
                    if (window.farcasterSDK && window.farcasterSDK.actions) {
                        await window.farcasterSDK.actions.ready();
                        console.log('‚úÖ Splash screen hidden (fallback mode)');
                    } else {
                        console.log('‚ö†Ô∏è SDK not available, manually hiding splash screen');
                        // Manually hide splash screen when testing outside Farcaster
                        const splashScreen = document.querySelector('.fc-splash-screen');
                        if (splashScreen) {
                            splashScreen.style.display = 'none';
                        }
                        document.body.style.overflow = 'auto';
                    }
                } catch (readyErr) {
                    console.log('‚ÑπÔ∏è Could not call ready() in fallback mode:', readyErr);
                    // Manually hide splash screen on error
                    const splashScreen = document.querySelector('.fc-splash-screen');
                    if (splashScreen) {
                        splashScreen.style.display = 'none';
                    }
                    document.body.style.overflow = 'auto';
                }
            }
            
            console.log('üë§ User FID:', userFID, '| Username:', username, '| Authenticated:', isAuthenticated);
        }
        
        let userVote = null;
        const votes = {
            studio: 0,
            market: 0,
            social: 0,
            battle: 0
        };

        // Cache for user data to avoid repeated API calls
        const userDataCache = {};

        // Fetch user data from Neynar
        async function fetchUserData(fids) {
            if (!fids || fids.length === 0) return {};
            
            // Filter out already cached FIDs
            const uncachedFids = fids.filter(fid => !userDataCache[fid]);
            
            if (uncachedFids.length === 0) {
                return userDataCache;
            }
            
            try {
                const fidsParam = uncachedFids.join(',');
                const data = await callNeynarAPI('user/bulk', { fids: fidsParam });
                
                if (data.users) {
                    data.users.forEach(user => {
                        userDataCache[user.fid] = {
                            username: user.username,
                            display_name: user.display_name,
                            pfp_url: user.pfp_url
                        };
                    });
                }
            } catch (error) {
                console.error('‚ùå Error fetching user data:', error);
            }
            
            return userDataCache;
        }

        // Load vote history for past 7 days
        async function loadVoteHistory() {
            console.log('üìú Loading vote history...');
            
            if (!supabase) {
                console.warn('‚ö†Ô∏è Supabase not initialized');
                return;
            }
            
            try {
                // Get votes from past 7 days
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const { data: votes, error } = await supabase
                    .from('votes')
                    .select('fid, username, mode, vote_power, vote_date')
                    .gte('vote_date', sevenDaysAgo.toISOString().split('T')[0])
                    .order('vote_date', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error loading vote history:', error);
                    return;
                }
                
                console.log('üì• Vote history loaded:', votes);
                
                // Get unique FIDs
                const uniqueFids = [...new Set(votes.map(v => v.fid))];
                
                // Fetch user data for all voters
                await fetchUserData(uniqueFids);
                
                displayVoteHistory(votes);
                
            } catch (err) {
                console.error('‚ùå Exception loading vote history:', err);
            }
        }

        // Display vote history timeline
        function displayVoteHistory(votes) {
            const timeline = document.getElementById('voteHistoryTimeline');
            if (!timeline) return;
            
            if (!votes || votes.length === 0) {
                timeline.innerHTML = '<div class="no-history">No voting history yet. Be the first to vote!</div>';
                return;
            }
            
            // Group votes by date
            const votesByDate = {};
            votes.forEach(vote => {
                const date = vote.vote_date;
                if (!votesByDate[date]) {
                    votesByDate[date] = [];
                }
                votesByDate[date].push(vote);
            });
            
            const modeEmojis = {
                studio: 'üé¨',
                market: 'üõí',
                social: 'üåê',
                battle: '‚öîÔ∏è'
            };
            
            const modeNames = {
                studio: 'Studio',
                market: 'Market',
                social: 'Social',
                battle: 'Battle'
            };
            
            // Build timeline HTML
            let html = '';
            Object.keys(votesByDate).sort().reverse().forEach(date => {
                const dayVotes = votesByDate[date];
                
                // Calculate totals per mode
                const modeTotals = {
                    studio: 0,
                    market: 0,
                    social: 0,
                    battle: 0
                };
                
                dayVotes.forEach(vote => {
                    modeTotals[vote.mode] += vote.vote_power || 1;
                });
                
                // Find winner
                const winner = Object.keys(modeTotals).reduce((a, b) => 
                    modeTotals[a] > modeTotals[b] ? a : b
                );
                
                // Format date
                const dateObj = new Date(date + 'T00:00:00');
                const isToday = dateObj.toDateString() === new Date().toDateString();
                const isYesterday = dateObj.toDateString() === new Date(Date.now() - 86400000).toDateString();
                
                let dateLabel = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                if (isToday) dateLabel = 'üî¥ Today - ' + dateLabel;
                else if (isYesterday) dateLabel = 'Yesterday - ' + dateLabel;
                
                html += `
                    <div class="vote-day-card">
                        <div class="vote-day-header">
                            <div class="vote-day-date">${dateLabel}</div>
                            <div class="vote-day-winner">
                                <span>Winner:</span>
                                <span class="winner-badge">${modeEmojis[winner]} ${modeNames[winner]}</span>
                            </div>
                        </div>
                        
                        <div class="vote-day-stats">
                            ${Object.keys(modeTotals).map(mode => `
                                <div class="mode-stat">
                                    <div class="mode-stat-icon">${modeEmojis[mode]}</div>
                                    <div class="mode-stat-info">
                                        <div class="mode-stat-name">${modeNames[mode]}</div>
                                        <div class="mode-stat-votes">${modeTotals[mode]} vote${modeTotals[mode] !== 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="vote-day-voters">
                            <div class="voters-header">${[...new Map(dayVotes.map(vote => [vote.fid, vote])).values()].length} voters</div>
                            <div class="voters-list">
                                ${[...new Map(dayVotes.map(vote => [vote.fid, vote])).values()].map(vote => {
                                    const userData = userDataCache[vote.fid];
                                    const username = userData?.username || vote.username || `fid:${vote.fid}`;
                                    const pfpUrl = userData?.pfp_url || '';
                                    const warpcastUrl = `https://warpcast.com/${username.replace('fid:', '')}`;
                                    
                                    // Get all modes this user voted for on this day
                                    const userVotes = dayVotes.filter(v => v.fid === vote.fid);
                                    const modes = [...new Set(userVotes.map(v => v.mode))];
                                    
                                    return `
                                        <a href="${warpcastUrl}" target="_blank" class="voter-tag">
                                            ${pfpUrl ? `<img src="${pfpUrl}" class="voter-pfp" alt="${username}">` : ''}
                                            <span class="voter-mode-icon">${modes.map(m => modeEmojis[m]).join('')}</span>
                                            <span class="voter-username">@${username}</span>
                                        </a>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            timeline.innerHTML = html;
        }

        // Load votes from database
        async function loadVotes() {
            console.log('üìä Loading votes from database...');
            
            if (!supabase) {
                console.warn('‚ö†Ô∏è Supabase not initialized, skipping vote load');
                return;
            }
            
            try {
                // Get today's vote totals
                const { data, error } = await supabase
                    .rpc('get_todays_votes');
                
                if (error) {
                    console.error('‚ùå Error loading votes:', error);
                    return;
                }
                
                console.log('üì• Received vote data:', data);
                
                // Reset votes
                votes.studio = 0;
                votes.market = 0;
                votes.social = 0;
                votes.battle = 0;
                
                // Update with database values
                if (data) {
                    data.forEach(row => {
                        votes[row.mode] = parseInt(row.total_votes) || 0;
                    });
                }
                
                console.log('‚úÖ Votes loaded:', votes);
                
                // Check if user has voted today
                const { data: userVoteData, error: voteError } = await supabase
                    .rpc('has_voted_today', { user_fid: parseInt(userFID) });
                
                if (voteError) {
                    console.error('‚ùå Error checking user vote:', voteError);
                } else if (userVoteData && userVoteData.length > 0) {
                    const result = userVoteData[0];
                    if (result.has_voted) {
                        userVote = result.voted_mode;
                        console.log('‚úÖ User has already voted for:', userVote);
                    }
                }
                
                updateVotes();
                updateLeader();
                
            } catch (err) {
                console.error('‚ùå Exception loading votes:', err);
            }
        }

        // Vote function with database - exposed to global scope for onclick handlers
        // skipModal parameter prevents opening share modal (used when called from submitVotes)
        window.vote = async function(mode, skipModal = false) {
            console.log('üó≥Ô∏è Vote button clicked for mode:', mode);
            
            // Validate input
            try {
                mode = window.Validator.validateMode(mode);
            } catch (error) {
                console.error('‚ùå Invalid mode:', error.message);
                showToast('error', 'Invalid Vote', error.message);
                window.errorHandler?.handleError(error, { type: 'validation_error', context: 'vote' });
                return;
            }
            
            
            if (!isAuthenticated) {
                console.error('‚ùå Not authenticated');
                showToast('error', 'Authentication Required', 'Please open in Farcaster to vote');
                window.analytics?.trackUserAction('vote_failed', { reason: 'not_authenticated', mode });
                return;
            }
            
            if (!supabase) {
                console.error('‚ùå Supabase not initialized');
                showToast('error', 'Database Error', 'Database not connected. Please refresh the page.');
                window.analytics?.trackUserAction('vote_failed', { reason: 'no_supabase', mode });
                return;
            }
            
            if (currentState !== StreamState.DECIDING) {
                console.warn('‚ö†Ô∏è Voting blocked - state is not DECIDING');
                showToast('info', 'Voting Closed', 'Stream is currently locked or live.');
                window.analytics?.trackUserAction('vote_failed', { reason: 'voting_closed', mode });
                return;
            }

            console.log('‚úÖ Voting allowed - state is DECIDING');
            
            // Show loading state
            window.loadingManager?.show('vote', 'Submitting your vote...');
            
            try {
                // Validate FID before database operation
                const validatedFID = window.Validator.validateFID(userFID);
                
                // Delete any existing vote for this specific mode today
                console.log('üóëÔ∏è Checking for existing vote to delete for mode:', mode);
                const { data: deleteData, error: deleteError } = await supabase
                    .from('votes')
                    .delete()
                    .eq('fid', validatedFID)
                    .eq('mode', mode)
                    .eq('vote_date', getVoteDate())
                    .select();
                
                if (deleteError) {
                    console.error('‚ùå Error deleting old vote:', deleteError);
                } else if (deleteData && deleteData.length > 0) {
                    console.log('‚úÖ Deleted old vote:', deleteData);
                } else {
                    console.log('‚ÑπÔ∏è No existing vote to delete (first vote today)');
                }
                
                // Calculate vote power for this user
                const votePowerData = await calculateVotePower(validatedFID);
                const votePower = votePowerData.power;
                
                console.log('‚ûï Inserting new vote:', { fid: validatedFID, mode, vote_power: votePower });
                const { data, error } = await supabase
                    .from('votes')
                    .insert([
                        {
                            fid: validatedFID,
                            mode: mode,
                            vote_power: votePower,
                            source: 'web'
                        }
                    ])
                    .select();
                
                if (error) {
                    console.error('‚ùå Error voting:', error);
                    console.error('‚ùå Error details:', JSON.stringify(error, null, 2));
                    showToast('error', 'Vote Failed', 'Could not record your vote. Please try again.');
                    window.analytics?.trackError(error, { context: 'vote', mode });
                    return;
                }
                
                console.log('‚úÖ Vote recorded:', data);
                
                userVote = mode;
                console.log('üíæ User vote saved:', mode);
                
                // Track vote in analytics
                window.analytics?.trackVote(mode);
                
                // Save to vote history
                window.dataPersistence?.saveVoteHistory(mode);
                
                // Show vote confirmation animation
                // Hide loading state
                window.loadingManager?.hide('vote');
                
                // Only open share modal if not skipped (i.e., not called from submitVotes)
                if (!skipModal) {
                    // Check if should auto-share
                    if (shouldAutoShare(mode)) {
                        console.log('üîÑ Auto-sharing vote...');
                        setTimeout(() => shareVote(mode, true), 1000);
                    } else {
                        // Open share modal directly after vote
                        setTimeout(() => openShareModal(mode), 500);
                    }
                }
                
                // Only reload votes if not in batch mode (submitVotes will reload once at the end)
                if (!skipModal) {
                    await loadVotes();
                    console.log('‚úÖ Vote complete and counts updated!');
                    
                    // Force update the UI
                    updateVotes();
                    updateLeader();
                }
                
                // Share modal will open from above logic
                
            } catch (err) {
                console.error('‚ùå Error in vote function:', err);
                
                // Hide loading state
                window.loadingManager?.hide('vote');
                
                // Track error
                window.analytics?.trackError(err, { context: 'vote', mode });
                
                showToast('error', 'Vote Failed', 'An error occurred. Please try again.');
            }
        }

        // Share modal functions
        let currentShareMode = null;
        let currentVotedModes = []; // Store all voted modes for sharing
        const MINIAPP_URL = window.appConfig?.MINIAPP_URL || 'https://zabal.art';
        const SONGJAM_URL = window.appConfig?.SONGJAM_URL || 'https://www.songjam.space/zabal';
        
        async function callNeynarAPI(endpoint, params = {}) {
            // Try serverless function first
            try {
                const queryString = new URLSearchParams({ endpoint, ...params }).toString();
                const response = await fetch(`/api/neynar?${queryString}`);
                if (response.ok) {
                    return response.json();
                }
                console.warn('‚ö†Ô∏è Serverless function failed, using fallback');
            } catch (error) {
                console.warn('‚ö†Ô∏è Serverless function not available, using fallback');
            }
            
            // Fallback to direct API call
            const queryString = new URLSearchParams(params).toString();
            const url = `https://api.neynar.com/v2/farcaster/${endpoint}${queryString ? '?' + queryString : ''}`;
            const response = await fetch(url, {
                headers: {
                    'api_key': window.appConfig?.NEYNAR_API_KEY || '',
                    'accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Neynar API error: ${response.status}`);
            }
            return response.json();
        }
        
        // Friend data
        let topFriend = null;
        let bestFriends = [];

        // Get time until next Monday 5 PM EST
        function getTimeUntilZabalUpdate() {
            const now = new Date();
            
            // Convert to EST (UTC-5)
            const estOffset = -5 * 60; // EST offset in minutes
            const nowEST = new Date(now.getTime() + (now.getTimezoneOffset() + estOffset) * 60000);
            
            // Get next Monday 5 PM EST
            const nextMonday = new Date(nowEST);
            const daysUntilMonday = (1 - nowEST.getDay() + 7) % 7 || 7; // Days until next Monday
            nextMonday.setDate(nowEST.getDate() + daysUntilMonday);
            nextMonday.setHours(17, 0, 0, 0); // 5 PM
            
            // If it's already past Monday 5 PM this week, go to next week
            if (nowEST.getDay() === 1 && nowEST.getHours() >= 17) {
                nextMonday.setDate(nextMonday.getDate() + 7);
            }
            
            const diff = nextMonday - nowEST;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}d ${hours}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        // Fetch user's /zao channel casts count
        async function getZaoChannelCasts(fid) {
            try {
                console.log('üìä Fetching /zao channel casts for FID:', fid);
                const response = await fetch(
                    `https://api.neynar.com/v2/farcaster/feed/user/casts?fid=${fid}&limit=100`,
                    {
                        headers: {
                            'api_key': window.appConfig.NEYNAR_API_KEY,
                            'accept': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    console.error('‚ùå Neynar API error:', response.status);
                    return 0;
                }
                
                const data = await response.json();
                
                // Filter for casts in /zao channel
                const zaoCasts = data.casts?.filter(cast => 
                    cast.channel?.id === 'zao' || cast.parent_url?.includes('/zao')
                ) || [];
                
                console.log('‚úÖ Found', zaoCasts.length, '/zao channel casts');
                return zaoCasts.length;
            } catch (error) {
                console.error('‚ùå Error fetching /zao casts:', error);
                return 0;
            }
        }
        
        // Fetch Neynar user score
        async function getNeynarScore(fid) {
            try {
                console.log('üìä Fetching Neynar score for FID:', fid);
                const response = await fetch(
                    `https://api.neynar.com/v2/farcaster/user/bulk?fids=${fid}`,
                    {
                        headers: {
                            'api_key': window.appConfig.NEYNAR_API_KEY,
                            'accept': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    console.error('‚ùå Neynar API error:', response.status);
                    return 0.5; // Default middle score
                }
                
                const data = await response.json();
                const score = data.users?.[0]?.experimental?.neynar_user_score || 0.5;
                
                console.log('‚úÖ Neynar score:', score);
                return score;
            } catch (error) {
                console.error('‚ùå Error fetching Neynar score:', error);
                return 0.5; // Default on error
            }
        }
        
        // Calculate vote power based on /zao activity and Neynar score
        async function calculateVotePower(fid) {
            try {
                console.log('üéØ Calculating vote power for FID:', fid);
                
                // Base power
                let power = 1;
                
                // Get /zao channel activity
                const zaoCasts = await getZaoChannelCasts(fid);
                
                // Tiered bonuses based on /zao posts
                if (zaoCasts >= 50) {
                    power += 3; // Super active: 4x base
                    console.log('üî• Super Active: +3 (50+ /zao posts)');
                } else if (zaoCasts >= 20) {
                    power += 2; // Very active: 3x base
                    console.log('‚≠ê Very Active: +2 (20+ /zao posts)');
                } else if (zaoCasts >= 5) {
                    power += 1; // Active: 2x base
                    console.log('‚ú® Active: +1 (5+ /zao posts)');
                } else {
                    console.log('üë§ Member: base power (0-4 /zao posts)');
                }
                
                // Get Neynar score for quality multiplier
                const neynarScore = await getNeynarScore(fid);
                
                // Apply Neynar score multiplier
                let multiplier = 1.0;
                if (neynarScore >= 0.9) {
                    multiplier = 1.5; // 50% bonus for top-tier users
                    console.log('üíé Elite Quality: 1.5x multiplier (Neynar 0.9+)');
                } else if (neynarScore >= 0.7) {
                    multiplier = 1.25; // 25% bonus for quality users
                    console.log('‚≠ê Quality User: 1.25x multiplier (Neynar 0.7+)');
                } else if (neynarScore < 0.5) {
                    multiplier = 0.5; // Penalty for low-quality/spam accounts
                    console.log('‚ö†Ô∏è Low Quality: 0.5x multiplier (Neynar <0.5)');
                }
                
                // Calculate final power (round to 1 decimal)
                const finalPower = Math.round(power * multiplier);
                
                // Cap at 6x
                const cappedPower = Math.min(finalPower, 6);
                
                console.log('‚úÖ Final vote power:', cappedPower, '(base:', power, 'x multiplier:', multiplier + ')');
                
                return {
                    power: cappedPower,
                    zaoCasts: zaoCasts,
                    neynarScore: neynarScore,
                    multiplier: multiplier
                };
            } catch (error) {
                console.error('‚ùå Error calculating vote power:', error);
                return { power: 1, zaoCasts: 0, neynarScore: 0.5, multiplier: 1.0 };
            }
        }
        
        // Update vote power display
        function updateVotePowerDisplay(powerData) {
            const powerEl = document.getElementById('statVotePower');
            const detailEl = document.getElementById('statVotePowerDetail');
            
            if (powerEl) {
                powerEl.textContent = `${powerData.power}x`;
            }
            
            if (detailEl) {
                let badge = '';
                if (powerData.zaoCasts >= 50) badge = 'Super Active';
                else if (powerData.zaoCasts >= 20) badge = 'Very Active';
                else if (powerData.zaoCasts >= 5) badge = 'Active';
                else badge = 'Member';
                
                let qualityBadge = '';
                if (powerData.neynarScore >= 0.9) qualityBadge = ' ‚Ä¢ Elite';
                else if (powerData.neynarScore >= 0.7) qualityBadge = ' ‚Ä¢ Quality';
                
                detailEl.innerHTML = `${badge}${qualityBadge}<br>${powerData.zaoCasts} /zao posts`;
            }
            
            // Update breakdown section
            const breakdownSection = document.getElementById('votePowerBreakdown');
            console.log('üîç Breakdown section found:', breakdownSection ? 'YES' : 'NO');
            if (breakdownSection) {
                // Update breakdown values
                document.getElementById('breakdownZaoPosts').textContent = powerData.zaoCasts;
                document.getElementById('breakdownNeynarScore').textContent = powerData.neynarScore.toFixed(2);
                
                // Calculate base power from zaoCasts
                let basePower = 1;
                if (powerData.zaoCasts >= 50) basePower = 4;
                else if (powerData.zaoCasts >= 20) basePower = 3;
                else if (powerData.zaoCasts >= 5) basePower = 2;
                
                document.getElementById('breakdownBasePower').textContent = `${basePower}x`;
                document.getElementById('breakdownMultiplier').textContent = `${powerData.multiplier}x`;
                document.getElementById('breakdownFinalPower').textContent = `${powerData.power}x`;
                document.getElementById('breakdownFormula').textContent = `${basePower} √ó ${powerData.multiplier} = ${powerData.power}`;
                
                console.log('‚úÖ Breakdown updated:', { zaoCasts: powerData.zaoCasts, neynarScore: powerData.neynarScore, basePower, multiplier: powerData.multiplier, finalPower: powerData.power });
            } else {
                console.error('‚ùå Breakdown section not found in DOM!');
            }
        }
        
        // Live stream status
        let isLive = false;
        
        // Check if stream is live (you can integrate with Twitch API later)
        function checkLiveStatus() {
            // For now, manually controlled
            // TODO: Integrate with Twitch API to auto-detect live status
            const liveStatus = localStorage.getItem('zabalLiveStatus');
            if (liveStatus === 'live') {
                showLiveBanner();
            }
        }
        
        function showLiveBanner() {
            const banner = document.getElementById('nowLiveBanner');
            if (banner) {
                banner.style.display = 'flex';
                isLive = true;
            }
        }
        
        function hideLiveBanner() {
            const banner = document.getElementById('nowLiveBanner');
            if (banner) {
                banner.style.display = 'none';
                isLive = false;
            }
        }
        
        // Open live share modal
        window.openLiveShareModal = function() {
            const modal = document.getElementById('liveShareModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        // Close live share modal
        window.closeLiveShareModal = function() {
            const modal = document.getElementById('liveShareModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // Share live stream to Farcaster
        window.shareLiveStream = async function() {
            const shareText = `üî¥ ZABAL IS LIVE NOW! üé®\n\nJoin the stream and watch us create in real-time!\n\nüì∫ Twitch: twitch.tv/bettercallzaal\nüé¨ Retake: retake.tv/zaal\n\nCome hang! üëá`;
            
            // Add friend tags if available
            let friendTags = '';
            if (bestFriends.length > 0) {
                const friendsToTag = bestFriends.slice(0, 3).map(f => f.username);
                friendTags = '\n\n' + friendsToTag.map(u => `@${u}`).join(' ') + ' join me!';
            }
            
            const fullText = shareText + friendTags;
            
            try {
                await window.farcasterSDK.actions.composeCast({
                    text: fullText,
                    embeds: ['https://twitch.tv/bettercallzaal'],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ Live stream shared to Farcaster');
                showShareSuccess();
                setTimeout(() => closeLiveShareModal(), 1500);
            } catch (error) {
                console.error('‚ùå Failed to share live stream:', error);
                showToast('error', 'Share Failed', 'Could not share stream. Please try again.');
            }
        }
        
        window.openShareModal = function(votedModes) {
            // Handle both single mode (string) and multiple modes (array)
            const modesArray = Array.isArray(votedModes) ? votedModes : [votedModes];
            
            // Store all voted modes for sharing
            currentVotedModes = modesArray;
            currentShareMode = modesArray[0]; // Keep for backwards compatibility
            
            console.log('üì§ Opening share modal with modes:', currentVotedModes);
            
            const modal = document.getElementById('shareModal');
            modal.classList.add('active');
            
            console.log('üîç Opening share modal');
            console.log('üë• Best friends count:', bestFriends.length);
            console.log('üëë Top friend:', topFriend);
            console.log('üîê Authenticated:', isAuthenticated);
            
            // Show friend tagging if we have friends
            if (bestFriends.length > 0) {
                console.log('‚úÖ Displaying friend tags');
                displayFriendTags();
            } else {
                console.warn('‚ö†Ô∏è No friends to display');
            }
            
            // Show top friend invitation
            if (topFriend) {
                console.log('‚úÖ Displaying top friend invite');
                displayTopFriendInvite();
            } else {
                console.warn('‚ö†Ô∏è No top friend to display');
            }
            
            // Show challenge button if authenticated
            if (isAuthenticated && bestFriends.length > 0) {
                console.log('‚úÖ Showing challenge button');
                document.querySelector('.challenge-friends-btn').style.display = 'block';
            }
        }
        
        window.closeShareModal = function() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        window.copyMiniappLink = function() {
            navigator.clipboard.writeText(MINIAPP_URL).then(() => {
                const btn = document.querySelector('.copy-link-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
        
        // Share preferences stored in localStorage
        const sharePreferences = {
            autoShare: false,
            shareLeading: false,
            shareMilestones: true
        };

        // Update toggle UI
        function updateToggleUI() {
            const toggles = {
                autoShare: [
                    document.getElementById('autoShareToggle'),
                    document.getElementById('autoShareToggleProfile')
                ],
                shareLeading: [
                    document.getElementById('shareLeadingToggle'),
                    document.getElementById('shareLeadingToggleProfile')
                ],
                shareMilestones: [
                    document.getElementById('shareMilestonesToggle'),
                    document.getElementById('shareMilestonesToggleProfile')
                ]
            };

            Object.keys(toggles).forEach(key => {
                toggles[key].forEach(toggle => {
                    if (toggle) {
                        if (sharePreferences[key]) {
                            toggle.classList.add('active');
                        } else {
                            toggle.classList.remove('active');
                        }
                    }
                });
            });
        }

        // Toggle settings dropdown
        window.toggleSettingsDropdown = function() {
            const dropdown = document.getElementById('settingsDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('settingsDropdown');
            const profileBadge = document.getElementById('userProfile');
            if (dropdown && !profileBadge?.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Load preferences from localStorage
        function loadSharePreferences() {
            const saved = localStorage.getItem('sharePreferences');
            if (saved) {
                Object.assign(sharePreferences, JSON.parse(saved));
            }
            updateToggleUI();
        }

        // Save preferences to localStorage
        function saveSharePreferences() {
            localStorage.setItem('sharePreferences', JSON.stringify(sharePreferences));
        }

        // Toggle setting
        window.toggleSetting = function(setting) {
            sharePreferences[setting] = !sharePreferences[setting];
            saveSharePreferences();
            updateToggleUI();
            console.log('üìù Share preference updated:', setting, sharePreferences[setting]);
        }

        // Check if should auto-share based on preferences
        function shouldAutoShare(mode) {
            if (!sharePreferences.autoShare) return false;
            if (sharePreferences.shareLeading) {
                const leader = getLeader();
                return mode === leader;
            }
            return true;
        }

        // Check for milestone and share if enabled
        function checkMilestone(totalVotes) {
            if (!sharePreferences.shareMilestones) return false;
            const milestones = [10, 25, 50, 100, 250, 500];
            return milestones.includes(totalVotes);
        }

        // Load best friends from Neynar
        async function loadBestFriends(fid) {
            if (!fid) {
                console.warn('‚ö†Ô∏è No FID provided to loadBestFriends');
                return;
            }
            
            console.log('üì° Loading best friends for FID:', fid);
            
            try {
                // Load inactive contacts in parallel
                loadInactiveContacts();
                
                const data = await callNeynarAPI('user/best_friends', { fid, limit: 50 });
                
                console.log('üì• Neynar response:', data);
                console.log('üì• Response structure:', JSON.stringify(data, null, 2));
                
                // Try different possible response structures
                const friendsList = data.result?.users || data.users || data || [];
                
                if (friendsList.length > 0) {
                    // Get FIDs from best friends list
                    const friendFids = friendsList.map(f => f.fid).join(',');
                    
                    // Fetch full user data to get profile pictures
                    const userData = await callNeynarAPI('user/bulk', { fids: friendFids });
                    
                    // Map full user data
                    bestFriends = userData.users || [];
                    topFriend = bestFriends[0];
                    
                    console.log('‚úÖ Loaded best friends:', bestFriends.length);
                    console.log('üëë Top friend:', topFriend.username);
                    console.log('üë• All friends:', bestFriends.map(f => f.username));
                } else {
                    console.warn('‚ö†Ô∏è No best friends returned from API');
                    console.warn('‚ö†Ô∏è Trying alternative: loading user followers instead');
                    
                    // Fallback: Try to get user's followers as friends
                    try {
                        const followersData = await callNeynarAPI('user/bulk', { fids: fid });
                        console.log('üì• Followers fallback response:', followersData);
                        
                        // For now, create a mock friend list so UI still works
                        // This allows testing the UI even without best friends data
                        bestFriends = [];
                        topFriend = null;
                        console.log('‚ÑπÔ∏è Friend tagging will be hidden until best friends data is available');
                    } catch (fallbackError) {
                        console.error('‚ùå Fallback also failed:', fallbackError);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading best friends:', error);
                console.error('Error details:', error.message);
            }
        }

        // Display friend tags in share modal
        let friendsDisplayCount = 5; // Start with 5, increment by 5
        function displayFriendTags() {
            const section = document.getElementById('friendTagSection');
            const list = document.getElementById('friendTagList');
            
            if (!section || !list || bestFriends.length === 0) return;
            
            section.style.display = 'block';
            
            const friendsToShow = bestFriends.slice(0, friendsDisplayCount);
            console.log('üë• Displaying friends:', friendsToShow.length, 'of', bestFriends.length);
            
            // Create friend tags with event listeners
            list.innerHTML = friendsToShow.map((friend, index) => {
                const isSelected = selectedFriends.includes(friend.username);
                return `
                    <div class="friend-tag-item ${isSelected ? 'selected' : ''}" data-username="${friend.username}" data-index="${index}">
                        <img src="${friend.pfp_url}" class="friend-tag-pfp" alt="${friend.username}">
                        <span class="friend-tag-username">@${friend.username}</span>
                    </div>
                `;
            }).join('');
            
            // Add show more button if there are more friends to display
            if (bestFriends.length > friendsDisplayCount) {
                const remaining = bestFriends.length - friendsDisplayCount;
                const toShow = Math.min(5, remaining);
                list.innerHTML += `<div class="show-more-friends" onclick="showMoreFriends()">+ Show ${toShow} more friend${toShow !== 1 ? 's' : ''} (${remaining} remaining)</div>`;
            }
            
            // Add click listeners to all friend tags
            document.querySelectorAll('.friend-tag-item').forEach(item => {
                item.addEventListener('click', function() {
                    toggleFriendTag(this.dataset.username, this);
                });
            });
            
            updateFriendTagCounter();
            console.log('üë• Friend tags displayed:', friendsToShow.length, '| Selected:', selectedFriends.length);
        }

        // Show more friends (5 at a time)
        window.showMoreFriends = function() {
            const previousCount = friendsDisplayCount;
            friendsDisplayCount = Math.min(friendsDisplayCount + 5, bestFriends.length);
            console.log('üë• Showing more friends:', previousCount, '‚Üí', friendsDisplayCount);
            displayFriendTags();
        }

        // Update friend tag counter
        function updateFriendTagCounter() {
            const counter = document.getElementById('friendTagCounter');
            if (counter) {
                counter.textContent = `${selectedFriends.length} selected`;
                counter.style.display = selectedFriends.length > 0 ? 'block' : 'none';
                console.log('üî¢ Friend counter updated:', selectedFriends.length);
            }
        }

        // Toggle friend tag selection
        let selectedFriends = [];
        function toggleFriendTag(username, element) {
            // Validate username
            try {
                username = window.Validator.validateUsername(username);
            } catch (error) {
                console.error('‚ùå Invalid username:', error.message);
                showToast('error', 'Invalid Username', error.message);
                return;
            }
            
            const index = selectedFriends.indexOf(username);
            
            if (index > -1) {
                // Remove friend
                selectedFriends.splice(index, 1);
                element.classList.remove('selected');
                console.log('‚ûñ Removed friend:', username, '| Total selected:', selectedFriends.length);
            } else {
                // Add friend (max 10)
                if (selectedFriends.length >= 10) {
                    showToast('info', 'Maximum Reached', 'You can tag up to 10 friends maximum');
                    console.log('‚ö†Ô∏è Max friends reached (10)');
                    return;
                }
                selectedFriends.push(username);
                element.classList.add('selected');
                console.log('‚ûï Added friend:', username, '| Total selected:', selectedFriends.length);
            }
            
            console.log('üë• Currently selected friends:', selectedFriends);
            updateFriendTagCounter();
        }

        // Get contacts to reconnect with (people you haven't reached out to recently)
        let reconnectContacts = [];
        async function loadInactiveContacts() {
            if (!isAuthenticated || !userFID) return;
            
            try {
                console.log('üîç Loading reconnect contacts...');
                
                // Get user's following list (people they might want to reconnect with)
                const followingData = await callNeynarAPI('user/following', { fid: userFID, limit: 100 });
                const following = followingData.users || [];
                
                // Filter out self and best friends (to show different people)
                const bestFriendFids = new Set(bestFriends.map(f => f.fid));
                reconnectContacts = following.filter(user => 
                    user.fid !== userFID && !bestFriendFids.has(user.fid)
                );
                
                console.log('üí§ Found reconnect contacts:', reconnectContacts.length);
                
            } catch (error) {
                console.error('‚ùå Error loading reconnect contacts:', error);
                // Fallback: use following list minus best friends
                reconnectContacts = [];
            }
        }
        
        // Get random contacts to reconnect with
        function getRandomReconnectContacts(count = 5) {
            if (reconnectContacts.length === 0) return [];
            
            // Shuffle and take random contacts
            const shuffled = [...reconnectContacts].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }
        
        // Show random contacts to reconnect with
        window.showInactiveContacts = function() {
            // If no reconnect contacts loaded yet, try to load from following
            if (reconnectContacts.length === 0) {
                // Use following list as fallback (excluding best friends)
                const bestFriendUsernames = new Set(bestFriends.map(f => f.username));
                reconnectContacts = bestFriends.slice(5); // Show people after top 5 best friends
            }
            
            if (reconnectContacts.length === 0) {
                showToast('info', 'No More Contacts', 'Try expanding your network on Farcaster! üåê');
                return;
            }
            
            const randomContacts = getRandomReconnectContacts(5);
            
            if (randomContacts.length === 0) {
                showToast('info', 'No More Contacts', 'Try expanding your network on Farcaster! üåê');
                return;
            }
            
            console.log('üí§ Showing reconnect contacts:', randomContacts.map(u => u.username));
            console.log('‚úÖ Currently selected friends:', selectedFriends);
            
            // Temporarily replace friend list with reconnect contacts
            const list = document.getElementById('friendTagList');
            if (!list) return;
            
            // Show selected count at top if any are selected
            let headerHtml = '';
            if (selectedFriends.length > 0) {
                headerHtml = `<div class="selected-friends-indicator">‚úì ${selectedFriends.length} friend${selectedFriends.length > 1 ? 's' : ''} selected</div>`;
            }
            
            list.innerHTML = headerHtml + randomContacts.map((friend, index) => {
                const isSelected = selectedFriends.includes(friend.username);
                return `
                    <div class="friend-tag-item ${isSelected ? 'selected' : ''}" data-username="${friend.username}" data-index="${index}">
                        <img src="${friend.pfp_url}" class="friend-tag-pfp" alt="${friend.username}">
                        <span class="friend-tag-username">@${friend.username}</span>
                        <span class="inactive-badge">üí¨</span>
                    </div>
                `;
            }).join('');
            
            // Add back to normal friends button
            list.innerHTML += `<div class="show-more-friends" onclick="displayFriendTags()">‚Üê Back to Best Friends</div>`;
            
            // Add click listeners
            document.querySelectorAll('.friend-tag-item').forEach(item => {
                item.addEventListener('click', function() {
                    toggleFriendTag(this.dataset.username, this);
                });
            });
            
            updateFriendTagCounter();
            showToast('success', 'Reconnect! üí¨', `Here are ${randomContacts.length} friend${randomContacts.length > 1 ? 's' : ''} to reach out to`);
        }

        // Display top friend invitation
        function displayTopFriendInvite() {
            const section = document.getElementById('topFriendInvite');
            const card = document.getElementById('topFriendCard');
            
            if (!section || !card || !topFriend) return;
            
            section.style.display = 'block';
            
            card.innerHTML = `
                <img src="${topFriend.pfp_url}" class="top-friend-pfp" alt="${topFriend.username}">
                <div class="top-friend-info">
                    <div class="top-friend-username">@${topFriend.username}</div>
                    <div class="top-friend-label">Your top friend on Farcaster</div>
                </div>
            `;
        }

        // Invite top friend to vote
        window.inviteTopFriend = async function() {
            if (!topFriend) return;
            
            const modeEmojis = {
                studio: 'üé¨',
                market: 'üõí',
                social: 'üåê',
                battle: '‚öîÔ∏è'
            };
            
            const modeNames = {
                studio: 'STUDIO',
                market: 'MARKET',
                social: 'SOCIAL',
                battle: 'BATTLE'
            };
            
            const timeRemaining = getTimeUntilZabalUpdate();
            const inviteText = `Hey @${topFriend.username}! üëã\n\nI just voted ${modeEmojis[currentShareMode]} ${modeNames[currentShareMode]} on ZABAL Live Hub!\n\nWhat's your vote? Join me! üé®\n\n‚è∞ ZABAL Update #4 in ${timeRemaining}\nüìä ${SONGJAM_URL}\n\n${MINIAPP_URL}`;
            
            try {
                await window.farcasterSDK.actions.composeCast({
                    text: inviteText,
                    embeds: [MINIAPP_URL],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ Invited top friend:', topFriend.username);
                showShareSuccess();
                setTimeout(() => closeShareModal(), 1500);
            } catch (error) {
                console.error('‚ùå Failed to invite friend:', error);
                showToast('error', 'Invitation Failed', 'Could not send invitation. Please try again.');
            }
        }

        // Challenge friends
        window.challengeFriends = async function() {
            const modeEmojis = {
                studio: 'üé¨',
                market: 'üõí',
                social: 'üåê',
                battle: '‚öîÔ∏è'
            };
            
            const modeNames = {
                studio: 'STUDIO',
                market: 'MARKET',
                social: 'SOCIAL',
                battle: 'BATTLE'
            };
            
            // Get selected friends or use top 3
            const friendsToTag = selectedFriends.length > 0 
                ? selectedFriends 
                : bestFriends.slice(0, 3).map(f => f.username);
            
            const friendMentions = friendsToTag.map(u => `@${u}`).join(' ');
            
            const challengeText = `‚öîÔ∏è Challenge time!\n\n${friendMentions} I just voted ${modeEmojis[currentShareMode]} ${modeNames[currentShareMode]} on ZABAL!\n\nWhat's YOUR vote? üé®\n\n${MINIAPP_URL}`;
            
            try {
                await window.farcasterSDK.actions.composeCast({
                    text: challengeText,
                    embeds: [MINIAPP_URL],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ Challenged friends:', friendsToTag);
                showShareSuccess();
                setTimeout(() => closeShareModal(), 1500);
            } catch (error) {
                console.error('‚ùå Failed to challenge friends:', error);
                showToast('error', 'Challenge Failed', 'Could not send challenge. Please try again.');
            }
        }

        // Initialize share preferences
        loadSharePreferences();
        
        // Update toggles after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            updateToggleUI();
            checkNotificationStatus();
        });

        // Enable notifications function
        window.enableNotifications = async function() {
            console.log('üîî Enabling notifications...');
            
            if (!window.farcasterSDK || !window.farcasterSDK.actions) {
                showToast('error', 'SDK Not Available', 'Please open in Warpcast to enable notifications');
                return;
            }

            try {
                // Call addMiniApp to prompt user to add the app and enable notifications
                const result = await window.farcasterSDK.actions.addMiniApp();
                
                console.log('‚úÖ Miniapp add result:', result);
                showToast('success', 'Notifications Enabled!', 'You\'ll receive daily reminders at 11 AM EST');
                
                // Update button state
                const btn = document.getElementById('enableNotificationsBtn');
                if (btn) {
                    btn.textContent = '‚úì Enabled';
                    btn.classList.add('enabled');
                }
                
                // Store in localStorage
                localStorage.setItem('notificationsEnabled', 'true');
                
            } catch (error) {
                console.error('‚ùå Failed to enable notifications:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                showToast('error', 'Enable Failed', error.message || 'Could not enable notifications. Please try again.');
            }
        }

        // Check notification status on load
        function checkNotificationStatus() {
            const enabled = localStorage.getItem('notificationsEnabled') === 'true';
            const btn = document.getElementById('enableNotificationsBtn');
            
            if (enabled && btn) {
                btn.textContent = '‚úì Enabled';
                btn.classList.add('enabled');
                // Don't disable - allow user to click again if needed
            }
        }

        // Multi-select voting system
        let selectedModes = [];

        window.toggleModeSelection = function(mode) {
            const card = document.querySelector(`.mode-card[data-mode="${mode}"]`);
            const checkbox = card.querySelector('.vote-checkbox-hidden');
            
            // Toggle selection
            if (selectedModes.includes(mode)) {
                selectedModes = selectedModes.filter(m => m !== mode);
                card.classList.remove('selected');
                checkbox.checked = false;
                console.log('‚ùå Deselected mode:', mode);
            } else {
                selectedModes.push(mode);
                card.classList.add('selected');
                checkbox.checked = true;
                console.log('‚úÖ Selected mode:', mode);
            }
            
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const btn = document.getElementById('submitVotesBtn');
            const countSpan = document.getElementById('selectedCount');
            
            if (countSpan) {
                countSpan.textContent = selectedModes.length;
            }
            
            if (btn) {
                btn.disabled = selectedModes.length === 0;
            }
            
            console.log('üìä Selected modes:', selectedModes);
        }

        window.submitVotes = async function() {
            console.log('üó≥Ô∏è Submitting votes for modes:', selectedModes);
            
            // Validate modes
            let validatedModes;
            try {
                validatedModes = window.Validator.validateModes(selectedModes);
            } catch (error) {
                console.error('‚ùå Invalid modes:', error.message);
                showToast('error', 'Invalid Selection', error.message);
                window.errorHandler?.handleError(error, { type: 'validation_error', context: 'submitVotes' });
                return;
            }
            
            if (validatedModes.length === 0) {
                showToast('info', 'No Selection', 'Please select at least one mode to vote for');
                return;
            }
            
            // Check authentication
            if (!isAuthenticated) {
                showToast('error', 'Authentication Required', 'Please open in Farcaster to vote');
                return;
            }
            
            if (currentState !== StreamState.DECIDING) {
                showToast('info', 'Voting Closed', 'Stream is currently locked or live');
                return;
            }
            
            // Show loading state for batch submission
            window.loadingManager?.show('submitVotes', 'Submitting your votes...');
            
            try {
                // Submit each vote (skipModal = true to prevent individual modals)
                for (const mode of validatedModes) {
                    await vote(mode, true);
                }
                
                // Reload votes once after all votes submitted
                await loadVotes();
                
                // Hide loading state
                window.loadingManager?.hide('submitVotes');
                
                showToast('success', 'Votes Submitted!', `Voted for ${validatedModes.length} mode${validatedModes.length > 1 ? 's' : ''}`);
                
                // Store voted modes for sharing
                const votedModes = [...validatedModes];
                
                // Clear selections
                selectedModes = [];
                document.querySelectorAll('.vote-checkbox').forEach(cb => cb.checked = false);
                updateSubmitButton();
                
                // Open share modal with all voted modes
                setTimeout(() => openShareModal(votedModes), 500);
                
            } catch (error) {
                console.error('‚ùå Error submitting votes:', error);
                window.loadingManager?.hide('submitVotes');
                showToast('error', 'Submission Failed', 'Could not submit votes. Please try again.');
            }
        }


        // Share vote to Farcaster - exposed to global scope
        window.shareVote = async function(modes, isAuto = false) {
            // Handle both single mode (string) and multiple modes (array)
            const votedModes = Array.isArray(modes) ? modes : [modes];
            console.log('üì§ Starting shareVote:', { modes: votedModes, isAuto, selectedFriends: selectedFriends.length });
            
            const modeEmojis = {
                studio: 'üé¨',
                market: 'üõí',
                social: 'üåê',
                battle: '‚öîÔ∏è'
            };
            
            const modeNames = {
                studio: 'STUDIO',
                market: 'MARKET',
                social: 'SOCIAL',
                battle: 'BATTLE'
            };
            
            const modeDescriptions = {
                studio: 'Creative art sessions',
                market: 'NFT drops & trading',
                social: 'Community hangouts',
                battle: 'Competitive challenges'
            };
            
            // Calculate total votes and percentages
            const totalVotes = votes.studio + votes.market + votes.social + votes.battle;
            const getPercentage = (count) => totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
            
            // Find leader
            const leader = getLeader();
            
            // Create vote standings with visual bars and leader indicator
            const createBar = (count, isLeader) => {
                const pct = getPercentage(count);
                const barLength = Math.round(pct / 10); // 10% = 1 block
                const bar = '‚ñà'.repeat(Math.max(1, barLength));
                const leaderMark = isLeader ? ' üëë' : '';
                return `${bar} ${pct}%${leaderMark}`;
            };
            
            const standings = [
                `üé¨ Studio: ${votes.studio} ${createBar(votes.studio, leader === 'studio')}`,
                `üõí Market: ${votes.market} ${createBar(votes.market, leader === 'market')}`,
                `üåê Social: ${votes.social} ${createBar(votes.social, leader === 'social')}`,
                `‚öîÔ∏è Battle: ${votes.battle} ${createBar(votes.battle, leader === 'battle')}`
            ].join('\n');
            
            // Check for milestone
            const isMilestone = checkMilestone(totalVotes);
            
            // Create engaging personalized message based on voted modes
            let castText;
            let callToAction;
            
            // Create voted modes text
            const votedModesText = votedModes.map(m => `${modeEmojis[m]} ${modeNames[m]}`).join(' + ');
            const isMultiVote = votedModes.length > 1;
            
            if (isMilestone) {
                castText = `üéâ WE HIT ${totalVotes} VOTES!\n\nJust voted ${votedModesText}${isMultiVote ? ' (multi-vote!)' : ''}\n\n${standings}\n\nJoin the celebration! üéä`;
                callToAction = 'Vote & celebrate with us! üëá';
            } else if (votedModes.includes(leader)) {
                castText = `${modeEmojis[leader]} ${modeNames[leader]} IS WINNING! üëë\n\nI voted: ${votedModesText}${isMultiVote ? ' üéØ' : ''}\n\n${standings}\n\n`;
                callToAction = 'Help us dominate! Vote now üëá';
            } else {
                castText = `Voted ${votedModesText} on ZABAL!${isMultiVote ? ' üéØ' : ''} üé®\n\n${standings}\n\n`;
                callToAction = 'Your turn! Vote now üëá';
            }
            
            // Add @zaal mention with stream suggestion
            const zaalMention = isMultiVote 
                ? `\n\n@zaal I think you should do a ${votedModes.map(m => modeNames[m]).join(' + ')} combo stream! üé®`
                : `\n\n@zaal I think you should do a ${modeNames[votedModes[0]]} stream for your next stream! üé®`;
            
            // Add friend tags if selected
            let friendTags = '';
            if (selectedFriends.length > 0) {
                console.log('üë• Tagging friends:', selectedFriends);
                friendTags = '\n\n' + selectedFriends.map(u => `@${u}`).join(' ') + ' what\'s your vote?';
            } else {
                console.log('üë§ No friends tagged');
            }
            
            // Add ZABAL Update countdown
            const timeRemaining = getTimeUntilZabalUpdate();
            const zabalUpdateInfo = `\n\n‚è∞ ZABAL Update #4 in ${timeRemaining}\nüìä ZABAL Empire Leaderboard\nüéµ ${SONGJAM_URL}`;
            
            // Add call to action and links
            castText += callToAction + zaalMention + friendTags + zabalUpdateInfo + '\n\n' + MINIAPP_URL;
            
            // Log cast details before sending
            console.log('üìù Cast text length:', castText.length);
            console.log('üîó Embeds:', [SONGJAM_URL, MINIAPP_URL]);
            console.log('üì¢ Channel:', 'zao');
            
            // Clear selected friends after sharing
            const taggedFriends = [...selectedFriends];
            selectedFriends = [];
            
            try {
                const result = await window.farcasterSDK.actions.composeCast({
                    text: castText,
                    embeds: [SONGJAM_URL, MINIAPP_URL],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ composeCast result:', result);
                
                // Only show error if the result explicitly indicates failure
                // Note: User closing the composer is NOT a failure
                if (result && result.error) {
                    console.error('‚ùå Failed to share vote:', result.error);
                    showToast('error', 'Share Failed', 'Could not share to Farcaster. Please try again.');
                } else {
                    console.log('‚úÖ Vote shared to Farcaster successfully');
                    console.log('üë• Tagged friends in cast:', taggedFriends);
                    
                    // Track share for analytics
                    trackShare(mode);
                    console.log('üìä Share tracked for mode:', mode);
                    
                    // Show share success feedback
                    if (!isAuto) {
                        showShareSuccess();
                        setTimeout(() => closeShareModal(), 1500);
                    }
                }
            } catch (error) {
                // Only show error for actual exceptions, not user cancellations
                console.log('‚ö†Ô∏è Share action result:', error);
                // Don't show error toast - user may have just closed the composer
            }
        }

        // Track shares for analytics and potential rewards
        function trackShare(mode, userTotalVotes) {
            const shareCount = parseInt(localStorage.getItem('shareCount') || '0') + 1;
            localStorage.setItem('shareCount', shareCount.toString());
            localStorage.setItem('lastShareMode', mode);
            localStorage.setItem('lastShareTime', Date.now().toString());
            
            console.log('üìä Share tracked:', { shareCount, mode, userTotalVotes });
            
            // Check for share milestones
            if (shareCount === 1) {
                console.log('üéâ First share!');
            } else if (shareCount === 10) {
                console.log('üåü 10 shares milestone!');
            } else if (shareCount === 50) {
                console.log('üí´ 50 shares milestone!');
            }
        }

        // Show share success animation
        function showShareSuccess() {
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #e0ddaa 0%, #d4c96e 100%);
                color: #0a0a0a;
                padding: 20px 40px;
                border-radius: 12px;
                font-size: 1.2rem;
                font-weight: 800;
                z-index: 10001;
                animation: shareSuccess 1.5s ease;
                box-shadow: 0 8px 32px rgba(224, 221, 170, 0.4);
            `;
            successMsg.textContent = '‚úÖ Shared to /zao!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => successMsg.remove(), 1500);
        }
        

        function updateVotes() {
            console.log('üîÑ updateVotes() called');
            console.log('üìä Current votes:', votes);
            
            Object.keys(votes).forEach(mode => {
                const voteElement = document.querySelector(`[data-votes="${mode}"]`);
                if (voteElement) {
                    console.log(`üìù Updating ${mode} display to ${votes[mode]}`);
                    voteElement.textContent = votes[mode];
                } else {
                    console.warn(`‚ö†Ô∏è Vote element not found for mode: ${mode}`);
                }
            });

            console.log('üîò Resetting all vote buttons...');
            document.querySelectorAll('.vote-button').forEach(btn => {
                btn.disabled = false;
                // Show different text based on authentication
                btn.textContent = isAuthenticated ? 'Vote' : 'üîí Login to Vote';
            });

            if (userVote) {
                console.log('üë§ User has voted for:', userVote);
                const votedCard = document.querySelector(`[data-mode="${userVote}"]`);
                if (votedCard) {
                    const btn = votedCard.querySelector('.vote-button');
                    if (btn) {
                        btn.disabled = true;
                        btn.textContent = 'Voted';
                        console.log('‚úÖ Marked', userVote, 'button as "Voted"');
                    } else {
                        console.warn('‚ö†Ô∏è Vote button not found for:', userVote);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Could not find card for mode:', userVote);
                }
            } else {
                console.log('üë§ User has not voted yet');
            }
        }

        function getLeader() {
            const leader = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
            console.log('üèÜ Current leader:', leader, 'with', votes[leader], 'votes');
            return leader;
        }

        // Load and display personal stats
        async function loadPersonalStats() {
            if (!isAuthenticated || !userFID || !supabase) return;
            
            try {
                // Show stats section
                const statsSection = document.getElementById('personalStats');
                if (statsSection) {
                    statsSection.classList.add('active');
                }
                
                // Get total votes for this user
                const { data: userVotes, error: votesError } = await supabase
                    .from('votes')
                    .select('*')
                    .eq('fid', parseInt(userFID));
                
                if (votesError) {
                    console.error('Error loading user votes:', votesError);
                    return;
                }
                
                // Calculate stats
                const totalVotes = userVotes ? userVotes.length : 0;
                
                // Calculate favorite mode
                const modeCounts = {};
                if (userVotes) {
                    userVotes.forEach(vote => {
                        modeCounts[vote.mode] = (modeCounts[vote.mode] || 0) + 1;
                    });
                }
                const favoriteMode = Object.keys(modeCounts).length > 0
                    ? Object.keys(modeCounts).reduce((a, b) => modeCounts[a] > modeCounts[b] ? a : b)
                    : '‚Äî';
                
                const modeEmojis = {
                    studio: 'üé¨',
                    market: 'üõí',
                    social: 'üåê',
                    battle: '‚öîÔ∏è'
                };
                
                // Calculate streak (simplified - just check if voted today and yesterday)
                const today = getVoteDate();
                const estNow = getESTDate();
                const yesterday = new Date(estNow.getTime() - 86400000).toISOString().split('T')[0];
                
                const votedToday = userVotes?.some(v => v.vote_date === today);
                const votedYesterday = userVotes?.some(v => v.vote_date === yesterday);
                
                let streak = 0;
                if (votedToday) streak = 1;
                if (votedToday && votedYesterday) streak = 2; // Simplified - could be extended
                
                // Calculate vote power based on /zao activity and Neynar score
                const powerData = await calculateVotePower(userFID);
                userVotePower = powerData.power; // Cache for later use
                
                // Update UI
                document.getElementById('statTotalVotes').textContent = totalVotes;
                document.getElementById('statStreak').textContent = streak;
                document.getElementById('statFavoriteMode').textContent = 
                    favoriteMode !== '‚Äî' ? modeEmojis[favoriteMode] : '‚Äî';
                updateVotePowerDisplay(powerData);
                
                console.log('‚úÖ Personal stats loaded:', { totalVotes, streak, favoriteMode, votePower: powerData.power });
            } catch (err) {
                console.error('Error loading personal stats:', err);
            }
        }

        function updateLeader() {
            console.log('üîÑ updateLeader() called');
            console.log('üìä Current votes:', votes);
            
            const leader = getLeader();
            
            console.log('üèÜ Highlighting leader:', leader, 'with', votes[leader], 'votes');
            
            // Remove leading class from all cards
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('leading');
                console.log('üóëÔ∏è Removed leading from:', card.dataset.mode);
            });

            // Add leading class to winner
            const leaderCard = document.querySelector(`[data-mode="${leader}"]`);
            if (leaderCard) {
                leaderCard.classList.add('leading');
                console.log('‚úÖ Added "leading" class to', leader);
                console.log('üéØ Leader card classes:', leaderCard.className);
            } else {
                console.error('‚ùå Could not find leader card for:', leader);
                console.log('üîç Available cards:', 
                    Array.from(document.querySelectorAll('.mode-card')).map(c => c.dataset.mode)
                );
            }

            // Update today section if it exists
            const todayMode = document.getElementById('todayMode');
            const todayDesc = document.getElementById('todayDesc');
            if (todayMode && todayDesc && leaderCard) {
                const modeName = leaderCard.querySelector('.mode-name').textContent;
                todayMode.textContent = modeName;
                todayDesc.textContent = `Leading with ${votes[leader]} votes`;
                console.log('‚úÖ Updated today section:', modeName);
            }
        }

        // Initialize
        async function initialize() {
            console.log('üöÄ Initializing app...');
            updateHeroState();
            console.log('‚úÖ Hero state updated');
            
            // Initialize Farcaster authentication
            initializeFarcaster();
            checkLiveStatus();
            
            // Check live status every 2 minutes (using lifecycle manager)
            window.appLifecycle.addInterval(checkLiveStatus, 120000, 'live-status-check');
            
            // Manual controls for testing (remove in production)
            window.setLiveStatus = function(status) {
                localStorage.setItem('zabalLiveStatus', status);
                if (status === 'live') {
                    showLiveBanner();
                } else {
                    hideLiveBanner();
                }
            }
            
            // Load votes from database
            await loadVotes();
            
            // Update leader display after votes loaded
            updateLeader();
            console.log('‚úÖ Initial leader update complete');
            
            // Load vote history
            await loadVoteHistory();
            
            // Refresh votes every 30 seconds (using lifecycle manager)
            window.appLifecycle.addInterval(loadVotes, 30000, 'vote-refresh');
            console.log('‚úÖ Vote refresh interval set (30s)');
            
            window.appLifecycle.addInterval(updateCountdown, 1000, 'countdown');
            updateCountdown();
            console.log('‚úÖ Countdown started');
            console.log('üéâ ZABAL Live Hub ready!');
        }
        
        // Toggle vote power breakdown
        window.toggleBreakdown = function() {
            const content = document.getElementById('breakdownContent');
            const icon = document.getElementById('breakdownToggleIcon');
            
            if (!content || !icon) return;
            
            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }
        
        // Toggle vote history accordion
        window.toggleVoteHistory = function() {
            const header = document.querySelector('.accordion-header');
            const content = document.getElementById('voteHistoryAccordion');
            
            if (!header || !content) return;
            
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                header.classList.remove('active');
                content.classList.remove('expanded');
            } else {
                // Expand
                header.classList.add('active');
                content.classList.add('expanded');
            }
        }
        
        // Start the app
        initialize();
    </script>
    
    <!-- Production Enhancements -->
    <script src="js/production-enhancements.js"></script>
    
    <script>
        // Integrate production enhancements with existing code
        document.addEventListener('DOMContentLoaded', () => {
            // Show offline banner when offline
            const offlineBanner = document.getElementById('offlineBanner');
            window.addEventListener('offline', () => {
                if (offlineBanner) offlineBanner.classList.add('show');
            });
            window.addEventListener('online', () => {
                if (offlineBanner) offlineBanner.classList.remove('show');
            });
            
            // Add ARIA labels to mode cards
            document.querySelectorAll('.mode-card').forEach((card, index) => {
                const mode = card.dataset.mode;
                card.setAttribute('role', 'button');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Vote for ${mode} mode`);
                
                // Add keyboard support for mode cards
                card.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        card.click();
                    }
                });
            });
            
            // Add ARIA labels to buttons
            const submitBtn = document.getElementById('submitVotesBtn');
            if (submitBtn) {
                submitBtn.setAttribute('aria-label', 'Submit your votes');
            }
            
            // Show voting streak badge if exists
            const streak = window.dataPersistence.getVotingStreak();
            if (streak > 0) {
                const badge = document.createElement('div');
                badge.className = 'streak-badge';
                badge.innerHTML = `<span class="fire-emoji">üî•</span>${streak} day streak!`;
                badge.setAttribute('role', 'status');
                badge.setAttribute('aria-live', 'polite');
                document.body.appendChild(badge);
            }
        });
    </script>
</body>
</html>
