<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ZABAL Live Hub ‚Äî Stream Coordination</title>
    <meta name="description" content="Vote daily on ZABAL's creative stream direction! Community-driven Farcaster miniapp for choosing Studio, Market, Social, or Battle mode. Join the ZABAL community and shape the stream.">
    <meta name="keywords" content="ZABAL, Farcaster, miniapp, voting, stream, NFT, art, community, web3, crypto art, social voting">
    <meta name="author" content="ZABAL">
    <meta name="theme-color" content="#141e27">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#141e27">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://zabal.art/">
    
    <!-- Shared Navigation Styles -->
    <link rel="stylesheet" href="css/shared-navigation.css">
    
    <!-- Shared Navigation Script -->
    <script src="js/mobile-navigation.js" defer></script>
    
    <!-- CRITICAL: Call ready() when SDK is loaded -->
    <script>
        // Call ready() as soon as possible to dismiss splash screen
        function callReady() {
            console.log('üöÄ Attempting to call ready()...');
            
            // Try multiple SDK references
            const sdk = window.farcasterSDK || window.miniapp?.sdk || window.sdk;
            
            if (sdk && sdk.actions && sdk.actions.ready) {
                console.log('‚úÖ SDK found, calling ready()');
                sdk.actions.ready()
                    .then(() => {
                        console.log('‚úÖ Splash screen dismissed successfully');
                        window.splashDismissed = true;
                    })
                    .catch(err => {
                        console.warn('‚ö†Ô∏è ready() call failed:', err);
                    });
            } else {
                console.warn('‚ö†Ô∏è SDK not available yet, will retry...');
            }
        }
        
        // Try immediately
        callReady();
        
        // Try on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', callReady);
        
        // Try when SDK loads
        window.addEventListener('farcasterSDKReady', callReady);
    </script>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="ZABAL Live Hub - Vote on Stream Direction">
    <meta property="og:description" content="Vote daily on ZABAL's direction! Choose Studio, Market, Social, or Battle mode to shape the stream.">
    <meta property="og:image" content="https://zabal.art/assets/preview.png">
    <meta property="og:url" content="https://zabal.art">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="ZABAL Live Hub">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ZABAL Live Hub - Vote on Stream Direction">
    <meta name="twitter:description" content="Vote daily on ZABAL's direction! Choose Studio, Market, Social, or Battle mode to shape the stream.">
    <meta name="twitter:image" content="https://zabal.art/assets/preview.png">
    <meta name="twitter:site" content="@zabal">
    <meta name="twitter:creator" content="@zabal">
    
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "ZABAL Live Hub",
      "description": "Community-driven voting platform for ZABAL's stream direction. Vote daily on Studio, Market, Social, or Battle mode.",
      "url": "https://zabal.art",
      "applicationCategory": "SocialNetworkingApplication",
      "operatingSystem": "Web",
      "browserRequirements": "Requires JavaScript. Works on mobile and desktop.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
      },
      "creator": {
        "@type": "Person",
        "name": "ZABAL",
        "url": "https://warpcast.com/zaal",
        "sameAs": [
          "https://twitter.com/zabal",
          "https://warpcast.com/zaal"
        ]
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5",
        "ratingCount": "1"
      },
      "potentialAction": {
        "@type": "VoteAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "https://zabal.art",
          "actionPlatform": [
            "http://schema.org/DesktopWebPlatform",
            "http://schema.org/MobileWebPlatform"
          ]
        }
      }
    }
    </script>
    
    <!-- Additional Geo-targeting and Language Meta Tags -->
    <meta name="geo.region" content="US">
    <meta name="geo.placename" content="United States">
    <meta name="language" content="en">
    <meta name="distribution" content="global">
    <meta name="rating" content="general">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    
    <!-- Performance and Preconnect Hints -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://esm.sh">
    <link rel="dns-prefetch" href="https://zabal.art">
    
    <!-- Farcaster Mini App Embed Meta Tag -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://zabal.art/assets/preview.png","button":{"title":"Vote Now","action":{"type":"launch_frame","name":"ZABAL Live Hub","url":"https://zabal.art","splashImageUrl":"https://zabal.art/assets/splash.png","splashBackgroundColor":"#141e27"}}}' />
    <!-- For backward compatibility -->
    <meta name="fc:frame" content='{"version":"1","imageUrl":"https://zabal.art/assets/preview.png","button":{"title":"Vote Now","action":{"type":"launch_frame","name":"ZABAL Live Hub","url":"https://zabal.art","splashImageUrl":"https://zabal.art/assets/splash.png","splashBackgroundColor":"#141e27"}}}' />
    
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <!-- Farcaster Mini App SDK - CDN version for better compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/miniapp-sdk/dist/index.min.js" onload="
        console.log('üéØ SDK script loaded, initializing...');
        if (window.miniapp && window.miniapp.sdk) {
            window.farcasterSDK = window.miniapp.sdk;
            window.farcasterSDKLoaded = true;
            
            console.log('üéØ SDK ready, calling ready() immediately...');
            window.farcasterSDK.actions.ready()
                .then(() => {
                    console.log('‚úÖ Splash screen dismissed via SDK load');
                    window.splashDismissed = true;
                })
                .catch(err => {
                    console.warn('‚ö†Ô∏è ready() failed on SDK load:', err);
                });
            
            window.dispatchEvent(new Event('farcasterSDKReady'));
        } else {
            console.warn('‚ö†Ô∏è SDK loaded but window.miniapp not available');
        }
    "></script>
    <script>
        // Aggressive fallback: Force hide splash screen after 3 seconds
        window.splashDismissed = false;
        
        setTimeout(() => {
            if (!window.splashDismissed) {
                // Try multiple methods to hide splash screen
                const splashSelectors = [
                    '.fc-splash-screen',
                    '[class*="splash"]',
                    '[class*="Splash"]',
                    'iframe[src*="splash"]'
                ];
                
                splashSelectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.remove();
                    });
                });
                
                // Ensure body is scrollable
                document.body.style.overflow = 'auto';
                document.documentElement.style.overflow = 'auto';
                
                // Mark as dismissed
                window.splashDismissed = true;
            }
        }, 1000);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #141e27;
            --accent-yellow: #e0ddaa;
            --bg-black: #000000;
            --text-white: #ffffff;
            --text-gray: #b8b8b8;
            --text-secondary: #9a9a9a;
            --border-color: #2a3a47;
            --hover-glow: rgba(224, 221, 170, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--bg-black);
            color: var(--text-white);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header - Collapsible */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            /* Smooth height transition */
            transition: padding 0.3s ease, height 0.3s ease;
            will-change: padding;
        }

        /* Expanded state (default) */
        header.expanded {
            padding: 1.5rem 0;
        }

        /* Collapsed state - compact header */
        header.collapsed {
            padding: 0.5rem 0;
        }

        header.collapsed nav {
            opacity: 0;
            visibility: hidden;
            height: 0;
            overflow: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        header.expanded nav {
            opacity: 1;
            visibility: visible;
            height: auto;
            transition: opacity 0.3s ease 0.1s, visibility 0.3s ease 0.1s;
        }

        /* Keep profile visible in both states */
        header.collapsed .user-profile-badge,
        header.expanded .user-profile-badge {
            opacity: 1 !important;
            visibility: visible !important;
            height: auto !important;
        }

        /* Header toggle chevron */
        .header-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
            background: rgba(224, 221, 170, 0.1);
            border: 1px solid rgba(224, 221, 170, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.3s ease;
            flex-shrink: 0;
        }

        .header-toggle:hover {
            background: rgba(224, 221, 170, 0.2);
        }

        .header-toggle-icon {
            font-size: 0.7rem;
            color: var(--accent-yellow);
            transition: transform 0.3s ease;
        }

        header.collapsed .header-toggle-icon {
            transform: rotate(180deg);
        }

        /* Respect reduced motion */
        @media (prefers-reduced-motion: reduce) {
            header,
            header.expanded .user-profile-badge,
            header.expanded nav,
            header.collapsed .user-profile-badge,
            header.collapsed nav,
            .header-toggle,
            .header-toggle-icon {
                transition: none;
            }
        }

        .header-content {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-center {
            display: flex;
            justify-content: center;
            flex: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: flex-end;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--text-white) 0%, var(--accent-yellow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            white-space: nowrap;
            letter-spacing: 0.05em;
        }

        nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        nav a {
            color: var(--text-gray);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: color 0.3s ease;
            white-space: nowrap;
        }

        nav a:hover {
            color: var(--accent-yellow);
        }

        nav a.active {
            color: var(--accent-yellow);
        }

        nav a:focus-visible {
            outline: 2px solid var(--accent-yellow);
            outline-offset: 4px;
            border-radius: 4px;
        }

        /* Vote Power (Simplified) */
        .vote-power-simple {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(224, 221, 170, 0.05);
            border: 1px solid rgba(224, 221, 170, 0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .power-label {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .power-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .power-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: auto;
        }

        /* Weekly Focus Voting Styles */
        .weekly-focus-section {
            padding: 60px 20px;
            background: linear-gradient(180deg, rgba(20, 30, 39, 0.5) 0%, rgba(10, 10, 10, 0.5) 100%);
        }

        .weekly-focus-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .weekly-focus-header h2 {
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--text-white) 0%, var(--accent-yellow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .weekly-focus-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .weekly-focus-categories {
            display: grid;
            gap: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .focus-category {
            background: rgba(224, 221, 170, 0.03);
            border: 1px solid rgba(224, 221, 170, 0.1);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .focus-category:hover {
            background: rgba(224, 221, 170, 0.05);
            border-color: rgba(224, 221, 170, 0.2);
        }

        .focus-category-header {
            margin-bottom: 1.5rem;
        }

        .focus-category-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 0.5rem;
        }

        .focus-category-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .focus-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .focus-option-btn {
            background: rgba(224, 221, 170, 0.05);
            border: 2px solid rgba(224, 221, 170, 0.2);
            border-radius: 12px;
            padding: 1rem 0.75rem;
            color: var(--text-white);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .focus-option-btn:hover {
            background: rgba(224, 221, 170, 0.1);
            border-color: var(--accent-yellow);
            transform: translateY(-2px);
        }

        .focus-option-btn:focus-visible {
            outline: 3px solid var(--accent-yellow);
            outline-offset: 2px;
        }

        .focus-option-btn {
            position: relative;
        }

        .focus-option-btn.voted {
            background: rgba(224, 221, 170, 0.15);
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .focus-option-btn.voted::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1rem;
            color: var(--accent-yellow);
            font-weight: bold;
        }

        .focus-results {
            border-top: 1px solid rgba(224, 221, 170, 0.1);
            padding-top: 1.5rem;
        }

        .focus-results-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .focus-result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .focus-result-item.leading {
            background: rgba(224, 221, 170, 0.1);
            border: 1px solid rgba(224, 221, 170, 0.3);
        }

        .focus-result-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .focus-result-item.leading .focus-result-name {
            color: var(--accent-yellow);
        }

        .focus-result-votes {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .focus-result-item.leading .focus-result-votes {
            color: var(--accent-yellow);
        }

        .focus-result-bar {
            height: 4px;
            background: rgba(224, 221, 170, 0.1);
            border-radius: 2px;
            margin-top: 0.25rem;
            overflow: hidden;
        }

        .focus-result-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(224, 221, 170, 0.3) 0%, var(--accent-yellow) 100%);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Weekly Voting Locked State */
        .weekly-focus-section.locked {
            position: relative;
            pointer-events: none;
        }

        .weekly-focus-section.locked .focus-category {
            filter: blur(2px);
            opacity: 0.55;
            transition: all 0.3s ease;
        }

        .weekly-unlock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid rgba(224, 221, 170, 0.3);
            border-radius: 20px;
            padding: 2.5rem 3rem;
            max-width: 90%;
            width: 400px;
            pointer-events: auto;
            animation: overlayFadeIn 0.2s ease-out;
        }

        .weekly-unlock-overlay .lock-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: lockPulse 2s ease-in-out infinite;
        }

        @keyframes lockPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.85; }
        }

        .weekly-unlock-overlay h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 0.75rem;
        }

        .weekly-unlock-overlay p {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .weekly-unlock-overlay .unlock-hint {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-top: 0.5rem;
        }

        .weekly-reset-note {
            font-size: 0.8rem !important;
            color: var(--text-gray) !important;
            font-style: italic;
            margin-top: 0.5rem;
        }

        .weekly-unlock-overlay .unlock-cta {
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
            background: rgba(224, 221, 170, 0.1);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(224, 221, 170, 0.2);
        }

        /* Weekly Voting Unlocked Animation */
        .weekly-focus-section.unlocking {
            animation: unlockFade 0.5s ease-out;
        }

        @keyframes overlayFadeIn {
            from { opacity: 0; transform: translate(-50%, -48%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        @keyframes unlockFade {
            from {
                opacity: 0.7;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Motion Safety - Respect user preferences */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (max-width: 768px) {
            .weekly-focus-section {
                padding: 40px 16px;
            }

            .focus-options {
                grid-template-columns: 1fr;
            }

            .focus-category {
                padding: 1.5rem;
            }
        }

        /* Vote Comments Section */
        .vote-comments-section {
            padding: 80px 20px;
            background: linear-gradient(180deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 30, 39, 0.95) 100%);
            border-top: 1px solid rgba(224, 221, 170, 0.1);
        }

        .comments-header {
            text-align: center;
            margin-bottom: 3rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .comments-header h2 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #f5f0c0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }

        .comments-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .add-comment-form {
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 2px solid rgba(224, 221, 170, 0.2);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .comment-textarea {
            width: 100%;
            min-height: 120px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 1.25rem;
            color: var(--text-white);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: var(--accent-yellow);
            box-shadow: 0 0 0 3px rgba(224, 221, 170, 0.15), 0 4px 12px rgba(224, 221, 170, 0.1);
            background: rgba(0, 0, 0, 0.5);
        }

        .comment-textarea::placeholder {
            color: var(--text-gray);
            opacity: 0.7;
        }

        .comment-form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .char-count {
            font-size: 0.9rem;
            color: var(--text-gray);
            font-weight: 500;
        }

        .submit-comment-btn {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #f5f0c0 100%);
            color: var(--bg-dark);
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .submit-comment-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #f5f0c0 0%, var(--accent-yellow) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(224, 221, 170, 0.4);
        }

        .submit-comment-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .submit-comment-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .comment-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(224, 221, 170, 0.3) transparent;
        }

        .comment-filters::-webkit-scrollbar {
            height: 6px;
        }

        .comment-filters::-webkit-scrollbar-track {
            background: transparent;
        }

        .comment-filters::-webkit-scrollbar-thumb {
            background: rgba(224, 221, 170, 0.3);
            border-radius: 3px;
        }

        .filter-tab {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--text-secondary);
            padding: 0.625rem 1.25rem;
            border-radius: 24px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .filter-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(224, 221, 170, 0.3);
            transform: translateY(-1px);
        }

        .filter-tab.active {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #f5f0c0 100%);
            color: var(--bg-dark);
            border-color: var(--accent-yellow);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .comment-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .comment-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.03) 100%);
            border-color: rgba(224, 221, 170, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .comment-user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .comment-username {
            font-weight: 700;
            color: var(--text-white);
            font-size: 1rem;
        }

        .comment-mode-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%);
            padding: 0.35rem 0.75rem;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid rgba(224, 221, 170, 0.2);
        }

        .comment-time {
            font-size: 0.85rem;
            color: var(--text-gray);
            white-space: nowrap;
        }

        .comment-text {
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.7;
            word-wrap: break-word;
        }

        .comments-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-gray);
        }

        .comments-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-gray);
        }

        .comments-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .vote-comments-section {
                padding: 60px 16px;
            }

            .comments-header {
                margin-bottom: 2rem;
            }

            .comments-header h2 {
                font-size: 2rem;
            }

            .comments-header p {
                font-size: 1rem;
            }

            .add-comment-form {
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .comment-textarea {
                min-height: 100px;
                padding: 1rem;
                font-size: 0.95rem;
            }

            .submit-comment-btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.95rem;
            }

            .comment-filters {
                gap: 0.5rem;
                justify-content: flex-start;
                flex-wrap: nowrap;
                margin-bottom: 2rem;
                padding-bottom: 0.75rem;
                -webkit-overflow-scrolling: touch;
            }

            .filter-tab {
                padding: 0.6rem 1.1rem;
                font-size: 0.875rem;
                min-width: fit-content;
                flex-shrink: 0;
            }

            .comment-card {
                padding: 1.25rem;
            }

            .comment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .comment-user {
                width: 100%;
            }

            .comment-text {
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            .vote-comments-section {
                padding: 40px 12px;
            }

            .add-comment-form {
                padding: 1.25rem;
            }

            .comment-form-footer {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .submit-comment-btn {
                width: 100%;
            }
        }

        /* Live State Hero */
        .live-hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 120px 20px 60px;
            position: relative;
        }

        .hero-state {
            margin-bottom: 2rem;
            font-size: 0.9rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .hero-state.deciding {
            color: var(--accent-yellow);
            animation: pulse-text 2s ease-in-out infinite;
        }

        .hero-state.locked {
            color: #4a9eff;
        }

        .hero-state.live {
            color: #ff4444;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -20px);
                opacity: 0;
            }
        }

        /* Settings Toggle */
        .settings-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(20, 30, 39, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .settings-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 0.85rem;
            color: var(--text-gray);
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .setting-description {
            font-size: 0.7rem;
            color: var(--text-gray);
            opacity: 0.7;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .toggle-switch.active {
            background: var(--accent-yellow);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        /* System Status Message */
        .system-status-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: 2px solid #ff6666;
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px rgba(255, 68, 68, 0.4);
            max-width: 90%;
            animation: slideDown 0.3s ease-out;
        }

        .status-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-weight: 700;
            font-size: 1rem;
            color: white;
            margin-bottom: 4px;
        }

        .status-message {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .offline-banner.show {
            display: block;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 420px;
            pointer-events: none;
        }

        .toast {
            background: rgba(20, 30, 39, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: flex-start;
            gap: 14px;
            pointer-events: auto;
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            min-width: 320px;
            position: relative;
            overflow: hidden;
        }

        .toast.success {
            border-left: 4px solid #4ade80;
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.08) 0%, rgba(20, 30, 39, 0.98) 100%);
        }

        .toast.error {
            border-left: 4px solid #f87171;
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.08) 0%, rgba(20, 30, 39, 0.98) 100%);
        }

        .toast.info {
            border-left: 4px solid var(--accent-yellow);
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.08) 0%, rgba(20, 30, 39, 0.98) 100%);
        }

        /* Progress bar for toast auto-dismiss */
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 100%);
            width: 100%;
            transform-origin: left;
            animation: toastProgress var(--duration) linear forwards;
        }

        .toast.success .toast-progress {
            background: linear-gradient(90deg, #4ade80 0%, rgba(74, 222, 128, 0.5) 100%);
        }

        .toast.error .toast-progress {
            background: linear-gradient(90deg, #f87171 0%, rgba(248, 113, 113, 0.5) 100%);
        }

        .toast.info .toast-progress {
            background: linear-gradient(90deg, var(--accent-yellow) 0%, rgba(224, 221, 170, 0.5) 100%);
        }

        @keyframes toastProgress {
            from {
                transform: scaleX(1);
            }
            to {
                transform: scaleX(0);
            }
        }

        .toast-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
            line-height: 1;
            margin-top: 2px;
        }

        .toast.success .toast-icon {
            filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.4));
        }

        .toast.error .toast-icon {
            filter: drop-shadow(0 0 8px rgba(248, 113, 113, 0.4));
        }

        .toast.info .toast-icon {
            filter: drop-shadow(0 0 8px rgba(224, 221, 170, 0.4));
        }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-white);
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .toast-message {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .toast-close {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            transition: all 0.2s ease;
            min-width: 32px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            transform: scale(1.1);
        }

        .toast-close:active {
            transform: scale(0.95);
        }

        @keyframes slideIn {
            from {
                transform: translateX(450px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
            to {
                transform: translateX(450px) scale(0.95);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s cubic-bezier(0.7, 0, 0.84, 0) forwards;
        }

        /* Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            .toast {
                animation: fadeIn 0.2s ease;
            }
            
            .toast.removing {
                animation: fadeOut 0.2s ease forwards;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        }

        @media (max-width: 768px) {
            .toast-container {
                top: 70px;
                right: 12px;
                left: 12px;
                max-width: none;
            }

            .toast {
                min-width: auto;
                padding: 14px 16px;
                gap: 12px;
            }
            
            .toast-icon {
                font-size: 1.3rem;
            }
            
            .toast-title {
                font-size: 0.9rem;
            }
            
            .toast-message {
                font-size: 0.85rem;
            }
            
            .toast-close {
                min-width: 28px;
                min-height: 28px;
                padding: 6px;
            }
        }

        @media (max-width: 480px) {
            .toast-container {
                top: 60px;
                right: 8px;
                left: 8px;
            }
            
            .toast {
                padding: 12px 14px;
                border-radius: 12px;
            }
        }

        /* Farcaster Client Selection Modal */
        .farcaster-client-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .farcaster-client-content {
            background: linear-gradient(135deg, rgba(20, 30, 39, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%);
            border: 2px solid rgba(224, 221, 170, 0.3);
            border-radius: 20px;
            padding: 32px 28px;
            max-width: 500px;
            width: 100%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.8rem;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            transform: scale(1.1);
        }

        .farcaster-client-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-white);
            margin-bottom: 8px;
            text-align: center;
            background: linear-gradient(135deg, var(--text-white) 0%, var(--accent-yellow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .farcaster-client-subtitle {
            font-size: 0.95rem;
            color: var(--text-gray);
            text-align: center;
            margin-bottom: 24px;
        }

        .farcaster-client-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .farcaster-client-btn {
            background: rgba(224, 221, 170, 0.05);
            border: 2px solid rgba(224, 221, 170, 0.2);
            border-radius: 12px;
            padding: 16px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-white);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .farcaster-client-btn:hover {
            background: rgba(224, 221, 170, 0.1);
            border-color: var(--accent-yellow);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(224, 221, 170, 0.2);
        }

        .farcaster-client-btn:active {
            transform: translateY(-1px);
        }

        .farcaster-client-btn .client-emoji {
            font-size: 2rem;
            line-height: 1;
        }

        .farcaster-client-btn .client-name {
            font-size: 0.9rem;
            letter-spacing: 0.03em;
        }

        @media (max-width: 480px) {
            .farcaster-client-content {
                padding: 24px 20px;
            }

            .farcaster-client-title {
                font-size: 1.3rem;
            }

            .farcaster-client-subtitle {
                font-size: 0.9rem;
            }

            .farcaster-client-options {
                grid-template-columns: 1fr;
            }

            .farcaster-client-btn {
                padding: 14px 12px;
            }
        }

        /* Floating Share Button */
        .floating-share-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            gap: 8px;
            align-items: center;
            animation: slideInUp 0.3s ease-out;
        }

        .floating-share-button.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        .share-btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            transition: all 0.2s ease;
        }

        .share-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.6);
        }

        .share-btn-primary:active {
            transform: translateY(0);
        }

        .share-icon {
            font-size: 18px;
        }

        .share-btn-close {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .share-btn-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        @media (max-width: 768px) {
            .floating-share-button {
                bottom: 20px;
                right: 10px;
                left: 10px;
                justify-content: center;
            }

            .share-btn-primary {
                flex: 1;
                justify-content: center;
            }
        }

        /* Friend Tagging Popup */
        .friend-tag-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .friend-tag-content {
            background: linear-gradient(135deg, #141e27 0%, #1a2a37 100%);
            border: 2px solid var(--accent-yellow);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .friend-tag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .friend-tag-close {
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .friend-tag-close:hover {
            color: var(--text-primary);
        }

        .friend-tag-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
        }

        .friend-tag-item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--secondary-blue);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .friend-tag-item:hover {
            border-color: var(--primary-purple);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .friend-tag-item.selected {
            border-color: var(--accent-yellow);
            background: rgba(255, 215, 0, 0.15);
        }

        .friend-tag-item.selected::before {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--accent-yellow);
            font-weight: 900;
            font-size: 16px;
        }

        .friend-tag-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
            flex-shrink: 0;
        }

        .friend-tag-item.selected .friend-tag-avatar {
            border-color: var(--accent-yellow);
        }

        .friend-tag-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .friend-tag-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-tag-username {
            font-size: 12px;
            color: var(--text-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-tag-item.selected .friend-tag-name {
            color: var(--accent-yellow);
        }

        .friend-tag-actions {
            display: flex;
            gap: 12px;
        }

        .friend-tag-share-btn,
        .friend-tag-skip-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .friend-tag-share-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .friend-tag-share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.6);
        }

        .friend-tag-skip-btn {
            background: var(--secondary-blue);
            color: var(--text-gray);
        }

        .friend-tag-skip-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .friend-tag-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* DEPRECATED: Old Share Modal (kept for backwards compatibility) */
        .share-modal {
            display: none !important; /* Hidden - no longer used */
        }

        .share-modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .share-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 8px;
        }

        .share-modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .share-link-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .share-link-text {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-white);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .copy-link-btn {
            padding: 8px 16px;
            background: var(--accent-yellow);
            color: var(--primary-blue);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-link-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .share-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .share-action-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-farcaster-btn {
            background: linear-gradient(135deg, #8a63d2 0%, #7c4dff 100%);
            color: white;
        }

        .share-farcaster-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(138, 99, 210, 0.4);
        }

        .share-close-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-gray);
            min-height: 44px;
        }

        .share-close-btn:hover {
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .share-action-btn:focus-visible {
            outline: 3px solid var(--accent-yellow);
            outline-offset: 2px;
        }

        /* User Profile Badge */
        .user-profile-badge {
            display: flex !important;
            align-items: center;
            gap: 10px;
            padding: 6px 14px 6px 6px;
            background: rgba(224, 221, 170, 0.08);
            border: 1px solid rgba(224, 221, 170, 0.3);
            border-radius: 24px;
            font-size: 0.85rem;
            color: var(--accent-yellow);
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            min-width: fit-content;
        }

        .user-profile-badge:hover {
            background: rgba(224, 221, 170, 0.15);
            border-color: var(--accent-yellow);
            transform: translateY(-1px);
        }

        /* Settings Dropdown */
        .settings-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .settings-dropdown.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .settings-dropdown-header {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-dropdown-item:last-child {
            border-bottom: none;
        }

        .settings-dropdown-label {
            font-size: 0.85rem;
            color: var(--text-gray);
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .settings-dropdown-description {
            font-size: 0.7rem;
            color: var(--text-gray);
            opacity: 0.7;
        }

        .settings-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }

        .enable-notifications-btn {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #c9b961 100%);
            color: var(--primary-blue);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .enable-notifications-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .enable-notifications-btn.enabled {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        .settings-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }

        .enable-notifications-btn {
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #c9b961 100%);
            color: var(--primary-blue);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .enable-notifications-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .enable-notifications-btn.enabled {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            border: 1px solid #4ade80;
        }

        /* Friend Tagging Section */
        .friend-tag-section {
            margin: 20px 0;
            padding: 16px;
            background: rgba(20, 30, 39, 0.5);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .friend-tag-header {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        
        .selected-friends-indicator {
            width: 100%;
            padding: 8px 12px;
            background: rgba(224, 221, 170, 0.15);
            border: 1px solid var(--accent-yellow);
            border-radius: 8px;
            color: var(--accent-yellow);
            font-size: 0.85rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
        }

        .friend-tag-count {
            font-size: 0.8rem;
            color: var(--accent-yellow);
            font-weight: 600;
        }

        .show-more-friends {
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--secondary-blue);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-white);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .show-more-friends:hover {
            border-color: var(--accent-yellow);
            background: rgba(224, 221, 170, 0.1);
        }

        .friend-tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .friend-tag-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--secondary-blue);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-tag-item:hover {
            border-color: var(--accent-yellow);
            background: rgba(224, 221, 170, 0.1);
        }

        .friend-tag-item.selected {
            background: var(--accent-yellow);
            color: var(--bg-black);
            border-color: var(--accent-yellow);
            transform: scale(1.05);
        }

        .friend-tag-item.selected .friend-tag-username {
            color: var(--bg-black);
            font-weight: 700;
        }
        
        .friend-tag-item.selected::before {
            content: '‚úì';
            margin-right: 4px;
            font-weight: 900;
        }
        
        .inactive-badge {
            margin-left: 4px;
            opacity: 0.7;
        }

        .friend-tag-pfp {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--accent-yellow);
        }

        .friend-tag-username {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Top Friend Invitation */
        .top-friend-invite {
            margin: 20px 0;
            padding: 16px;
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.1) 0%, rgba(224, 221, 170, 0.05) 100%);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
        }

        .invite-header {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 12px;
        }

        .top-friend-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--secondary-blue);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .top-friend-pfp {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-yellow);
        }

        .top-friend-info {
            flex: 1;
        }

        .top-friend-username {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-white);
        }

        .top-friend-label {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .invite-friend-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-yellow);
            color: var(--bg-black);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .invite-friend-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .challenge-friends-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .challenge-friends-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        /* Now Live Banner */
        .now-live-banner {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 99;
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
            animation: slideDown 0.5s ease;
        }

        .live-pulse {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .live-text {
            color: white;
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        .watch-now-btn {
            padding: 8px 20px;
            background: white;
            color: #ff0000;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watch-now-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        /* Currently Winning Share Section - Live momentum during voting */
        .currently-winning-section {
            padding: 30px 20px;
            background: linear-gradient(180deg, rgba(251, 191, 36, 0.03) 0%, transparent 100%);
        }

        .currently-winning-card {
            max-width: 480px;
            margin: 0 auto 20px;
            padding: 28px 24px;
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.25);
            border-radius: 16px;
            text-align: center;
            animation: currentlyWinningFadeIn 0.5s ease-out;
        }

        .currently-winning-card.weekly {
            background: rgba(168, 85, 247, 0.08);
            border-color: rgba(168, 85, 247, 0.25);
        }

        @keyframes currentlyWinningFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .currently-winning-card {
                animation: none;
            }
        }

        .currently-winning-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .currently-winning-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #fbbf24;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .currently-winning-card.weekly .currently-winning-title {
            color: #a855f7;
        }

        .currently-winning-result {
            font-size: 1rem;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .currently-winning-result span {
            font-weight: 700;
            color: #fbbf24;
        }

        .currently-winning-card.weekly .currently-winning-result span {
            color: #a855f7;
        }

        .currently-winning-cta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .currently-winning-share-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: var(--bg-black);
            font-weight: 700;
            font-size: 0.95rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .currently-winning-share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.4);
        }

        .currently-winning-card.weekly .currently-winning-share-btn {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            color: white;
        }

        .currently-winning-card.weekly .currently-winning-share-btn:hover {
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.4);
        }

        /* Winning Vote Share Section - Celebration moment after results */
        .winning-share-section {
            padding: 30px 20px;
            background: linear-gradient(180deg, rgba(224, 221, 170, 0.03) 0%, transparent 100%);
        }

        .winning-share-card {
            max-width: 480px;
            margin: 0 auto 20px;
            padding: 28px 24px;
            background: rgba(224, 221, 170, 0.05);
            border: 1px solid rgba(224, 221, 170, 0.15);
            border-radius: 16px;
            text-align: center;
            /* Fade-in animation */
            animation: winningCardFadeIn 0.5s ease-out;
        }

        .winning-share-card.weekly {
            background: rgba(138, 43, 226, 0.05);
            border-color: rgba(138, 43, 226, 0.2);
        }

        @keyframes winningCardFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Respect reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .winning-share-card {
                animation: none;
            }
        }

        .winning-share-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .winning-share-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 8px;
        }

        .winning-share-result {
            font-size: 1rem;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .winning-share-result span {
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .winning-share-card.weekly .winning-share-result span {
            color: #a855f7;
        }

        .winning-share-thanks {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        /* Voter avatar stack */
        .winning-share-voters {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .voter-avatar-stack {
            display: flex;
            align-items: center;
        }

        .voter-avatar-stack img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--bg-black);
            margin-left: -10px;
            object-fit: cover;
        }

        .voter-avatar-stack img:first-child {
            margin-left: 0;
        }

        .voter-count-text {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .winning-share-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #d4af37 100%);
            color: var(--bg-black);
            font-weight: 700;
            font-size: 0.95rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .winning-share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(224, 221, 170, 0.3);
        }

        .winning-share-card.weekly .winning-share-btn {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
            color: white;
        }

        .winning-share-card.weekly .winning-share-btn:hover {
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.3);
        }

        /* Vote History Accordion Section */
        .vote-history-accordion-section {
            background: linear-gradient(180deg, var(--bg-black) 0%, #0a0a0a 100%);
            padding: 40px 20px 60px;
            border-top: 1px solid var(--border-color);
        }

        .vote-history-accordion {
            max-width: 1200px;
            margin: 0 auto;
        }

        .accordion-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 30px;
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: inherit;
            font-family: inherit;
        }

        .accordion-header:hover {
            border-color: var(--accent-yellow);
            background: var(--secondary-blue);
            transform: translateY(-2px);
        }

        .accordion-header.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: transparent;
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: 20px;
            text-align: left;
        }

        .accordion-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        .accordion-text h3 {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text-white);
            margin: 0 0 4px 0;
        }

        .accordion-text p {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin: 0;
        }

        .accordion-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--secondary-blue);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .accordion-header:hover .accordion-toggle {
            background: var(--accent-yellow);
        }

        .chevron-icon {
            color: var(--text-white);
            transition: transform 0.3s ease;
        }

        .accordion-header:hover .chevron-icon {
            color: var(--bg-black);
        }

        .accordion-header.active .chevron-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-top: none;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        .accordion-content.expanded {
            max-height: 5000px;
        }

        .accordion-inner {
            padding: 30px;
        }

        .vote-history-timeline {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .vote-day-card {
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .vote-day-card:hover {
            border-color: var(--accent-yellow);
            transform: translateY(-2px);
        }

        .friend-tag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .friend-sort-options {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            justify-content: center;
        }

        .friend-sort-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-gray);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .friend-sort-btn:hover {
            background: rgba(251, 191, 36, 0.1);
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .friend-sort-btn.active {
            background: var(--accent-yellow);
            border-color: var(--accent-yellow);
            color: #000000;
            font-weight: 700;
        }

        .vote-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .vote-day-date {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .vote-day-winner {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-white);
        }

        .winner-badge {
            padding: 4px 12px;
            background: var(--accent-yellow);
            color: var(--bg-black);
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .vote-day-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .mode-stat {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--secondary-blue);
            border-radius: 8px;
        }

        .mode-stat-icon {
            font-size: 1.5rem;
        }

        .mode-stat-info {
            flex: 1;
        }

        .mode-stat-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-white);
            margin-bottom: 2px;
        }

        .mode-stat-votes {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .vote-day-voters {
            margin-top: 15px;
        }

        .voters-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .voters-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .voter-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(26, 42, 55, 0.4);
            border: 1px solid rgba(224, 221, 170, 0.15);
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .voter-tag:hover {
            background: var(--primary-blue);
            border-color: var(--accent-yellow);
            transform: translateY(-1px);
        }

        .voter-pfp {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1.5px solid rgba(224, 221, 170, 0.3);
            object-fit: cover;
        }

        .voter-mode-icon {
            font-size: 0.9rem;
            line-height: 1;
        }

        .voter-username {
            color: var(--text-white);
            font-weight: 500;
            opacity: 0.9;
        }

        .voter-display-name {
            color: var(--text-gray);
            font-size: 0.75rem;
            margin-left: 4px;
        }

        .loading-votes {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-size: 0.95rem;
        }

        .no-history {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }

        @media (max-width: 768px) {
            .now-live-banner {
                top: 50px;
                padding: 10px 15px;
                gap: 10px;
            }

            .live-text {
                font-size: 0.85rem;
            }

            .watch-now-btn {
                padding: 6px 15px;
                font-size: 0.85rem;
            }


            .vote-day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .vote-day-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Skip to content link (accessibility) */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-yellow);
            color: var(--primary-blue);
            padding: 8px 16px;
            text-decoration: none;
            font-weight: 700;
            z-index: 10001;
        }

        .skip-to-content:focus {
            top: 0;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        .user-pfp {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--accent-yellow);
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .user-name-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .verified-badge {
            font-size: 0.7rem;
            color: var(--accent-yellow);
        }

        .user-fid {
            font-size: 0.65rem;
            color: var(--text-gray);
            opacity: 0.8;
        }

        /* Personal Stats Section */
        .personal-stats {
            background: linear-gradient(135deg, rgba(20, 30, 39, 0.5) 0%, rgba(26, 42, 55, 0.5) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            display: block;
        }

        .personal-stats.active {
            display: block;
        }

        .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            transition: all 0.2s ease;
        }

        .stats-header:hover {
            opacity: 0.8;
        }

        .stats-summary {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-gray);
        }

        .stats-toggle-icon {
            font-size: 0.7rem;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .stats-toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .stats-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            display: block;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 4px;
        }

        .stat-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hero-title {
            font-size: clamp(2.5rem, 8vw, 5rem);
            font-weight: 900;
            margin-bottom: 1.5rem;
            line-height: 1.1;
        }

        .hero-subtitle {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: var(--text-gray);
            margin-bottom: 3rem;
            max-width: 700px;
        }

        .countdown {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: rgba(20, 30, 39, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .countdown-label {
            font-size: 0.9rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .countdown-time {
            color: var(--accent-yellow);
            font-variant-numeric: tabular-nums;
            transition: color 0.3s ease;
        }

        .countdown.urgent-1hr {
            border-color: #ff9800;
        }

        .countdown.urgent-1hr .countdown-time {
            color: #ff9800;
        }

        .countdown.urgent-15min {
            border-color: #ff4444;
            animation: pulse-countdown 1.5s ease-in-out infinite;
        }

        .countdown.urgent-15min .countdown-time {
            color: #ff4444;
        }

        @keyframes pulse-countdown {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 68, 68, 0); }
            50% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.4); }
        }

        .hero-cta {
            display: none;
        }

        /* Stream Wheel Section */
        .wheel-section {
            padding: 60px 20px;
            background: linear-gradient(180deg, var(--bg-black) 0%, #0a0a0a 100%);
            position: relative;
        }

        .wheel-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 100px;
            background: linear-gradient(180deg, transparent 0%, var(--border-color) 100%);
        }

        .wheel-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .wheel-header h2 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 900;
            margin-bottom: 1rem;
        }

        .wheel-header p {
            font-size: 1.2rem;
            color: var(--text-gray);
            max-width: 600px;
            margin: 0 auto;
        }

        .wheel-container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            gap: 1.25rem;
        }

        .mode-card {
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.25rem;
            align-items: center;
            transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-yellow);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .mode-card:hover {
            border-color: var(--accent-yellow);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .mode-card:hover::before {
            transform: scaleX(1);
        }

        /* Keyboard focus styles - WCAG AA compliant */
        .mode-card:focus-visible {
            outline: 3px solid var(--accent-yellow);
            outline-offset: 4px;
            border-color: var(--accent-yellow);
        }

        .mode-card:focus-visible::before {
            transform: scaleX(1);
        }

        .mode-card.leading {
            border-color: var(--accent-yellow);
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.05) 0%, var(--primary-blue) 100%);
        }

        .mode-card.leading::before {
            transform: scaleX(1);
        }

        /* Vote Confirmation Glow */
        .mode-card.vote-confirmed {
            animation: voteConfirmGlow 600ms ease-out;
        }

        @keyframes voteConfirmGlow {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 209, 197, 0.6);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(79, 209, 197, 0.3);
            }
            100% {
                box-shadow: 0 0 0 12px rgba(79, 209, 197, 0);
            }
        }

        .mode-icon {
            display: none;
        }

        .mode-info {
            flex: 1;
        }

        .mode-name {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 0.35rem;
            color: var(--text-white);
        }

        .mode-description {
            color: var(--text-gray);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .mode-votes {
            text-align: center;
            min-width: 90px;
        }

        .vote-count {
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent-yellow);
            display: block;
            margin-bottom: 0.15rem;
        }

        .vote-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vote-percentage-bar {
            width: 100%;
            height: 4px;
            background: rgba(224, 221, 170, 0.1);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .vote-percentage-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(224, 221, 170, 0.3) 0%, var(--accent-yellow) 100%);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .mode-card:not(.leading) .vote-percentage-fill {
            background: linear-gradient(90deg, rgba(100, 100, 100, 0.3) 0%, rgba(150, 150, 150, 0.5) 100%);
        }

        .leading-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-top: 6px;
            animation: pulse-badge 2s ease-in-out infinite;
        }

        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .weekly-voted-state {
            margin-top: 24px;
            padding: 16px 20px;
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .voted-state-icon {
            font-size: 1.5rem;
        }

        .voted-state-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .voted-state-text strong {
            color: var(--text-white);
            font-size: 0.95rem;
        }

        .voted-state-text span {
            color: var(--text-gray);
            font-size: 0.85rem;
        }

        .vote-checkbox-hidden {
            display: none;
        }

        .selectable-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .selectable-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(224, 221, 170, 0.3);
        }

        .selectable-card.selected {
            border-color: var(--accent-yellow);
            background: linear-gradient(135deg, rgba(224, 221, 170, 0.1) 0%, var(--primary-blue) 100%);
            box-shadow: 0 0 20px rgba(224, 221, 170, 0.4);
        }

        .selectable-card.selected::before {
            content: '';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: var(--accent-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selectable-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            font-size: 1.2rem;
            font-weight: 900;
            z-index: 1;
        }

        .selection-indicator {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .selectable-card.selected .selection-indicator {
            display: block;
        }

        .submit-votes-container {
            margin-top: 32px;
            text-align: center;
        }

        /* Voted Status Indicator */
        .voted-status {
            display: none;
            margin-bottom: 20px;
            padding: 16px 24px;
            background: rgba(224, 221, 170, 0.1);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            text-align: center;
        }

        .voted-status.active {
            display: block;
        }

        .voted-status-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .voted-status-text {
            color: var(--accent-yellow);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .voted-status-mode {
            color: var(--text-white);
            font-size: 0.95rem;
        }

        .voted-status-actions {
            margin-top: 12px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .voted-status-btn {
            padding: 8px 20px;
            background: transparent;
            border: 1px solid var(--accent-yellow);
            color: var(--accent-yellow);
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voted-status-btn:hover {
            background: var(--accent-yellow);
            color: var(--primary-blue);
        }

        .voted-status-btn:focus-visible {
            outline: 3px solid var(--accent-yellow);
            outline-offset: 2px;
        }

        .submit-votes-btn {
            padding: 16px 48px;
            background: linear-gradient(135deg, var(--accent-yellow) 0%, #c9b961 100%);
            color: var(--primary-blue);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(224, 221, 170, 0.3);
        }

        .submit-votes-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(224, 221, 170, 0.5);
        }

        .submit-votes-btn:focus-visible {
            outline: 3px solid var(--accent-yellow);
            outline-offset: 4px;
        }

        .submit-votes-btn:disabled {
            background: var(--border-color);
            color: var(--text-gray);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        /* Post-Vote Invite Nudge */
        .invite-nudge {
            margin-top: 1.5rem;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-gray);
            opacity: 1;
            transition: opacity 150ms ease;
        }

        .invite-nudge.hidden {
            display: none;
        }

        .invite-nudge.fade-in {
            animation: nudgeFadeIn 150ms ease;
        }

        @keyframes nudgeFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .invite-actions {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .invite-btn {
            padding: 0.5rem 1.25rem;
            background: var(--accent-yellow);
            color: var(--primary-blue);
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 120ms ease;
        }

        .invite-btn:hover {
            opacity: 0.9;
        }

        .dismiss-btn {
            padding: 0.5rem 1.25rem;
            background: transparent;
            color: var(--text-gray);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: border-color 120ms ease;
        }

        .dismiss-btn:hover {
            border-color: var(--text-secondary);
        }

        /* Today/Yesterday Section */
        .stream-history {
            padding: 80px 20px;
            background: var(--bg-black);
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        .history-card {
            background: var(--primary-blue);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .history-label {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(224, 221, 170, 0.1);
            border: 1px solid var(--accent-yellow);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--accent-yellow);
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-mode {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 1rem;
        }

        .history-description {
            color: var(--text-gray);
            margin-bottom: 1.5rem;
        }

        .history-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-yellow);
            text-decoration: none;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .history-link:hover {
            gap: 0.75rem;
        }


        /* Proof Section */
        .proof-section {
            padding: 80px 20px;
            background: var(--bg-black);
            text-align: center;
        }

        .proof-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 3rem;
            max-width: 1000px;
            margin: 3rem auto 0;
        }

        .proof-item {
            text-align: center;
        }

        .proof-number {
            font-size: clamp(3rem, 6vw, 5rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--text-white) 0%, var(--accent-yellow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
            margin-bottom: 0.5rem;
        }

        .proof-label {
            font-size: 1rem;
            color: var(--text-gray);
            font-weight: 600;
        }

        /* Footer */
        footer {
            padding: 60px 20px;
            background: var(--bg-black);
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--text-gray);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--accent-yellow);
        }

        .footer-brand {
            color: var(--text-white);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .footer-tagline {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-top: 1.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            header.expanded {
                padding: 10px 16px;
            }

            header.collapsed {
                padding: 6px 16px;
            }

            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
            }

            .logo {
                font-size: 1.3rem;
            }
            
            .header-content {
                grid-template-columns: 1fr auto;
                gap: 1rem;
            }
            
            .header-center {
                display: none;
            }
            
            .header-left {
                gap: 8px;
            }
            
            .header-right {
                gap: 8px;
            }

            /* Ensure toggle is visible on mobile */
            .header-toggle {
                width: 32px;
                height: 32px;
            }


            .user-profile-badge {
                padding: 3px 10px 3px 3px;
                font-size: 0.7rem;
                max-width: 160px;
                border-radius: 16px;
                gap: 6px;
            }

            .user-pfp {
                width: 24px;
                height: 24px;
            }

            .user-fid {
                font-size: 0.6rem;
            }

            .container {
                padding: 0 16px;
            }

            section {
                padding: 20px 0;
            }

            .personal-stats {
                margin: 8px 16px;
                padding: 10px;
            }

            .stats-header {
                margin-bottom: 8px;
                padding-bottom: 6px;
            }

            .stats-title {
                font-size: 0.85rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .stat-item {
                padding: 6px 4px;
            }

            .stat-value {
                font-size: 1.1rem;
                margin-bottom: 2px;
            }

            .stat-label {
                font-size: 0.55rem;
                line-height: 1.2;
            }

            .live-hero {
                padding: 20px 20px 25px;
                min-height: auto;
            }

            .hero-state {
                font-size: 0.7rem;
                padding: 4px 12px;
                margin-bottom: 10px;
            }

            .hero-title {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
                line-height: 1.2;
            }

            .hero-subtitle {
                font-size: 0.85rem;
                margin-bottom: 1rem;
            }

            .countdown {
                margin-top: 1rem;
            }

            .countdown-label {
                font-size: 0.75rem;
            }

            .countdown-time {
                font-size: 1.5rem;
            }

            .hero-cta {
                display: none;
            }

            .wheel-section {
                padding: 25px 0;
            }

            .wheel-header h2 {
                font-size: 1.3rem;
                margin-bottom: 0.5rem;
            }

            .wheel-header p {
                font-size: 0.85rem;
            }

            .mode-card {
                grid-template-columns: 1fr;
                text-align: center;
                padding: 0.5rem;
                gap: 0.3rem;
                border-radius: 6px;
                border-width: 1px;
            }

            .mode-icon {
                display: none;
            }

            .mode-name {
                font-size: 0.8rem;
                margin-bottom: 0.1rem;
                font-weight: 700;
            }

            .mode-description {
                display: none;
            }

            .mode-votes {
                min-width: auto;
                margin-top: 0.15rem;
            }

            .vote-count {
                font-size: 1rem;
                margin-bottom: 0.05rem;
            }

            .vote-label {
                font-size: 0.5rem;
            }

            .vote-button {
                margin-top: 0.3rem;
                padding: 5px 10px;
                font-size: 0.7rem;
            }

            .mode-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            nav {
                gap: 0.75rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            nav a {
                font-size: 0.85rem;
            }

            .share-modal-content {
                width: 95%;
                padding: 24px;
            }

            .share-link-box {
                flex-direction: column;
                gap: 8px;
            }

            .copy-link-btn {
                width: 100%;
            }

            .history-grid {
                grid-template-columns: 1fr;
            }

            .artifacts-grid {
                grid-template-columns: 1fr;
            }

            .vote-day-stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 12px;
                margin-bottom: 15px;
            }

        @media (max-width: 480px) {
            header.expanded {
                padding: 8px 12px;
            }

            header.collapsed {
                padding: 5px 12px;
            }

            .logo {
                font-size: 1.1rem;
            }
            
            .header-content {
                padding: 0 16px;
            }
            
            .header-toggle {
                min-width: 36px;
                min-height: 36px;
            }

            .header-toggle {
                width: 28px;
                height: 28px;
                margin-left: 8px;
            }

            .user-profile-badge {
                padding: 2px 8px 2px 2px;
                font-size: 0.65rem;
                max-width: 140px;
                border-radius: 14px;
                gap: 5px;
            }

            .user-pfp {
                width: 22px;
                height: 22px;
            }

            .user-name {
                font-size: 0.65rem;
            }

            .user-fid {
                font-size: 0.55rem;
            }

            .verified-badge {
                font-size: 0.6rem;
            }

            .container {
                padding: 0 12px;
            }

            section {
                padding: 15px 0;
            }

            .personal-stats {
                margin: 6px 12px;
                padding: 8px;
            }

            .stats-header {
                margin-bottom: 6px;
                padding-bottom: 4px;
            }

            .stats-title {
                font-size: 0.75rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .stat-item {
                padding: 4px 2px;
            }

            .stat-value {
                font-size: 1rem;
                margin-bottom: 2px;
            }

            .stat-label {
                font-size: 0.5rem;
                line-height: 1.1;
            }

            .live-hero {
                padding: 15px 16px 20px;
            }

            .hero-state {
                font-size: 0.65rem;
                padding: 3px 10px;
                margin-bottom: 8px;
            }

            .hero-title {
                font-size: 1.3rem;
                margin-bottom: 0.4rem;
                line-height: 1.15;
            }

            .hero-subtitle {
                font-size: 0.8rem;
                margin-bottom: 0.75rem;
            }

            .countdown {
                margin-top: 0.75rem;
            }

            .countdown-label {
                font-size: 0.7rem;
                margin-bottom: 0.25rem;
            }

            .countdown-time {
                font-size: 1.3rem;
            }

            .hero-cta {
                display: none;
            }

            .wheel-section {
                padding: 20px 0;
            }

            .wheel-header h2 {
                font-size: 1.1rem;
                margin-bottom: 0.4rem;
            }

            .wheel-header p {
                font-size: 0.8rem;
            }

            .mode-card {
                padding: 0.45rem;
                gap: 0.25rem;
                border-radius: 6px;
                border-width: 1px;
            }

            .mode-icon {
                display: none;
            }

            .mode-name {
                font-size: 0.75rem;
                margin-bottom: 0.08rem;
                font-weight: 700;
            }

            .mode-description {
                display: none;
            }

            .mode-votes {
                min-width: auto;
                margin-top: 0.12rem;
            }

            .vote-count {
                font-size: 0.95rem;
                margin-bottom: 0.05rem;
            }

            .vote-label {
                font-size: 0.48rem;
                letter-spacing: 0.1px;
            }

            .mode-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.4rem;
            }

            .vote-button {
                width: 100%;
                padding: 4px;
                font-size: 0.65rem;
                margin-top: 0.25rem;
            }

            .history-grid,
            .artifacts-grid {
                gap: 0.65rem;
            }

            .history-card,
            .artifact-card {
                padding: 0.875rem;
            }
        }
    </style>
    
    <!-- Production Enhancement Styles -->
    <link rel="stylesheet" href="css/production-styles.css">
    
    <!-- Core Modules (Load First) -->
    <script src="js/config.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/lifecycle.js"></script>
    <script src="js/state-manager.js"></script>
    <script src="js/database.js"></script>
    <script src="js/api-throttle.js"></script>
    <script src="js/share-messages.js"></script>
    <script src="js/share-modal.js"></script>
</head>
<body>
    <!-- Skip to content link for accessibility -->
    <a href="#votingSection" class="skip-to-content">Skip to voting</a>
    
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
        You are offline. Voting is disabled until connection is restored.
    </div>
    
    <!-- System Status Message (for Supabase failures, etc) -->
    <div id="systemStatusMessage" class="system-status-message" style="display: none;">
        <div class="status-icon">!</div>
        <div class="status-content">
            <div class="status-title">System Unavailable</div>
            <div class="status-message">Voting is temporarily disabled. Please refresh the page.</div>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header - Collapsible (expanded by default to show user profile) -->
    <header id="mainHeader" class="expanded">
        <div class="header-content">
            <!-- Left: Logo + Toggle -->
            <div class="header-left">
                <a href="index.html" class="logo">ZABAL</a>
                <button class="header-toggle" id="headerToggle" onclick="toggleHeader()" aria-label="Toggle header">
                    <span class="header-toggle-icon">‚ñ≤</span>
                </button>
            </div>
            
            <!-- Center: Navigation -->
            <div class="header-center">
                <nav>
                    <a href="vote.html" class="active">Vote</a>
                    <a href="chat.html">Chat</a>
                    <a href="submissions.html">Submit</a>
                    <a href="gallery.html">Research</a>
                    <a href="leaderboard.html">Leaderboard</a>
                    <a href="https://www.empirebuilder.world/empire/0xbB48f19B0494Ff7C1fE5Dc2032aeEE14312f0b07">Empire Builder</a>
                    <a href="https://www.thezao.com/nexus" target="_blank">ZAO Nexus</a>
                </nav>
            </div>
            
            <!-- Right: Profile + Hamburger -->
            <div class="header-right">
                <div id="userProfile" class="user-profile-badge" onclick="toggleSettingsDropdown()">
                <img id="userPfp" class="user-pfp" src="" alt="Profile" onerror="this.style.display='none'">
                <div class="user-info">
                    <div class="user-name-row">
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="verified-badge" id="verifiedBadge" style="display: none;">‚úì</span>
                    </div>
                    <span class="user-fid" id="userFidDisplay"></span>
                </div>
                
                <!-- Settings Dropdown -->
                <div id="settingsDropdown" class="settings-dropdown" onclick="event.stopPropagation()">
                    <div class="settings-dropdown-header">
                        ‚öôÔ∏è Share Settings
                    </div>
                    
                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>Auto-share votes</span>
                            <span class="settings-dropdown-description">Automatically share when you vote</span>
                        </div>
                        <div class="toggle-switch" id="autoShareToggleProfile" onclick="toggleSetting('autoShare')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>Share only when leading</span>
                            <span class="settings-dropdown-description">Only auto-share if your mode is winning</span>
                        </div>
                        <div class="toggle-switch" id="shareLeadingToggleProfile" onclick="toggleSetting('shareLeading')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>Milestone celebrations</span>
                            <span class="settings-dropdown-description">Share on 10th, 50th, 100th vote</span>
                        </div>
                        <div class="toggle-switch" id="shareMilestonesToggleProfile" onclick="toggleSetting('shareMilestones')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="settings-dropdown-divider"></div>

                    <div class="settings-dropdown-item">
                        <div class="settings-dropdown-label">
                            <span>üîî Daily Reminders</span>
                            <span class="settings-dropdown-description">Get notified at 11 AM EST to vote</span>
                        </div>
                        <button class="enable-notifications-btn" id="enableNotificationsBtn" onclick="enableNotifications()">
                            Enable
                        </button>
                    </div>
                </div>
                
                <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <button class="mobile-menu-close" onclick="toggleMobileMenu()" aria-label="Close menu">
            <span class="close-icon">√ó</span>
            <span class="close-text">Back</span>
        </button>
        <a href="vote.html" class="active">Vote</a>
        <a href="chat.html">Chat</a>
        <a href="submissions.html">Submit</a>
        <a href="gallery.html">Research</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="https://www.empirebuilder.world/empire/0xbB48f19B0494Ff7C1fE5Dc2032aeEE14312f0b07">Empire Builder</a>
        <a href="https://www.thezao.com/nexus" target="_blank">ZAO Nexus</a>
    </div>

    <!-- Now Live Banner -->
    <div id="nowLiveBanner" class="now-live-banner" style="display: none;">
        <div class="live-pulse"></div>
        <span class="live-text">ZABAL IS LIVE NOW</span>
        <button class="watch-now-btn" onclick="shareLiveStreamDirect()">Share Stream</button>
    </div>

    <!-- Personal Stats -->
    <!-- Voting power moved to bottom of page -->

    <!-- Live State Hero -->
    <section class="live-hero">
        <div class="hero-state deciding" id="heroState">Vote Daily for Monday's Stream</div>
        <h1 class="hero-title" id="heroTitle">Vote Every Day for Monday's Stream</h1>
        <p class="hero-subtitle" id="heroSubtitle">Cast your vote daily. The most popular mode by Monday 5pm ET becomes the stream.</p>
        
        <div class="countdown" id="countdown">
            <span class="countdown-label">Closes at 5 PM EST in</span>
            <span class="countdown-time" id="countdownTime">2:34:12</span>
        </div>

    </section>

    <!-- Stream Wheel Section -->
    <section class="wheel-section" id="wheel">
        <div class="container">
            <div class="mode-cards-grid">
                <!-- Studio Mode -->
                <div class="mode-card leading selectable-card" data-mode="studio" onclick="vote('studio')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="studio">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Studio Mode</div>
                        <div class="mode-description">Deep work. Long-form creation.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="studio">42</span>
                        <span class="vote-label">Votes</span>
                        <div class="leading-badge">Leading</div>
                        <div class="vote-percentage-bar">
                            <div class="vote-percentage-fill" data-percentage="studio" style="width: 0%"></div>
                        </div>
                        <div class="selection-indicator">Selected</div>
                    </div>
                </div>

                <!-- Market Mode -->
                <div class="mode-card selectable-card" data-mode="market" onclick="vote('market')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="market">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Market Mode</div>
                        <div class="mode-description">Fast decisions. Community-driven.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="market">28</span>
                        <span class="vote-label">Votes</span>
                        <div class="vote-percentage-bar">
                            <div class="vote-percentage-fill" data-percentage="market" style="width: 0%"></div>
                        </div>
                        <div class="selection-indicator">Selected</div>
                    </div>
                </div>

                <!-- Social Mode -->
                <div class="mode-card selectable-card" data-mode="social" onclick="vote('social')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="social">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Social Mode</div>
                        <div class="mode-description">Engagement-first. Interactive.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="social">35</span>
                        <span class="vote-label">Votes</span>
                        <div class="vote-percentage-bar">
                            <div class="vote-percentage-fill" data-percentage="social" style="width: 0%"></div>
                        </div>
                        <div class="selection-indicator">Selected</div>
                    </div>
                </div>

                <!-- Battle Mode -->
                <div class="mode-card selectable-card" data-mode="battle" onclick="vote('battle')">
                    <input type="checkbox" class="vote-checkbox-hidden" data-mode="battle">
                    <div class="mode-icon"></div>
                    <div class="mode-info">
                        <div class="mode-name">Battle Mode</div>
                        <div class="mode-description">High stakes. Competitive energy.</div>
                    </div>
                    <div class="mode-votes">
                        <span class="vote-count" data-votes="battle">31</span>
                        <span class="vote-label">Votes</span>
                        <div class="vote-percentage-bar">
                            <div class="vote-percentage-fill" data-percentage="battle" style="width: 0%"></div>
                        </div>
                        <div class="selection-indicator">Selected</div>
                    </div>
                </div>
            </div>

            <!-- Voted Status Indicator (shown after voting) -->
            <div class="voted-status" id="votedStatus">
                <div class="voted-status-icon">‚úì</div>
                <div class="voted-status-text">You Voted This Week</div>
                <div class="voted-status-mode" id="votedStatusMode">Studio Mode</div>
                <div class="voted-status-actions">
                    <button class="voted-status-btn" onclick="openShareModal(userVote)">Share Vote</button>
                    <button class="voted-status-btn" onclick="changeVote()">Change Vote</button>
                </div>
            </div>

            <!-- Submit button removed - voting is now instant on mode card click -->
            
            <!-- Post-Vote Invite Nudge (hidden by default) -->
            <div id="inviteNudge" class="invite-nudge hidden">
                <span>Know someone who'd enjoy this? Invite one person.</span>
                <div class="invite-actions">
                    <button id="inviteFriendBtn" class="invite-btn">Invite</button>
                    <button id="dismissInviteBtn" class="dismiss-btn">Not now</button>
                </div>
            </div>
        </div>
    </section>


    <!-- Friend Tagging Popup (lightweight, appears before share) -->
    <div id="friendTagPopup" class="friend-tag-popup" style="display: none;">
        <div class="friend-tag-content">
            <div class="friend-tag-header">
                <span>Tag Friends (Optional)</span>
                <button class="friend-tag-close" onclick="closeFriendTagPopup()">&times;</button>
            </div>
            <div class="friend-sort-options">
                <button class="friend-sort-btn active" data-sort="random" onclick="window.changeFriendSort('random')">
                    üé≤ Random
                </button>
                <button class="friend-sort-btn" data-sort="recent" onclick="window.changeFriendSort('recent')">
                    üïê Recent
                </button>
                <button class="friend-sort-btn" data-sort="oldest" onclick="window.changeFriendSort('oldest')">
                    ‚è≥ Oldest
                </button>
            </div>
            <div class="friend-tag-grid" id="friendTagGrid">
                <!-- Populated by JS with sorted friends -->
            </div>
            <div class="friend-tag-actions">
                <button class="friend-tag-share-btn" onclick="window.shareWithTags()">
                    Share to Farcaster
                </button>
                <button class="friend-tag-skip-btn" onclick="window.shareWithTags()">
                    Skip
                </button>
            </div>
        </div>
    </div>

    <!-- Farcaster Client Selection Modal -->
    <div class="farcaster-client-modal" id="farcasterClientModal" style="display: none;">
        <div class="farcaster-client-content">
            <button class="modal-close-btn" onclick="closeFarcasterClientModal()" aria-label="Close">&times;</button>
            <h3 class="farcaster-client-title">Which Farcaster client should we focus on?</h3>
            <p class="farcaster-client-subtitle">Choose the client you think is worth aiming for this week</p>
            <div class="farcaster-client-options">
                <button class="farcaster-client-btn" onclick="submitFarcasterWithClient('CURA')">
                    <span class="client-emoji">üîÆ</span>
                    <span class="client-name">CURA</span>
                </button>
                <button class="farcaster-client-btn" onclick="submitFarcasterWithClient('SOPHA')">
                    <span class="client-emoji">üõãÔ∏è</span>
                    <span class="client-name">SOPHA</span>
                </button>
                <button class="farcaster-client-btn" onclick="submitFarcasterWithClient('DEGEN')">
                    <span class="client-emoji">üé©</span>
                    <span class="client-name">DEGEN</span>
                </button>
                <button class="farcaster-client-btn" onclick="submitFarcasterWithClient('BASE')">
                    <span class="client-emoji">üîµ</span>
                    <span class="client-name">BASE</span>
                </button>
                <button class="farcaster-client-btn" onclick="submitFarcasterWithClient('FARCASTER CLIENT')">
                    <span class="client-emoji">üü£</span>
                    <span class="client-name">FARCASTER CLIENT</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Weekly Social Focus Voting -->
    <section class="weekly-focus-section" id="weeklyFocusSection">
        <!-- Lock Overlay (shown when locked) -->
        <div class="weekly-unlock-overlay" id="weeklyUnlockOverlay" style="display: none;">
            <div class="lock-icon"></div>
            <h3>Where We Show Up This Week</h3>
            <p>Vote daily to help decide where we focus.</p>
            <p class="unlock-hint">Vote above to unlock</p>
        </div>
        
        <div class="container">
            <div class="weekly-focus-header">
                <h2>Vote Daily for This Week's Social Focus</h2>
                <p>Cast your vote every day to help decide which platform ZABAL prioritizes this week.</p>
                <p class="weekly-reset-note">Most popular platform by Monday becomes the weekly focus. Resets every Monday.</p>
            </div>
            
            <div class="focus-category">
                <!-- Leader emphasis message (populated dynamically) -->
                <div id="weeklyLeaderMessage" style="text-align: center; margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-gray); display: none;">
                    <!-- Populated by JS when leader exists -->
                </div>
                
                <div class="focus-options" id="socialFocusOptions">
                    <button class="focus-option-btn" onclick="submitWeeklySocialVote('X (Twitter)')">
                        X (Twitter)
                    </button>
                    <button class="focus-option-btn" onclick="showFarcasterClientSelection()">
                        Farcaster
                    </button>
                    <button class="focus-option-btn" onclick="submitWeeklySocialVote('TikTok')">
                        TikTok
                    </button>
                    <button class="focus-option-btn" onclick="submitWeeklySocialVote('YouTube')">
                        YouTube
                    </button>
                    <button class="focus-option-btn" onclick="submitWeeklySocialVote('Instagram')">
                        Instagram
                    </button>
                </div>
                
                <div class="focus-results">
                    <div class="focus-results-title">Live Results</div>
                    <div id="socialFocusResults"></div>
                </div>
                
                <div id="weeklySocialVotedState" class="weekly-voted-state" style="display: none;">
                    <div class="voted-state-text">
                        You're backing <strong id="weeklySocialVotedPlatform"></strong> this week.
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Vote Comments Section -->
    <section class="vote-comments-section" id="voteCommentsSection">
        <div class="container">
            <div class="comments-header">
                <h2>Why Did You Vote?</h2>
                <p>Share your reasoning with the community</p>
            </div>
            
            <!-- Add Comment Form -->
            <div class="add-comment-form" id="addCommentForm">
                <textarea 
                    id="commentInput" 
                    class="comment-textarea" 
                    placeholder="Why did you vote for this mode? (max 500 characters)"
                    maxlength="500"
                ></textarea>
                <div class="comment-form-footer">
                    <span class="char-count" id="charCount">0/500</span>
                    <button class="submit-comment-btn" id="submitCommentBtn" onclick="submitComment()">
                        Post Comment
                    </button>
                </div>
            </div>
            
            <!-- Filter Tabs -->
            <div class="comment-filters">
                <button class="filter-tab active" data-mode="all" onclick="filterComments('all')">
                    All Comments
                </button>
                <button class="filter-tab" data-mode="studio" onclick="filterComments('studio')">
                    üé¨ Studio
                </button>
                <button class="filter-tab" data-mode="market" onclick="filterComments('market')">
                    üõí Market
                </button>
                <button class="filter-tab" data-mode="social" onclick="filterComments('social')">
                    üåê Social
                </button>
                <button class="filter-tab" data-mode="battle" onclick="filterComments('battle')">
                    ‚öîÔ∏è Battle
                </button>
            </div>
            
            <!-- Comments Display -->
            <div class="comments-list" id="commentsList">
                <div class="comments-loading">Loading comments...</div>
            </div>
        </div>
    </section>

    <!-- Currently Winning Share Cards (appear during active voting) -->
    <section class="currently-winning-section" id="currentlyWinningSection" style="display: none;">
        <div class="container">
            <!-- Daily Currently Winning Card (shown during active voting before 5 PM EST) -->
            <div class="currently-winning-card" id="dailyCurrentlyWinningCard" style="display: none;">
                <div class="currently-winning-icon"></div>
                <h3 class="currently-winning-title">Currently Winning</h3>
                <div class="currently-winning-result">
                    <span id="dailyCurrentLeaderName">Studio Mode</span> is leading right now
                </div>
                <p class="currently-winning-cta">Vote before 5 PM EST</p>
                <button class="currently-winning-share-btn" onclick="shareCurrentlyWinning('daily')">
                    Share the Momentum
                </button>
            </div>

            <!-- Weekly Currently Winning Card (shown during active weekly voting) -->
            <div class="currently-winning-card weekly" id="weeklyCurrentlyWinningCard" style="display: none;">
                <div class="currently-winning-icon"></div>
                <h3 class="currently-winning-title">Currently Winning</h3>
                <div class="currently-winning-result">
                    <span id="weeklyCurrentLeaderName">Farcaster</span> is leading the signal this week
                </div>
                <p class="currently-winning-cta">Add your vote</p>
                <button class="currently-winning-share-btn" onclick="shareCurrentlyWinning('weekly')">
                    Share the Momentum
                </button>
            </div>
        </div>
    </section>

    <!-- Winning Vote Share Cards (appear after results are decided) -->
    <section class="winning-share-section" id="winningShareSection" style="display: none;">
        <div class="container">
            <!-- Daily Winning Share Card (shown after 5 PM EST when voting closes) -->
            <div class="winning-share-card" id="dailyWinningCard" style="display: none;">
                <div class="winning-share-icon"></div>
                <h3 class="winning-share-title">Today's stream is set.</h3>
                <div class="winning-share-result">
                    <span id="dailyWinnerName">Studio Mode</span> won
                </div>
                <p class="winning-share-thanks">Thanks to everyone who voted.</p>
                <!-- Voter avatar stack (max 5) -->
                <div class="winning-share-voters" id="dailyVoterAvatars" style="display: none;">
                    <div class="voter-avatar-stack"></div>
                    <span class="voter-count-text"></span>
                </div>
                <button class="winning-share-btn" onclick="shareWinningResult('daily')">
                    Share the Result
                </button>
            </div>

            <!-- Weekly Winning Share Card (shown when there's a leading platform) -->
            <div class="winning-share-card weekly" id="weeklyWinningCard" style="display: none;">
                <div class="winning-share-icon"></div>
                <h3 class="winning-share-title">This week's signal is clear.</h3>
                <div class="winning-share-result">
                    <span id="weeklyWinnerName">Farcaster</span> is where the community showed up
                </div>
                <p class="winning-share-thanks">Appreciate everyone who voted.</p>
                <!-- Voter avatar stack (max 5) -->
                <div class="winning-share-voters" id="weeklyVoterAvatars" style="display: none;">
                    <div class="voter-avatar-stack"></div>
                    <span class="voter-count-text"></span>
                </div>
                <button class="winning-share-btn" onclick="shareWinningResult('weekly')">
                    Share the Result
                </button>
            </div>
        </div>
    </section>

    <!-- Vote History Accordion -->
    <section class="vote-history-accordion-section">
        <div class="container">
            <div class="vote-history-accordion">
                <button class="accordion-header" onclick="toggleVoteHistory()">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <div class="accordion-text">
                            <h3>Recent Voting Activity</h3>
                            <p>See who voted for what over the past week</p>
                        </div>
                    </div>
                    <div class="accordion-toggle">
                        <svg class="chevron-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </button>
                <div class="accordion-content" id="voteHistoryAccordion">
                    <div class="accordion-inner">
                        <div id="voteHistoryTimeline" class="vote-history-timeline">
                            <div class="loading-votes">Loading vote history...</div>
                        </div>
                    </div>
    <section class="stream-history">
        <div class="container">
            <h2 class="section-label" style="text-align: center; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: var(--text-white);">Recent Outcomes</h2>
            <div id="voteHistoryTimeline" class="history-timeline">
                <!-- Populated dynamically by loadVoteHistory() -->
            </div>
        </div>
    </section>

    <!-- Voting Power Stats (Bottom of Page) -->
    <section class="container" style="padding: 40px 20px;">
        <div id="personalStats" class="personal-stats">
            <div class="stats-header" onclick="toggleStatsExpand()" style="cursor: pointer;">
                <span class="stats-summary" id="statsSummary">Your impact: 0 votes cast ¬∑ 1√ó power</span>
                <span class="stats-toggle-icon" id="statsToggleIcon">‚ñº</span>
            </div>
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-item">
                    <span class="stat-value" id="statTotalVotes">0</span>
                    <span class="stat-label">Total Votes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statStreak">0</span>
                    <span class="stat-label">Week Streak</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statFavoriteMode">‚Äî</span>
                    <span class="stat-label">Favorite Mode</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statVotePower">1x</span>
                    <span class="stat-label">Vote Power</span>
                </div>
            </div>
            
            <!-- Vote Power (Simplified) -->
            <div id="votePowerDisplay" class="vote-power-simple">
                <span class="power-label">Your vote power:</span>
                <span id="simplePowerValue" class="power-value">1.0√ó</span>
                <span class="power-hint">Based on community activity</span>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p class="footer-brand">ZABAL is a live coordination layer for creators.</p>
            <div class="footer-links">
                <a href="https://zao.xyz" target="_blank">ZAO</a>
                <a href="https://zabal.xyz" target="_blank">ZABAL</a>
                <a href="https://wavewarz.xyz" target="_blank">WaveWarZ</a>
                <a href="https://bettercallzaal.com" target="_blank">BetterCallZaal</a>
            </div>
            <p class="footer-tagline">Built for the ZABAL network of creators.</p>
        </div>
    </footer>

    <script>
        // Stream State Management
        const StreamState = {
            DECIDING: 'deciding',
            LOCKED: 'locked',
            LIVE: 'live'
        };

        let currentState = StreamState.DECIDING;
        
        // Helper: Get current date in EST timezone
        function getESTDate() {
            const now = new Date();
            // Convert to EST (UTC-5)
            const estOffset = -5 * 60; // EST offset in minutes
            return new Date(now.getTime() + (now.getTimezoneOffset() + estOffset) * 60000);
        }
        
        // Helper: Get vote date string (resets at 5 PM EST)
        function getVoteDate() {
            const estNow = getESTDate();
            
            // If before 5 PM EST, use previous day's date
            if (estNow.getHours() < 17) {
                estNow.setDate(estNow.getDate() - 1);
            }
            
            return estNow.toISOString().split('T')[0];
        }
        
        // Calculate lock time: Today at 5 PM EST (resets daily)
        function calculateLockTime() {
            const estNow = getESTDate();
            const now = new Date();
            
            // Set to today 5 PM EST
            const lockTimeEST = new Date(estNow);
            lockTimeEST.setHours(17, 0, 0, 0);
            
            // If already past 5 PM EST today, set to tomorrow 5 PM EST
            if (estNow.getHours() >= 17) {
                lockTimeEST.setDate(lockTimeEST.getDate() + 1);
            }
            
            // Convert back to local time
            const estOffset = -5 * 60;
            return new Date(lockTimeEST.getTime() - (now.getTimezoneOffset() + estOffset) * 60000);
        }
        
        let lockTime = calculateLockTime();

        // Update hero based on state
        function updateHeroState() {
            const heroState = document.getElementById('heroState');
            const heroTitle = document.getElementById('heroTitle');
            const heroSubtitle = document.getElementById('heroSubtitle');
            const heroCTA = document.getElementById('heroCTA');
            const countdown = document.getElementById('countdown');

            if (currentState === StreamState.DECIDING) {
                heroState.textContent = 'Voting Open';
                heroState.className = 'hero-state deciding';
                heroTitle.textContent = "You're Picking Today's Stream";
                heroSubtitle.textContent = "Your vote determines what Zaal builds live today.";
                // CTA removed
                countdown.style.display = 'inline-flex';
            } else if (currentState === StreamState.LOCKED) {
                heroState.textContent = 'Voting Closed';
                heroState.className = 'hero-state locked';
                const leader = getLeader();
                const modeName = document.querySelector(`[data-mode="${leader}"] .mode-name`).textContent;
                heroTitle.textContent = `Winner: ${modeName}`;
                heroSubtitle.textContent = `The community chose ${modeName}. Results locked at 5 PM EST.`;
                heroCTA.textContent = 'See Results';
                heroCTA.href = '#wheel';
                countdown.style.display = 'inline-flex';
            } else if (currentState === StreamState.LIVE) {
                heroState.textContent = 'Live Now';
                heroState.className = 'hero-state live';
                const leader = getLeader();
                const modeName = document.querySelector(`[data-mode="${leader}"] .mode-name`).textContent;
                heroTitle.textContent = `${modeName} ‚Äî Live`;
                heroSubtitle.textContent = "Join the stream. Watch us build.";
                heroCTA.textContent = 'Join Stream';
                heroCTA.href = 'https://twitch.tv/bettercallzaal';
                heroCTA.target = '_blank';
                countdown.style.display = 'none';
            }
        }

        // Countdown timer
        function updateCountdown() {
            const now = new Date();
            const diff = lockTime - now;

            if (diff <= 0) {
                currentState = StreamState.LOCKED;
                updateHeroState();
                // Show winning share card when voting closes
                updateDailyWinningCard();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const countdownTime = document.getElementById('countdownTime');
            countdownTime.textContent = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // VISUAL CHANGE 3: Apply urgency classes to countdown
            const countdownEl = document.getElementById('countdown');
            if (countdownEl) {
                const totalMinutes = hours * 60 + minutes;
                countdownEl.classList.remove('urgent-1hr', 'urgent-15min');
                
                if (totalMinutes < 15) {
                    countdownEl.classList.add('urgent-15min');
                    console.log('‚è∞ [URGENCY] <15 minutes remaining - RED ALERT');
                } else if (totalMinutes < 60) {
                    countdownEl.classList.add('urgent-1hr');
                    console.log('‚è∞ [URGENCY] <1 hour remaining - ORANGE WARNING');
                }
            }
        }

        /* ==============================================
           UI HELPERS & UTILITIES
        ============================================== */

        // ============================================
        // COLLAPSIBLE HEADER UTILITY
        // Defaults to collapsed, user can expand manually
        // Remembers user preference via sessionStorage
        // ============================================
        
        let headerCollapsed = true; // Default collapsed
        
        // Toggle header between expanded/collapsed
        function toggleHeader() {
            const header = document.getElementById('mainHeader');
            if (!header) return;
            
            headerCollapsed = !headerCollapsed;
            
            if (headerCollapsed) {
                header.classList.remove('expanded');
                header.classList.add('collapsed');
                sessionStorage.setItem('headerState', 'collapsed');
            } else {
                header.classList.remove('collapsed');
                header.classList.add('expanded');
                sessionStorage.setItem('headerState', 'expanded');
            }
        }
        
        // Initialize header state on page load
        function initHeaderState() {
            const header = document.getElementById('mainHeader');
            if (!header) return;
            
            // Check if user has a saved preference for this session
            const savedState = sessionStorage.getItem('headerState');
            
            if (savedState === 'expanded') {
                // User manually expanded it before, respect that
                headerCollapsed = false;
                header.classList.remove('collapsed');
                header.classList.add('expanded');
            } else {
                // Default: collapsed
                headerCollapsed = true;
                header.classList.remove('expanded');
                header.classList.add('collapsed');
            }
        }
        
        // Initialize header on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            initHeaderState();
        });
        
        // ============================================
        // END COLLAPSIBLE HEADER UTILITY
        // ============================================

        // ============================================
        // WINNING VOTE SHARE CARDS
        // Shows celebration card after results are decided
        // Daily: after 5 PM EST when voting closes
        // Weekly: when there's a leading platform
        // ============================================
        
        // Track current winning states
        let dailyWinner = null;
        let weeklyWinner = null;
        let dailyTopVoters = []; // Max 5 voters to tag
        let weeklyTopVoters = []; // Max 5 voters to tag
        
        // ============================================
        // DAILY VOTING PHASE - SINGLE SOURCE OF TRUTH
        // Centralizes all time-based voting logic
        // ============================================
        
        // Dev hooks for testing (only active when explicitly set)
        window.__ZABAL_DEV__ = window.__ZABAL_DEV__ || {
            forceDailyPhase: null, // 'active' | 'closed'
            forceLeader: null
        };
        
        // Get current daily voting phase (single authority for time logic)
        function getDailyVotingPhase(now = new Date()) {
            // Dev override (testing only)
            if (window.__ZABAL_DEV__.forceDailyPhase) {
                const forced = window.__ZABAL_DEV__.forceDailyPhase;
                return {
                    phase: forced === 'active' ? 'active' : 'closed',
                    isActive: forced === 'active',
                    isClosed: forced === 'closed',
                    closesAt: forced === 'active' ? calculateLockTime() : null,
                    timezone: 'EST'
                };
            }
            
            const estNow = getESTDate(now);
            const isClosed = estNow.getHours() >= 17; // 5 PM EST or later
            
            return {
                phase: isClosed ? 'closed' : 'active',
                isActive: !isClosed,
                isClosed: isClosed,
                closesAt: isClosed ? null : calculateLockTime(),
                timezone: 'EST'
            };
        }
        
        // Legacy wrapper (keep for backwards compatibility during migration)
        function isDailyVotingClosed() {
            return getDailyVotingPhase().isClosed;
        }
        
        // Update daily winning share card visibility
        function updateDailyWinningCard() {
            const section = document.getElementById('winningShareSection');
            const card = document.getElementById('dailyWinningCard');
            const winnerNameEl = document.getElementById('dailyWinnerName');
            
            if (!section || !card || !winnerNameEl) return;
            
            // Only show if voting is closed AND we have a clear winner
            if (isDailyVotingClosed() && currentState === StreamState.LOCKED) {
                const leader = getLeader();
                if (leader && votes[leader] > 0) {
                    // Get the mode display name
                    const modeEl = document.querySelector(`[data-mode="${leader}"] .mode-name`);
                    const modeName = modeEl ? modeEl.textContent : leader;
                    
                    dailyWinner = modeName;
                    winnerNameEl.textContent = modeName;
                    
                    card.style.display = 'block';
                    section.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            } else {
                card.style.display = 'none';
                dailyWinner = null;
            }
            
            // Check if any card should be visible
            checkWinningSectionVisibility();
        }
        
        // Update weekly winning share card visibility
        function updateWeeklyWinningCard(leadingPlatform, voterCount) {
            const section = document.getElementById('winningShareSection');
            const card = document.getElementById('weeklyWinningCard');
            const winnerNameEl = document.getElementById('weeklyWinnerName');
            
            if (!section || !card || !winnerNameEl) return;
            
            // Show if there's a leading platform with votes
            if (leadingPlatform && voterCount > 0) {
                weeklyWinner = leadingPlatform;
                winnerNameEl.textContent = leadingPlatform;
                
                card.style.display = 'block';
                section.style.display = 'block';
            } else {
                card.style.display = 'none';
                weeklyWinner = null;
            }
            
            // Check if any card should be visible
            checkWinningSectionVisibility();
        }
        
        // Check if the winning share section should be visible
        function checkWinningSectionVisibility() {
            const section = document.getElementById('winningShareSection');
            const dailyCard = document.getElementById('dailyWinningCard');
            const weeklyCard = document.getElementById('weeklyWinningCard');
            
            if (!section) return;
            
            // Show section if either card is visible
            const dailyVisible = dailyCard && dailyCard.style.display !== 'none';
            const weeklyVisible = weeklyCard && weeklyCard.style.display !== 'none';
            
            section.style.display = (dailyVisible || weeklyVisible) ? 'block' : 'none';
        }
        
        // ============================================
        // CURRENTLY WINNING SHARE CARDS
        // Shows live momentum during active voting
        // ============================================
        
        // Get current leader from results (returns null if tie or no votes)
        function getCurrentLeader(results) {
            if (!results || Object.keys(results).length === 0) return null;
            
            const entries = Object.entries(results);
            if (entries.length === 0) return null;
            
            // Find max votes
            const maxVotes = Math.max(...entries.map(([_, count]) => count));
            
            // No votes yet
            if (maxVotes === 0) return null;
            
            // Check for tie
            const leaders = entries.filter(([_, count]) => count === maxVotes);
            if (leaders.length > 1) return null; // Tie - don't show
            
            return {
                label: leaders[0][0],
                votes: leaders[0][1]
            };
        }
        
        // Update daily currently winning card (during active voting)
        function updateDailyCurrentlyWinningCard() {
            const section = document.getElementById('currentlyWinningSection');
            const card = document.getElementById('dailyCurrentlyWinningCard');
            const leaderNameEl = document.getElementById('dailyCurrentLeaderName');
            
            if (!section || !card || !leaderNameEl) return;
            
            // Only show during active voting (NOT after 5 PM EST)
            if (!isDailyVotingClosed() && currentState !== StreamState.LOCKED) {
                const leader = getCurrentLeader(votes);
                
                if (leader && leader.votes > 0) {
                    // Get the mode display name
                    const modeEl = document.querySelector(`[data-mode="${leader.label}"] .mode-name`);
                    const modeName = modeEl ? modeEl.textContent : leader.label;
                    
                    leaderNameEl.textContent = modeName;
                    card.style.display = 'block';
                    section.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            } else {
                // Voting closed - hide currently winning, show final winner instead
                card.style.display = 'none';
            }
            
            // Check if section should be visible
            checkCurrentlyWinningSectionVisibility();
        }
        
        // Update weekly currently winning card (during active voting)
        function updateWeeklyCurrentlyWinningCard(leadingPlatform, voterCount) {
            const section = document.getElementById('currentlyWinningSection');
            const card = document.getElementById('weeklyCurrentlyWinningCard');
            const leaderNameEl = document.getElementById('weeklyCurrentLeaderName');
            
            if (!section || !card || !leaderNameEl) return;
            
            // Show if there's a leading platform with votes (and no tie)
            if (leadingPlatform && voterCount > 0) {
                leaderNameEl.textContent = leadingPlatform;
                card.style.display = 'block';
                section.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
            
            // Check if section should be visible
            checkCurrentlyWinningSectionVisibility();
        }
        
        // Check if currently winning section should be visible
        function checkCurrentlyWinningSectionVisibility() {
            const section = document.getElementById('currentlyWinningSection');
            const dailyCard = document.getElementById('dailyCurrentlyWinningCard');
            const weeklyCard = document.getElementById('weeklyCurrentlyWinningCard');
            
            if (!section) return;
            
            // Show section if either card is visible
            const dailyVisible = dailyCard && dailyCard.style.display !== 'none';
            const weeklyVisible = weeklyCard && weeklyCard.style.display !== 'none';
            
            section.style.display = (dailyVisible || weeklyVisible) ? 'block' : 'none';
        }
        
        // Share currently winning result - opens Farcaster compose
        function shareCurrentlyWinning(type) {
            
            let context = {};
            
            if (type === 'daily') {
                const leader = getCurrentLeader(votes);
                if (!leader) return;
                
                const modeEl = document.querySelector(`[data-mode="${leader.label}"] .mode-name`);
                const modeName = modeEl ? modeEl.textContent : leader.label;
                
                context = {
                    winnerName: modeName,
                    winnerRef: leader.label,
                    voteType: 'daily',
                    topVoters: []
                };
            } else if (type === 'weekly') {
                const leaderNameEl = document.getElementById('weeklyCurrentLeaderName');
                if (!leaderNameEl) return;
                
                const platform = leaderNameEl.textContent;
                
                context = {
                    winnerName: platform,
                    winnerRef: platform.toLowerCase(),
                    voteType: 'weekly',
                    topVoters: []
                };
            }
            
            const payload = buildSharePayload('currently_winning', context);
            if (!payload) return;
            
            openWinningShareModal(payload.text, payload.mentions, type, payload.contextParam);
        }
        
        // ============================================
        // END CURRENTLY WINNING SHARE CARDS
        // ============================================
        
        // Share the winning result - opens share modal with pre-built copy
        function shareWinningResult(type) {
            
            if (type === 'daily' && dailyWinner) {
                const payload = buildSharePayload('daily_winner', {
                    winnerName: dailyWinner,
                    topVoters: dailyTopVoters
                });
                
                if (!payload) return;
                openWinningShareModal(payload.text, payload.mentions, 'daily');
                
            } else if (type === 'weekly' && weeklyWinner) {
                const payload = buildSharePayload('weekly_winner', {
                    winnerName: weeklyWinner,
                    topVoters: weeklyTopVoters
                });
                
                if (!payload) return;
                openWinningShareModal(payload.text, payload.mentions, 'weekly');
            }
        }
        
        // Open share modal specifically for winning result shares
        async function openWinningShareModal(shareCopy, topVoters, type, contextParam = null) {
            // Build friend tags from top voters (max 5)
            const friendTags = topVoters.slice(0, 5).map(voter => {
                if (typeof voter === 'string') return `@${voter}`;
                return voter.username ? `@${voter.username}` : '';
            }).filter(tag => tag).join(' ');
            
            const finalCast = friendTags ? `${shareCopy}\n\n${friendTags}` : shareCopy;
            
            // Use custom context param if provided, otherwise default
            const embedUrl = contextParam ? MINIAPP_URL + contextParam : MINIAPP_URL + '?source=winning-share&type=' + type;
            
            try {
                // Use Farcaster SDK to compose cast
                if (window.farcasterSDK && window.farcasterSDK.actions) {
                    await window.farcasterSDK.actions.composeCast({
                        text: finalCast,
                        embeds: [embedUrl],
                        channelKey: 'zao'
                    });
                } else {
                    // Fallback: copy to clipboard
                    await navigator.clipboard.writeText(finalCast);
                    showToast('success', 'Copied!', 'Share text copied to clipboard');
                }
            } catch (error) {
                log.error('winning-share:failed', error);
                // Fallback: copy to clipboard
                try {
                    await navigator.clipboard.writeText(finalCast);
                    showToast('info', 'Copied!', 'Share text copied to clipboard');
                } catch (e) {
                    showToast('error', 'Share Failed', 'Could not share. Please try again.');
                }
            }
        }
        
        // ============================================
        // END WINNING VOTE SHARE CARDS
        // ============================================

        // Toast Notification System
        function showToast(type, title, message, duration = 4000, callback = null) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: 'üí°'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.setProperty('--duration', `${duration}ms`);
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'üí°'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Close notification">√ó</button>
                <div class="toast-progress"></div>
            `;

            container.appendChild(toast);

            // Execute callback after toast is shown
            if (callback && typeof callback === 'function') {
                setTimeout(callback, 500);
            }

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        /* ==============================================
           LOGGING UTILITY
        ============================================== */

        // Lightweight logger - production-silent happy paths
        const log = {
            debug: (...args) => {
                if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                    console.debug('[ZABAL]', ...args);
                }
            },
            warn: (...args) => console.warn('[ZABAL]', ...args),
            error: (...args) => console.error('[ZABAL]', ...args)
        };

        // Global error handler
        window.addEventListener('error', (e) => {
            log.error('unhandled', e.error || e.message);
        });

        /* ==============================================
           DATABASE & AUTHENTICATION
        ============================================== */

        // Initialize Supabase using config
        
        let supabase;
        let systemReady = false;
        
        // Show system status message (for critical failures)
        function showSystemStatus(title, message) {
            const statusEl = document.getElementById('systemStatusMessage');
            if (statusEl) {
                statusEl.querySelector('.status-title').textContent = title;
                statusEl.querySelector('.status-message').textContent = message;
                statusEl.style.display = 'flex';
            }
        }
        
        // Hide system status message
        function hideSystemStatus() {
            const statusEl = document.getElementById('systemStatusMessage');
            if (statusEl) {
                statusEl.style.display = 'none';
            }
        }
        
        // Disable voting UI until system is ready
        function disableVotingUI(reason) {
            const submitBtn = document.getElementById('submitVotesBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const modeCards = document.querySelectorAll('.mode-card');
            const votedStatus = document.getElementById('votedStatus');
            
            if (submitBtn && submitBtnText) {
                submitBtn.disabled = true;
                submitBtnText.textContent = reason || 'System unavailable';
            }
            
            modeCards.forEach(card => {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            });
            
            // Hide voted status if shown
            if (votedStatus) {
                votedStatus.style.display = 'none';
            }
            
            // Show inline system status
            showSystemStatus('System Unavailable', reason || 'Voting is temporarily disabled. Please refresh the page.');
        }
        
        // Enable voting UI when system is ready
        function enableVotingUI() {
            const modeCards = document.querySelectorAll('.mode-card');
            
            modeCards.forEach(card => {
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
            });
            
            hideSystemStatus();
            systemReady = true;
        }
        
        // Offline detection and handling
        let isOffline = false;
        
        function handleOffline() {
            isOffline = true;
            const banner = document.getElementById('offlineBanner');
            if (banner) banner.classList.add('show');
            
            // Disable voting UI
            disableVotingUI('You are offline. Voting requires an internet connection.');
            
            console.log('üì° User went offline - voting disabled');
        }
        
        function handleOnline() {
            isOffline = false;
            const banner = document.getElementById('offlineBanner');
            if (banner) banner.classList.remove('show');
            
            // Re-enable voting UI if system is ready
            if (systemReady && supabase) {
                enableVotingUI();
            }
            
            console.log('üì° User back online - checking system status');
            
            // Reload votes to ensure fresh data
            loadVotes();
        }
        
        // Check if user is offline before vote attempts
        function checkOnlineStatus() {
            if (!navigator.onLine) {
                handleOffline();
                return false;
            }
            return true;
        }
        
        try {
            if (!window.supabase) {
                console.error('‚ùå Supabase library not loaded');
                showToast('error', 'Database Error', 'Connection failed. Please refresh the page.');
                disableVotingUI('Database unavailable');
            } else if (!window.appConfig) {
                console.error('‚ùå App configuration not loaded');
                showToast('error', 'Configuration Error', 'App not configured. Please refresh the page.');
                disableVotingUI('System not configured');
            } else {
                supabase = window.supabase.createClient(
                    window.appConfig.SUPABASE_URL,
                    window.appConfig.SUPABASE_ANON_KEY
                );
                console.log('‚úÖ Supabase client initialized');
                systemReady = true;
            }
        } catch (err) {
            console.error('‚ùå Error initializing Supabase:', err);
            window.errorHandler?.handleError(err, { type: 'database_error', context: 'initialization' });
            showToast('error', 'Database Error', 'Could not connect to database.');
            disableVotingUI('Connection failed');
        }

        // Get Farcaster user context
        let userFID = null;
        let username = null;
        let isAuthenticated = false;
        let userVotePower = 1; // Cache user's vote power

        async function initializeFarcaster() {
            console.log('üîê Initializing Farcaster authentication...');
            
            // Wait for SDK to be ready
            if (!window.farcasterSDK) {
                await new Promise(resolve => {
                    window.addEventListener('farcasterSDKReady', resolve, { once: true });
                    // Fallback timeout
                    setTimeout(resolve, 2000);
                });
            }
            
            try {
                if (window.farcasterSDK) {
                    // CRITICAL: Call ready() FIRST to dismiss splash screen
                    // This should happen before any data loading or auth
                    try {
                        await window.farcasterSDK.actions.ready();
                        console.log('‚úÖ Splash screen dismissed via SDK');
                    } catch (readyErr) {
                        console.warn('‚ö†Ô∏è ready() call failed:', readyErr);
                    }
                    
                    // Access context - it's a Proxy that needs to be awaited
                    const context = await window.farcasterSDK.context;
                    
                    if (context && context.user) {
                        userFID = context.user.fid;
                        username = context.user.username || 'User';
                        isAuthenticated = true;
                        
                        console.log('‚úÖ Farcaster user authenticated:', { fid: userFID, username, user: context.user });
                        
                        // Store in StateManager
                        window.StateManager?.batch({
                            'auth.isAuthenticated': true,
                            'auth.fid': userFID,
                            'auth.username': username,
                            'auth.displayName': context.user.displayName || username,
                            'auth.pfpUrl': context.user.pfpUrl || null,
                            'auth.bio': context.user.bio || null
                        });
                        
                        // Show enhanced user profile in header
                        const userProfileEl = document.getElementById('userProfile');
                        const userNameEl = document.getElementById('userName');
                        const userPfpEl = document.getElementById('userPfp');
                        const userFidEl = document.getElementById('userFidDisplay');
                        const verifiedBadgeEl = document.getElementById('verifiedBadge');
                        
                        if (userProfileEl && userNameEl) {
                            // Use displayName if available, otherwise username
                            const displayText = context.user.displayName || `@${username}`;
                            userNameEl.textContent = displayText;
                            userFidEl.textContent = `@${username}`;
                            
                            // Set profile picture if available
                            if (context.user.pfpUrl) {
                                userPfpEl.src = context.user.pfpUrl;
                                userPfpEl.style.display = 'block';
                                userPfpEl.onerror = () => {
                                    userPfpEl.style.display = 'none';
                                    console.warn('‚ö†Ô∏è Failed to load profile picture');
                                };
                            }
                            
                            // Show verification badge if user has it
                            if (context.user.verified || context.user.verifications?.length > 0) {
                                verifiedBadgeEl.style.display = 'inline';
                            }
                            
                            // Make profile visible
                            userProfileEl.style.display = 'flex';
                            console.log('‚úÖ User profile displayed:', displayText);
                        }
                        
                        // Show personal stats and load user data (async, after ready())
                        loadPersonalStats();
                        
                        // Load best friends data (async, after ready())
                        loadBestFriends(userFID);
                    } else {
                        console.warn('‚ö†Ô∏è No Farcaster user context found');
                        throw new Error('Not in Farcaster context');
                    }
                } else {
                    console.warn('‚ö†Ô∏è Farcaster SDK not available');
                    throw new Error('Farcaster SDK not available');
                }
            } catch (err) {
                console.log('‚ÑπÔ∏è Not running in Farcaster, using fallback FID');
                // Fallback for testing outside Farcaster
                userFID = localStorage.getItem('userFID') || Math.floor(Math.random() * 1000000);
                localStorage.setItem('userFID', userFID);
                username = 'Test User';
                isAuthenticated = false;
            }
            
            console.log('üë§ User FID:', userFID, '| Username:', username, '| Authenticated:', isAuthenticated);
        }
        
        let userVote = null;
        const votes = {
            studio: 0,
            market: 0,
            social: 0,
            battle: 0
        };

        // Cache for user data to avoid repeated API calls
        const userDataCache = {};

        // Fetch user data from Neynar
        async function fetchUserData(fids) {
            if (!fids || fids.length === 0) return {};
            
            // Filter out already cached FIDs
            const uncachedFids = fids.filter(fid => !userDataCache[fid]);
            
            if (uncachedFids.length === 0) {
                return userDataCache;
            }
            
            try {
                const fidsParam = uncachedFids.join(',');
                const data = await callNeynarAPI('user/bulk', { fids: fidsParam });
                
                if (data.users) {
                    data.users.forEach(user => {
                        userDataCache[user.fid] = {
                            username: user.username,
                            display_name: user.display_name,
                            pfp_url: user.pfp_url
                        };
                    });
                }
            } catch (error) {
                console.error('‚ùå Error fetching user data:', error);
            }
            
            return userDataCache;
        }

        // Load vote history for past 7 days
        async function loadVoteHistory() {
            console.log('üìú Loading vote history...');
            
            if (!supabase) {
                console.warn('‚ö†Ô∏è Supabase not initialized');
                return;
            }
            
            try {
                // Get votes from past 7 days
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const { data: votes, error } = await supabase
                    .from('votes')
                    .select('fid, username, mode, vote_power, vote_date')
                    .gte('vote_date', sevenDaysAgo.toISOString().split('T')[0])
                    .order('vote_date', { ascending: false });
                
                if (error) {
                    console.error('‚ùå Error loading vote history:', error);
                    return;
                }
                
                console.log('üì• Vote history loaded:', votes);
                
                // Get unique FIDs
                const uniqueFids = [...new Set(votes.map(v => v.fid))];
                
                // Fetch user data for all voters
                await fetchUserData(uniqueFids);
                
                displayVoteHistory(votes);
                
            } catch (err) {
                console.error('‚ùå Exception loading vote history:', err);
            }
        }

        // Display vote history timeline
        function displayVoteHistory(votes) {
            const timeline = document.getElementById('voteHistoryTimeline');
            if (!timeline) return;
            
            if (!votes || votes.length === 0) {
                timeline.innerHTML = '<div class="no-history">No voting history yet. Be the first to vote!</div>';
                return;
            }
            
            // Group votes by date
            const votesByDate = {};
            votes.forEach(vote => {
                const date = vote.vote_date;
                if (!votesByDate[date]) {
                    votesByDate[date] = [];
                }
                votesByDate[date].push(vote);
            });
            
            const modeEmojis = {
                studio: '',
                market: '',
                social: '',
                battle: ''
            };
            
            const modeNames = {
                studio: 'Studio',
                market: 'Market',
                social: 'Social',
                battle: 'Battle'
            };
            
            // Build timeline HTML
            let html = '';
            Object.keys(votesByDate).sort().reverse().forEach(date => {
                const dayVotes = votesByDate[date];
                
                // Calculate totals per mode
                const modeTotals = {
                    studio: 0,
                    market: 0,
                    social: 0,
                    battle: 0
                };
                
                dayVotes.forEach(vote => {
                    modeTotals[vote.mode] += vote.vote_power || 1;
                });
                
                // Find winner
                const winner = Object.keys(modeTotals).reduce((a, b) => 
                    modeTotals[a] > modeTotals[b] ? a : b
                );
                
                // Format date (use EST timezone for consistency)
                const dateObj = new Date(date + 'T00:00:00');
                const estNow = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
                const estToday = new Date(estNow.getFullYear(), estNow.getMonth(), estNow.getDate());
                const estYesterday = new Date(estToday.getTime() - 86400000);
                
                const isToday = dateObj.toDateString() === estToday.toDateString();
                const isYesterday = dateObj.toDateString() === estYesterday.toDateString();
                
                let dateLabel = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                if (isToday) dateLabel = 'Today - ' + dateLabel;
                else if (isYesterday) dateLabel = 'Yesterday - ' + dateLabel;
                
                html += `
                    <div class="vote-day-card">
                        <div class="vote-day-header">
                            <div class="vote-day-date">${dateLabel}</div>
                            <div class="vote-day-winner">
                                <span>Winner:</span>
                                <span class="winner-badge">${modeEmojis[winner]} ${modeNames[winner]}</span>
                            </div>
                        </div>
                        
                        <div class="vote-day-stats">
                            ${Object.keys(modeTotals).map(mode => `
                                <div class="mode-stat">
                                    <div class="mode-stat-icon">${modeEmojis[mode]}</div>
                                    <div class="mode-stat-info">
                                        <div class="mode-stat-name">${modeNames[mode]}</div>
                                        <div class="mode-stat-votes">${modeTotals[mode]} vote${modeTotals[mode] !== 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="vote-day-voters">
                            <div class="voters-header">${[...new Map(dayVotes.map(vote => [vote.fid, vote])).values()].length} voters</div>
                            <div class="voters-list">
                                ${[...new Map(dayVotes.map(vote => [vote.fid, vote])).values()].map(vote => {
                                    const userData = userDataCache[vote.fid];
                                    const username = userData?.username || vote.username || `fid:${vote.fid}`;
                                    const pfpUrl = userData?.pfp_url || '';
                                    const warpcastUrl = `https://warpcast.com/${username.replace('fid:', '')}`;
                                    
                                    // Get all modes this user voted for on this day
                                    const userVotes = dayVotes.filter(v => v.fid === vote.fid);
                                    const modes = [...new Set(userVotes.map(v => v.mode))];
                                    
                                    return `
                                        <a href="${warpcastUrl}" target="_blank" class="voter-tag">
                                            ${pfpUrl ? `<img src="${pfpUrl}" class="voter-pfp" alt="${username}">` : ''}
                                            <span class="voter-mode-icon">${modes.map(m => modeEmojis[m]).join('')}</span>
                                            <span class="voter-username">@${username}</span>
                                        </a>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            timeline.innerHTML = html;
        }

// Realtime subscription for vote updates
let voteSubscription = null;

// Subscribe to real-time vote updates
function subscribeToVoteUpdates() {
    if (!supabase) {
        console.warn('‚ö†Ô∏è [REALTIME] Supabase not initialized, cannot subscribe');
        return;
    }

    // Remove existing subscription if any
    if (voteSubscription) {
        supabase.removeChannel(voteSubscription);
    }

    console.log('üì° [REALTIME] Subscribing to vote updates...');

    // Subscribe to broadcast channel for vote updates
    voteSubscription = supabase
        .channel('vote-updates')
        .on('broadcast', { event: 'vote-change' }, (payload) => {
            console.log('üîî [REALTIME] Vote update received:', payload);
            // Reload votes when any vote changes
            loadVotes();
        })
        .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
                console.log('‚úÖ [REALTIME] Subscribed to vote updates');
            } else if (status === 'CHANNEL_ERROR') {
                console.error('‚ùå [REALTIME] Channel error, retrying...');
                setTimeout(subscribeToVoteUpdates, 5000);
            } else if (status === 'TIMED_OUT') {
                console.error('‚ùå [REALTIME] Subscription timed out, retrying...');
                setTimeout(subscribeToVoteUpdates, 5000);
            }
        });
}

// Load votes from database
async function loadVotes() {
    if (!supabase) {
        return;
    }
    try {
        // Fetch aggregated vote counts from RPC
        const { data, error } = await supabase
            .rpc('get_this_weeks_votes');
        
        if (error) {
            log.error('loadVotes:rpc-failed', error);
            return;
        }
        
        // Reset votes
        votes.studio = 0;
        votes.market = 0;
        votes.social = 0;
        votes.battle = 0;
        
        // Update with database values
        if (data) {
            data.forEach(row => {
                votes[row.mode] = parseInt(row.vote_count) || 0;
            });
        }
        
        // Check if user has voted this week
        const { data: userVoteData, error: voteError } = await supabase
            .rpc('has_voted_this_week', { user_fid: parseInt(userFID) });
        
        if (voteError) {
            log.error('loadVotes:check-vote-failed', voteError);
        } else if (userVoteData) {
            if (userVoteData === true) {
                const { data: voteData } = await supabase
                    .from('votes')
                    .select('mode')
                    .eq('fid', parseInt(userFID))
                    .gte('voted_at', getCurrentWeekMonday())
                    .order('voted_at', { ascending: false })
                    .limit(1)
                    .single();
                
                if (voteData) {
                    userVote = voteData.mode;
                    showVotedStatus(voteData.mode);
                }
            }
        }
        
        updateVotes();
        updateLeader();
        updatePercentageBars();
        updateDailyCurrentlyWinningCard();
        
    } catch (err) {
        log.error('loadVotes:exception', err);
    }
}

        /* ==============================================
           WEEKLY VOTING LOGIC (Monday 5pm ET)
        ============================================== */

        // Vote function with database - exposed to global scope for onclick handlers
        // skipModal parameter prevents opening share modal (used when called from submitVotes)
        window.vote = async function(mode, skipModal = false) {
            console.log('üó≥Ô∏è Vote button clicked for mode:', mode);
            
            // Check online status first
            if (!checkOnlineStatus()) {
                console.log('‚ùå Vote blocked - user is offline');
                return;
            }
            
            // Validate input
            try {
                mode = window.Validator.validateMode(mode);
            } catch (error) {
                console.error('‚ùå Invalid mode:', error.message);
                showToast('error', 'Invalid Vote', error.message);
                window.errorHandler?.handleError(error, { type: 'validation_error', context: 'vote' });
                return;
            }
            
            
            if (!isAuthenticated) {
                console.error('‚ùå Not authenticated');
                showToast('info', 'Farcaster Required', 'Open this page in Warpcast or another Farcaster client to vote and participate!');
                window.analytics?.trackUserAction('vote_failed', { reason: 'not_authenticated', mode });
                return;
            }
            
            if (!supabase) {
                console.error('‚ùå Supabase not initialized');
                showToast('error', 'Database Error', 'Database not connected. Please refresh the page.');
                window.analytics?.trackUserAction('vote_failed', { reason: 'no_supabase', mode });
                return;
            }
            
            if (currentState !== StreamState.DECIDING) {
                console.warn('‚ö†Ô∏è Voting blocked - state is not DECIDING');
                showToast('info', 'Voting Closed', 'Stream is currently locked or live.');
                window.analytics?.trackUserAction('vote_failed', { reason: 'voting_closed', mode });
                return;
            }

            console.log('‚úÖ Voting allowed - state is DECIDING');
            
            // OPTIMISTIC UI UPDATE - Update immediately for instant feedback
            const previousVote = userVote;
            const oldVoteCount = votes[mode];
            
            // If user is changing vote, decrement old mode
            if (previousVote && previousVote !== mode && votes[previousVote] > 0) {
                votes[previousVote]--;
            }
            
            // Increment new mode (or keep same if re-voting)
            if (!previousVote || previousVote !== mode) {
                votes[mode]++;
            }
            
            // Update userVote immediately
            userVote = mode;
            
            // Update UI instantly
            updateVotes();
            updateLeader();
            updatePercentageBars();
            updateDailyCurrentlyWinningCard();
            
            console.log('‚ö° Optimistic UI update complete');
            
            // Show loading state
            window.loadingManager?.show('vote', 'Submitting your vote...');
            
            try {
                // Validate FID before database operation
                const validatedFID = window.Validator.validateFID(userFID);
                
                // Calculate vote power SERVER-SIDE via serverless function
                let votePowerData;
                try {
                    const vpResponse = await fetch(`/api/calculate-vote-power?fid=${validatedFID}`);
                    if (vpResponse.ok) {
                        votePowerData = await vpResponse.json();
                        
                        // Cache the result in database
                        await supabase.rpc('update_vote_power_cache', {
                            p_fid: validatedFID,
                            p_vote_power: votePowerData.power,
                            p_zao_casts: votePowerData.zaoCasts,
                            p_neynar_score: votePowerData.neynarScore
                        });
                    } else {
                        console.warn('‚ö†Ô∏è [DAILY VOTE] Vote power calculation failed, using default');
                        votePowerData = { power: 1 };
                    }
                } catch (vpError) {
                    console.error('‚ùå [DAILY VOTE] Vote power error:', vpError);
                    votePowerData = { power: 1 };
                }
                
                // Call UPSERT RPC for weekly voting (vote_power read from cache server-side)
                const { data, error } = await supabase.rpc('upsert_weekly_vote', {
                    p_fid: validatedFID,
                    p_mode: mode
                });
                
                if (error) {
                    console.error('‚ùå [DAILY VOTE] RPC error:', error);
                    showToast('error', 'Vote Failed', 'Could not record your vote. Please try again.');
                    window.analytics?.trackError(error, { context: 'vote', mode });
                    window.loadingManager?.hide('vote');
                    
                    // ROLLBACK optimistic update on failure
                    if (previousVote && previousVote !== mode && votes[previousVote] !== undefined) {
                        votes[previousVote]++; // Restore old vote
                    }
                    if (!previousVote || previousVote !== mode) {
                        votes[mode]--; // Remove failed vote
                    }
                    userVote = previousVote; // Restore previous vote state
                    
                    // Update UI to reflect rollback
                    updateVotes();
                    updateLeader();
                    updatePercentageBars();
                    updateDailyCurrentlyWinningCard();
                    
                    // Reset UI state on failure
                    selectedModes = [];
                    document.querySelectorAll('.mode-card.selected').forEach(card => {
                        card.classList.remove('selected');
                    });
                    document.querySelectorAll('.vote-checkbox-hidden').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    return;
                }
                
                // Show appropriate feedback based on vote state
                const isFirstVote = !data.previous_mode;
                
                if (data.previous_mode && data.changed) {
                    showToast('success', 'Vote Updated', `Now voting for ${data.new_mode}`, 3000, () => {
                        showShareButton('stream', mode);
                    });
                } else if (!data.previous_mode) {
                    showToast('success', 'Vote Recorded', `Voting for ${data.new_mode}`, 3000, () => {
                        showShareButton('stream', mode);
                    });
                } else {
                    // Same vote confirmation - still show share option
                    showShareButton('stream', mode);
                }
                // No toast for same-mode confirmation - avoid spam
                
                // Get current week Monday for localStorage
                const currentWeekMonday = getCurrentWeekMonday();
                
                // Store vote in localStorage for instant UI feedback
                localStorage.setItem('weekly_voted_this_week', 'true');
                localStorage.setItem('weekly_voted_date', currentWeekMonday);
                localStorage.setItem('userVoteMode', mode); // Store vote mode for comments
                localStorage.setItem('completed_stream_vote', mode); // Track stream vote completion
                
                // Unlock weekly voting (with feedback)
                unlockWeeklyVoting(true);
                
                // Header already defaults collapsed, no need to collapse after vote
                
                userVote = mode;
                
                // Track vote in analytics
                window.analytics?.trackVote(mode);
                
                // Save to vote history
                window.dataPersistence?.saveVoteHistory(mode);
                
                // Show vote confirmation glow animation
                const votedCard = document.querySelector(`.mode-card[data-mode="${mode}"]`);
                if (votedCard) {
                    votedCard.classList.add('vote-confirmed');
                    setTimeout(() => votedCard.classList.remove('vote-confirmed'), 600);
                }
                
                // Show persistent voted status indicator
                showVotedStatus(mode);
                
                // Show invite nudge (once per UTC day, daily vote only)
                const INVITE_KEY = 'invite_prompt_shown_date';
                const today = getTodayUTC();
                const hasShownInviteToday = localStorage.getItem(INVITE_KEY) === today;
                
                if (!hasShownInviteToday) {
                    setTimeout(() => showInviteNudge(), 800);
                    localStorage.setItem(INVITE_KEY, today);
                }
                
                // Hide loading state
                window.loadingManager?.hide('vote');
                
                // REMOVED: Auto-open share modal - now opt-in via voted status buttons
                
                // Optimistic update already complete - rely on realtime subscription for sync
                // No need to call loadVotes() here as it causes race condition
                if (!skipModal) {
                    // UI already updated optimistically above
                    console.log('‚úÖ Vote submitted - waiting for realtime sync');
                }
                
            } catch (err) {
                console.error('‚ùå Error during vote:', err);
                window.loadingManager?.hide('vote');
                
                // Track error
                window.analytics?.trackError(err, { context: 'vote', mode });
                
                // Reset UI state on error
                selectedModes = [];
                document.querySelectorAll('.mode-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.vote-checkbox-hidden').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                showToast('error', 'Vote Failed', 'An error occurred. Please try again.');
            }
        }

        let currentShareMode = null;
        window.currentVotedModes = []; // Store all voted modes for sharing (global)
        const MINIAPP_URL = window.appConfig?.MINIAPP_URL || 'https://zabal.art';
        const SONGJAM_URL = window.appConfig?.SONGJAM_URL || 'https://www.songjam.space/zabal';
        
        // ============================================
        // SHARE PAYLOAD BUILDER - SINGLE SOURCE OF TRUTH
        // All share copy, tags, embeds, and params flow through here
        // ============================================
        
        // Allowed share moments (validation)
        const ALLOWED_SHARE_MOMENTS = new Set([
            'daily_vote',
            'weekly_vote',
            'currently_winning',
            'daily_winner',
            'weekly_winner',
            'live_now'
        ]);
        
        /**
         * Build share payload for any sharing moment
         * @param {string} moment - One of ALLOWED_SHARE_MOMENTS
         * @param {object} context - Moment-specific data
         * @returns {object} { text, embeds, mentions, contextParam }
         */
        function buildSharePayload(moment, context = {}) {
            // Validate moment
            if (!ALLOWED_SHARE_MOMENTS.has(moment)) {
                console.error('‚ùå [SHARE] Invalid moment:', moment);
                return null;
            }
            
            console.log('üì¶ [SHARE] Building payload for:', moment, context);
            
            let text = '';
            let embeds = [];
            let mentions = [];
            let contextParam = '';
            
            switch (moment) {
                case 'daily_vote':
                    const modes = context.modes || [];
                    const modeNames = modes.map(m => {
                        const el = document.querySelector(`[data-mode="${m}"] .mode-name`);
                        return el ? el.textContent : m;
                    });
                    
                    text = `Just voted ${modeNames.join(', ')} on ZABAL\n\nJoin me ‚Üí zabal.art`;
                    embeds = [MINIAPP_URL + '?share=daily_vote'];
                    mentions = context.selectedFriends || [];
                    contextParam = '?share=daily_vote';
                    break;
                    
                case 'weekly_vote':
                    const platform = context.platform || '';
                    text = `Backing ${platform} for ZABAL this week üíõ\n\nWhat's your signal? ‚Üí zabal.art`;
                    embeds = [MINIAPP_URL + '?share=weekly_vote'];
                    mentions = context.selectedFriends || [];
                    contextParam = '?share=weekly_vote';
                    break;
                    
                case 'currently_winning':
                    const winnerName = context.winnerName || '';
                    const voteType = context.voteType || 'daily';
                    
                    if (voteType === 'daily') {
                        text = `${winnerName} is leading right now\n\nVote before 5 PM EST ‚Üí zabal.art`;
                        contextParam = `?share=currently_winning&ref=${context.winnerRef || ''}`;
                    } else {
                        text = `${winnerName} is leading the signal this week\n\nAdd your vote ‚Üí zabal.art`;
                        contextParam = `?share=currently_winning&ref=${context.winnerRef || ''}`;
                    }
                    
                    embeds = [MINIAPP_URL + contextParam];
                    mentions = context.topVoters || [];
                    break;
                    
                case 'daily_winner':
                    const dailyWinnerName = context.winnerName || '';
                    text = `${dailyWinnerName} won today's stream.\nThanks to everyone who voted\nJoin tomorrow ‚Üí zabal.art`;
                    embeds = [MINIAPP_URL + '?share=daily_winner'];
                    mentions = context.topVoters || [];
                    contextParam = '?share=daily_winner';
                    break;
                    
                case 'weekly_winner':
                    const weeklyWinnerName = context.winnerName || '';
                    text = `${weeklyWinnerName} is where the ZABAL community showed up this week.\nAppreciate everyone who voted üíõ\nJoin the signal ‚Üí zabal.art`;
                    embeds = [MINIAPP_URL + '?share=weekly_winner'];
                    mentions = context.topVoters || [];
                    contextParam = '?share=weekly_winner';
                    break;
                    
                case 'live_now':
                    text = `ZABAL is live!\n\nCome watch us build ‚Üí zabal.art`;
                    embeds = [MINIAPP_URL + '?share=live_now'];
                    mentions = context.selectedFriends || [];
                    contextParam = '?share=live_now';
                    break;
            }
            
            // Build mention tags (max 5)
            const mentionTags = mentions.slice(0, 5).map(m => {
                if (typeof m === 'string') return `@${m}`;
                return m.username ? `@${m.username}` : '';
            }).filter(tag => tag).join(' ');
            
            // Append mentions to text if present
            const finalText = mentionTags ? `${text}\n\n${mentionTags}` : text;
            
            const payload = {
                text: finalText,
                embeds,
                mentions,
                contextParam,
                moment
            };
            
            console.log('‚úÖ [SHARE] Payload built:', payload);
            return payload;
        }
        
        async function callNeynarAPI(endpoint, params = {}) {
            // Try serverless function first
            try {
                const queryString = new URLSearchParams({ endpoint, ...params }).toString();
                const response = await fetch(`/api/neynar?${queryString}`);
                if (response.ok) {
                    return response.json();
                }
                console.warn('‚ö†Ô∏è Serverless function failed, using fallback');
            } catch (error) {
                console.error('‚ùå Neynar proxy error:', error);
                throw error; // No fallback - proxy must work
            }
        }
        
        // Friend data
        let topFriend = null;
        let bestFriends = [];

        // Get time until next Monday 5 PM EST
        function getTimeUntilZabalUpdate() {
            const now = new Date();
            
            // Convert to EST (UTC-5)
            const estOffset = -5 * 60; // EST offset in minutes
            const nowEST = new Date(now.getTime() + (now.getTimezoneOffset() + estOffset) * 60000);
            
            // Get next Monday 5 PM EST
            const nextMonday = new Date(nowEST);
            const daysUntilMonday = (1 - nowEST.getDay() + 7) % 7 || 7; // Days until next Monday
            nextMonday.setDate(nowEST.getDate() + daysUntilMonday);
            nextMonday.setHours(17, 0, 0, 0); // 5 PM
            
            // If it's already past Monday 5 PM this week, go to next week
            if (nowEST.getDay() === 1 && nowEST.getHours() >= 17) {
                nextMonday.setDate(nextMonday.getDate() + 7);
            }
            
            const diff = nextMonday - nowEST;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}d ${hours}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        // Fetch user's /zao channel casts count
        async function getZaoChannelCasts(fid) {
            try {
                console.log('üìä Fetching /zao channel casts for FID:', fid);
                // Use proxy to keep API key secure
                const response = await fetch(
                    `/api/neynar?endpoint=feed/user/casts&fid=${fid}&limit=100`
                );
                
                if (!response.ok) {
                    console.error('‚ùå Neynar API error:', response.status);
                    return 0;
                }
                
                const data = await response.json();
                
                // Filter for casts in /zao channel
                const zaoCasts = data.casts?.filter(cast => 
                    cast.channel?.id === 'zao' || cast.parent_url?.includes('/zao')
                ) || [];
                
                console.log('‚úÖ Found', zaoCasts.length, '/zao channel casts');
                return zaoCasts.length;
            } catch (error) {
                console.error('‚ùå Error fetching /zao casts:', error);
                return 0;
            }
        }
        
        // Fetch Neynar user score
        async function getNeynarScore(fid) {
            try {
                console.log('üìä Fetching Neynar score for FID:', fid);
                // Use proxy to keep API key secure
                const response = await fetch(
                    `/api/neynar?endpoint=user/bulk&fids=${fid}`
                );
                
                if (!response.ok) {
                    console.error('‚ùå Neynar API error:', response.status);
                    return 0.5; // Default middle score
                }
                
                const data = await response.json();
                const score = data.users?.[0]?.experimental?.neynar_user_score || 0.5;
                
                console.log('‚úÖ Neynar score:', score);
                return score;
            } catch (error) {
                console.error('‚ùå Error fetching Neynar score:', error);
                return 0.5; // Default on error
            }
        }
        
        // Calculate vote power based on /zao activity, Neynar score, leaderboard rank, and streak
        async function calculateVotePower(fid) {
            try {
                console.log('üéØ Calculating vote power for FID:', fid);
                
                // Base power
                let power = 1;
                let breakdown = { base: 1, zao: 0, leaderboard: 0, streak: 0 };
                
                // Get /zao channel activity
                const zaoCasts = await getZaoChannelCasts(fid);
                
                // Tiered bonuses based on /zao posts
                if (zaoCasts >= 50) {
                    power += 3; // Super active: 4x base
                    breakdown.zao = 3;
                    console.log('üî• Super Active: +3 (50+ /zao posts)');
                } else if (zaoCasts >= 20) {
                    power += 2; // Very active: 3x base
                    breakdown.zao = 2;
                    console.log('‚≠ê Very Active: +2 (20+ /zao posts)');
                } else if (zaoCasts >= 5) {
                    power += 1; // Active: 2x base
                    breakdown.zao = 1;
                    console.log('‚ú® Active: +1 (5+ /zao posts)');
                } else {
                    console.log('üë§ Member: base power (0-4 /zao posts)');
                }
                
                // Get Neynar score for quality multiplier
                const neynarScore = await getNeynarScore(fid);
                
                // Apply Neynar score multiplier
                let multiplier = 1.0;
                if (neynarScore >= 0.9) {
                    multiplier = 1.5; // 50% bonus for top-tier users
                    console.log('üíé Elite Quality: 1.5x multiplier (Neynar 0.9+)');
                } else if (neynarScore >= 0.7) {
                    multiplier = 1.25; // 25% bonus for quality users
                    console.log('‚≠ê Quality User: 1.25x multiplier (Neynar 0.7+)');
                } else if (neynarScore < 0.5) {
                    multiplier = 0.5; // Penalty for low-quality/spam accounts
                    console.log('‚ö†Ô∏è Low Quality: 0.5x multiplier (Neynar <0.5)');
                }
                
                // Get leaderboard rank and add bonus
                try {
                    const leaderboardResponse = await fetch(`/api/leaderboard?fid=${fid}`);
                    if (leaderboardResponse.ok) {
                        const leaderboardData = await leaderboardResponse.json();
                        if (leaderboardData.success && leaderboardData.data) {
                            const rank = leaderboardData.data.rank;
                            const score = leaderboardData.data.score || 0;
                            const streak = leaderboardData.data.streak || 0;
                            
                            // Leaderboard rank bonus (top performers get more power)
                            if (rank <= 10) {
                                power += 3; // Top 10: +3
                                breakdown.leaderboard = 3;
                                console.log('üèÜ Top 10 Leaderboard: +3 (Rank:', rank + ')');
                            } else if (rank <= 50) {
                                power += 2; // Top 50: +2
                                breakdown.leaderboard = 2;
                                console.log('ü•á Top 50 Leaderboard: +2 (Rank:', rank + ')');
                            } else if (rank <= 100) {
                                power += 1; // Top 100: +1
                                breakdown.leaderboard = 1;
                                console.log('ü•à Top 100 Leaderboard: +1 (Rank:', rank + ')');
                            }
                            
                            // Daily streak bonus: +1 per day streak (encourages consistency)
                            if (streak > 0) {
                                power += streak;
                                breakdown.streak = streak;
                                console.log('üî• Streak Bonus: +' + streak + ' (' + streak + ' day streak)');
                            }
                        }
                    }
                } catch (leaderboardError) {
                    console.warn('‚ö†Ô∏è Could not fetch leaderboard data:', leaderboardError);
                }
                
                // Calculate final power (round to 1 decimal)
                const finalPower = Math.round(power * multiplier);
                
                // Cap at 15x (increased from 6x to accommodate leaderboard + streak bonuses)
                const cappedPower = Math.min(finalPower, 15);
                
                console.log('‚úÖ Final vote power:', cappedPower, '(base:', power, 'x multiplier:', multiplier + ')');
                console.log('üìä Breakdown:', breakdown);
                
                return {
                    power: cappedPower,
                    zaoCasts: zaoCasts,
                    neynarScore: neynarScore,
                    multiplier: multiplier,
                    breakdown: breakdown,
                    leaderboardRank: breakdown.leaderboard > 0 ? 'Top tier' : 'Standard',
                    streakDays: breakdown.streak
                };
            } catch (error) {
                console.error('‚ùå Error calculating vote power:', error);
                return { power: 1, zaoCasts: 0, neynarScore: 0.5, multiplier: 1.0, breakdown: { base: 1, zao: 0, leaderboard: 0, streak: 0 } };
            }
        }
        
        // Update vote power display with detailed breakdown
        function updateVotePowerDisplay(powerData) {
            const powerEl = document.getElementById('statVotePower');
            const simplePowerEl = document.getElementById('simplePowerValue');
            const powerHintEl = document.querySelector('.power-hint');
            
            if (powerEl) {
                powerEl.textContent = `${powerData.power}x`;
            }
            
            if (simplePowerEl) {
                simplePowerEl.textContent = `${powerData.power}x`;
            }
            
            // Show detailed breakdown in hint
            if (powerHintEl && powerData.breakdown) {
                const b = powerData.breakdown;
                const parts = [];
                if (b.base) parts.push(`Base: ${b.base}`);
                if (b.zao) parts.push(`ZAO: +${b.zao}`);
                if (b.leaderboard) parts.push(`Rank: +${b.leaderboard}`);
                if (b.streak) parts.push(`Streak: +${b.streak}`);
                powerHintEl.textContent = parts.join(' ¬∑ ');
            }
            
            // Update stats summary
            updateStatsSummary();
        }
        
        // Live stream status
        let isLive = false;
        
        // Check if stream is live (you can integrate with Twitch API later)
        function checkLiveStatus() {
            // For now, manually controlled
            // TODO: Integrate with Twitch API to auto-detect live status
            const liveStatus = localStorage.getItem('zabalLiveStatus');
            if (liveStatus === 'live') {
                showLiveBanner();
            }
        }
        
        function showLiveBanner() {
            const banner = document.getElementById('nowLiveBanner');
            if (banner) {
                banner.style.display = 'flex';
                isLive = true;
            }
        }
        
        function hideLiveBanner() {
            const banner = document.getElementById('nowLiveBanner');
            if (banner) {
                banner.style.display = 'none';
                isLive = false;
            }
        }
        
        // Share live stream directly (no modal)
        window.shareLiveStreamDirect = async function() {
            const shareText = `ZABAL IS LIVE NOW\n\nJoin the stream and watch us create in real-time!\n\nTwitch: twitch.tv/bettercallzaal\nRetake: retake.tv/zaal\n\nCome hang!`;
            
            try {
                await window.farcasterSDK.actions.composeCast({
                    text: shareText,
                    embeds: ['https://twitch.tv/bettercallzaal'],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ Live stream shared to Farcaster');
                showShareSuccess();
            } catch (error) {
                console.error('‚ùå Failed to share live stream:', error);
                showToast('error', 'Share Failed', 'Could not share stream. Please try again.');
            }
        }
        
        /* ==============================================
           POST-VOTE INVITE NUDGE
        ============================================== */

        // Show the invite nudge with fade-in
        function showInviteNudge() {
            const nudge = document.getElementById('inviteNudge');
            if (!nudge) return;
            
            nudge.classList.remove('hidden');
            nudge.classList.add('fade-in');
            console.log('üëã [INVITE] Showing invite nudge');
        }

        // Hide the invite nudge
        function hideInviteNudge() {
            const nudge = document.getElementById('inviteNudge');
            if (!nudge) return;
            
            nudge.classList.add('hidden');
            nudge.classList.remove('fade-in');
            console.log('üëã [INVITE] Hiding invite nudge');
        }

        // Wire invite button - opens share modal with invite source
        document.addEventListener('DOMContentLoaded', function() {
            const inviteBtn = document.getElementById('inviteFriendBtn');
            const dismissBtn = document.getElementById('dismissInviteBtn');
            
            if (inviteBtn) {
                inviteBtn.addEventListener('click', function() {
                    console.log('üëã [INVITE] Invite button clicked');
                    // Open share modal with invite context
                    if (window.openShareModal && currentShareMode) {
                        window.openShareModal(currentShareMode, false);
                    }
                    hideInviteNudge();
                });
            }
            
            if (dismissBtn) {
                dismissBtn.addEventListener('click', function() {
                    console.log('üëã [INVITE] Dismissed');
                    hideInviteNudge();
                });
            }
        });

        /* ==============================================
           SHARE MODAL & SOCIAL FEATURES
        ============================================== */

        window.openShareModal = function(votedModes, isWeeklyVote = false) {
            // Handle both single mode (string) and multiple modes (array)
            const modesArray = Array.isArray(votedModes) ? votedModes : [votedModes];
            
            // Store all voted modes for sharing
            window.currentVotedModes = modesArray;
            currentShareMode = modesArray[0]; // Keep for backwards compatibility
            window.isWeeklyVote = isWeeklyVote; // Store for shareVote function
            
            console.log('üì§ Opening share modal with modes:', window.currentVotedModes, 'isWeekly:', isWeeklyVote);
            
            const modal = document.getElementById('shareModal');
            modal.classList.add('active');
            
            // Enable focus trap for accessibility
            document.addEventListener('keydown', trapFocus);
            
            // Focus first interactive element
            setTimeout(() => {
                const firstButton = modal.querySelector('button:not([disabled])');
                if (firstButton) firstButton.focus();
            }, 100);
            
            console.log('üîç Opening share modal');
            console.log('üë• Best friends count:', bestFriends.length);
            console.log('üëë Top friend:', topFriend);
            console.log('üîê Authenticated:', isAuthenticated);
            
            // Show friend tagging if we have friends
            if (bestFriends.length > 0) {
                console.log('‚úÖ Displaying friend tags');
                displayFriendTags();
            } else {
                console.warn('‚ö†Ô∏è No friends to display');
            }
            
            // Show top friend invitation
            if (topFriend) {
                console.log('‚úÖ Displaying top friend invite');
                displayTopFriendInvite();
            } else {
                console.warn('‚ö†Ô∏è No top friend to display');
            }
            
            // Show challenge button if authenticated
            if (isAuthenticated && bestFriends.length > 0) {
                console.log('‚úÖ Showing challenge button');
                document.querySelector('.challenge-friends-btn').style.display = 'block';
            }
        }
        
        window.closeShareModal = function() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                modal.classList.remove('active');
                // Remove focus trap
                document.removeEventListener('keydown', trapFocus);
            }
        }
        
        // Focus trap for modals (accessibility)
        function trapFocus(e) {
            const modal = document.querySelector('.share-modal.active');
            if (!modal) return;
            
            const focusableElements = modal.querySelectorAll(
                'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            // Handle Tab key
            if (e.key === 'Tab') {
                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }
            
            // Handle Escape key
            if (e.key === 'Escape') {
                closeShareModal();
            }
        }
        
        window.copyMiniappLink = function() {
            const shareUrl = window.isWeeklyVote ? `${MINIAPP_URL}?source=share&vote=weekly` : `${MINIAPP_URL}?source=share&vote=daily`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                const btn = document.querySelector('.copy-link-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
        
        // Share preferences stored in localStorage
        const sharePreferences = {
            autoShare: false,
            shareLeading: false,
            shareMilestones: true
        };

        // Update toggle UI
        function updateToggleUI() {
            const toggles = {
                autoShare: [
                    document.getElementById('autoShareToggle'),
                    document.getElementById('autoShareToggleProfile')
                ],
                shareLeading: [
                    document.getElementById('shareLeadingToggle'),
                    document.getElementById('shareLeadingToggleProfile')
                ],
                shareMilestones: [
                    document.getElementById('shareMilestonesToggle'),
                    document.getElementById('shareMilestonesToggleProfile')
                ]
            };

            Object.keys(toggles).forEach(key => {
                toggles[key].forEach(toggle => {
                    if (toggle) {
                        if (sharePreferences[key]) {
                            toggle.classList.add('active');
                        } else {
                            toggle.classList.remove('active');
                        }
                    }
                });
            });
        }

        // Toggle settings dropdown
        window.toggleSettingsDropdown = function() {
            const dropdown = document.getElementById('settingsDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('settingsDropdown');
            const profileBadge = document.getElementById('userProfile');
            if (dropdown && !profileBadge?.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });


        // Load preferences from localStorage
        function loadSharePreferences() {
            const saved = localStorage.getItem('sharePreferences');
            if (saved) {
                Object.assign(sharePreferences, JSON.parse(saved));
            }
            updateToggleUI();
        }

        // Save preferences to localStorage
        function saveSharePreferences() {
            localStorage.setItem('sharePreferences', JSON.stringify(sharePreferences));
        }

        // Toggle setting
        window.toggleSetting = function(setting) {
            sharePreferences[setting] = !sharePreferences[setting];
            saveSharePreferences();
            updateToggleUI();
            console.log('üìù Share preference updated:', setting, sharePreferences[setting]);
        }

        // Check if should auto-share based on preferences
        function shouldAutoShare(mode) {
            if (!sharePreferences.autoShare) return false;
            if (sharePreferences.shareLeading) {
                const leader = getLeader();
                return mode === leader;
            }
            return true;
        }

        // Check for milestone and share if enabled
        function checkMilestone(totalVotes) {
            if (!sharePreferences.shareMilestones) return false;
            const milestones = [10, 25, 50, 100, 250, 500];
            return milestones.includes(totalVotes);
        }

        // Load best friends from Neynar with retry logic
        window.loadBestFriends = async function(fid, retryCount = 0) {
            const MAX_RETRIES = 3;
            const RETRY_DELAY = 1000; // 1 second
            
            console.log('üîµ [LOAD FRIENDS] === START loadBestFriends() ===');
            console.log('üîµ [LOAD FRIENDS] Input FID:', fid, '| Retry:', retryCount);
            
            if (!fid) {
                console.error('‚ùå [LOAD FRIENDS] No FID provided to loadBestFriends');
                window.bestFriends = [];
                return false;
            }
            
            console.log('üì° [LOAD FRIENDS] Calling Neynar API for FID:', fid);
            
            try {
                console.log('üåê [LOAD FRIENDS] Fetching from Neynar API...');
                const data = await callNeynarAPI('user/best_friends', { fid, limit: 50 });
                
                console.log('üì• [LOAD FRIENDS] Neynar response received');
                console.log('üì• [LOAD FRIENDS] Response keys:', Object.keys(data));
                console.log('üì• [LOAD FRIENDS] Full response:', JSON.stringify(data, null, 2));
                
                // Try different possible response structures
                const friendsList = data.result?.users || data.users || data || [];
                
                console.log('üìä [LOAD FRIENDS] Friends list extracted:', friendsList.length, 'friends');
                console.log('üìä [LOAD FRIENDS] First friend sample:', friendsList[0]);
                
                if (friendsList.length > 0) {
                    console.log('‚úÖ [LOAD FRIENDS] Friends found, fetching full user data...');
                    // Get FIDs from best friends list
                    const friendFids = friendsList.map(f => f.fid).join(',');
                    console.log('üî¢ [LOAD FRIENDS] Friend FIDs:', friendFids);
                    
                    // Fetch full user data to get profile pictures
                    console.log('üåê [LOAD FRIENDS] Fetching bulk user data...');
                    const userData = await callNeynarAPI('user/bulk', { fids: friendFids });
                    console.log('üì• [LOAD FRIENDS] Bulk user data received:', userData.users?.length || 0, 'users');
                    
                    // Map full user data
                    bestFriends = userData.users || [];
                    topFriend = bestFriends[0];
                    
                    // CRITICAL: Set window.bestFriends for share-modal.js to access
                    window.bestFriends = bestFriends;
                    
                    console.log('‚úÖ [LOAD FRIENDS] Loaded best friends:', bestFriends.length);
                    console.log('‚úÖ [LOAD FRIENDS] Set window.bestFriends:', window.bestFriends?.length || 0);
                    console.log('üëë [LOAD FRIENDS] Top friend:', topFriend?.username);
                    console.log('üë• [LOAD FRIENDS] All friends:', bestFriends.map(f => f.username));
                    console.log('üìä [LOAD FRIENDS] Sample friend data:', bestFriends.slice(0, 2).map(f => ({
                        username: f.username,
                        display_name: f.display_name,
                        pfp_url: f.pfp_url
                    })));
                } else {
                    console.warn('‚ö†Ô∏è [LOAD FRIENDS] No best friends returned from API');
                    console.warn('‚ö†Ô∏è [LOAD FRIENDS] Trying alternative: loading user followers instead');
                    
                    // Fallback: Try to get user's followers as friends
                    try {
                        const followersData = await callNeynarAPI('user/bulk', { fids: fid });
                        console.log('üì• [LOAD FRIENDS] Followers fallback response:', followersData);
                        
                        // For now, create a mock friend list so UI still works
                        // This allows testing the UI even without best friends data
                        bestFriends = [];
                        topFriend = null;
                        window.bestFriends = [];
                        console.log('‚ÑπÔ∏è [LOAD FRIENDS] Friend tagging will be hidden until best friends data is available');
                    } catch (fallbackError) {
                        console.error('‚ùå [LOAD FRIENDS] Fallback also failed:', fallbackError);
                    }
                }
            } catch (error) {
                console.error('‚ùå [LOAD FRIENDS] Error loading best friends:', error);
                console.error('‚ùå [LOAD FRIENDS] Error details:', error.message);
                console.error('‚ùå [LOAD FRIENDS] Error stack:', error.stack);
                
                // Retry logic
                if (retryCount < MAX_RETRIES) {
                    console.log(`üîÑ [LOAD FRIENDS] Retrying in ${RETRY_DELAY}ms... (Attempt ${retryCount + 1}/${MAX_RETRIES})`);
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                    return await window.loadBestFriends(fid, retryCount + 1);
                }
                
                console.error('‚ùå [LOAD FRIENDS] Max retries reached, giving up');
                // Ensure window.bestFriends is set even on error
                window.bestFriends = [];
                return false;
            }
            
            console.log('üîµ [LOAD FRIENDS] === END loadBestFriends() ===');
            console.log('üîµ [LOAD FRIENDS] Final window.bestFriends:', window.bestFriends?.length || 0);
            return true;
        }

        // Display friend tags in share modal
        let friendsDisplayCount = 5; // Start with 5, increment by 5
        function displayFriendTags() {
            const section = document.getElementById('friendTagSection');
            const list = document.getElementById('friendTagList');
            
            if (!section || !list || bestFriends.length === 0) return;
            
            section.style.display = 'block';
            
            const friendsToShow = bestFriends.slice(0, friendsDisplayCount);
            console.log('üë• Displaying friends:', friendsToShow.length, 'of', bestFriends.length);
            
            // Create friend tags with event listeners
            list.innerHTML = friendsToShow.map((friend, index) => {
                const isSelected = selectedFriends.includes(friend.username);
                return `
                    <div class="friend-tag-item ${isSelected ? 'selected' : ''}" data-username="${friend.username}" data-index="${index}">
                        <img src="${friend.pfp_url}" class="friend-tag-pfp" alt="${friend.username}">
                        <span class="friend-tag-username">@${friend.username}</span>
                    </div>
                `;
            }).join('');
            
            // Add show more button if there are more friends to display
            if (bestFriends.length > friendsDisplayCount) {
                const remaining = bestFriends.length - friendsDisplayCount;
                const toShow = Math.min(5, remaining);
                list.innerHTML += `<div class="show-more-friends" onclick="showMoreFriends()">+ Show ${toShow} more friend${toShow !== 1 ? 's' : ''} (${remaining} remaining)</div>`;
            }
            
            // Add click listeners to all friend tags
            document.querySelectorAll('.friend-tag-item').forEach(item => {
                item.addEventListener('click', function() {
                    toggleFriendTag(this.dataset.username, this);
                });
            });
            
            updateFriendTagCounter();
            console.log('üë• Friend tags displayed:', friendsToShow.length, '| Selected:', selectedFriends.length);
        }

        // Show more friends (5 at a time)
        window.showMoreFriends = function() {
            const previousCount = friendsDisplayCount;
            friendsDisplayCount = Math.min(friendsDisplayCount + 5, bestFriends.length);
            console.log('üë• Showing more friends:', previousCount, '‚Üí', friendsDisplayCount);
            displayFriendTags();
        }

        // Update friend tag counter
        function updateFriendTagCounter() {
            const counter = document.getElementById('friendTagCounter');
            if (counter) {
                counter.textContent = `${selectedFriends.length} selected`;
                counter.style.display = selectedFriends.length > 0 ? 'block' : 'none';
                console.log('üî¢ Friend counter updated:', selectedFriends.length);
            }
        }

        // Toggle friend tag selection
        let selectedFriends = [];
        function toggleFriendTag(username, element) {
            // Validate username
            try {
                username = window.Validator.validateUsername(username);
            } catch (error) {
                console.error('‚ùå Invalid username:', error.message);
                showToast('error', 'Invalid Username', error.message);
                return;
            }
            
            const index = selectedFriends.indexOf(username);
            
            if (index > -1) {
                // Remove friend
                selectedFriends.splice(index, 1);
                element.classList.remove('selected');
                console.log('‚ûñ Removed friend:', username, '| Total selected:', selectedFriends.length);
            } else {
                // Add friend (max 10)
                if (selectedFriends.length >= 10) {
                    showToast('info', 'Maximum Reached', 'You can tag up to 10 friends maximum');
                    console.log('‚ö†Ô∏è Max friends reached (10)');
                    return;
                }
                selectedFriends.push(username);
                element.classList.add('selected');
                console.log('‚ûï Added friend:', username, '| Total selected:', selectedFriends.length);
            }
            
            console.log('üë• Currently selected friends:', selectedFriends);
            updateFriendTagCounter();
        }


        // Display top friend invitation
        function displayTopFriendInvite() {
            const section = document.getElementById('topFriendInvite');
            const card = document.getElementById('topFriendCard');
            
            if (!section || !card || !topFriend) return;
            
            section.style.display = 'block';
            
            card.innerHTML = `
                <img src="${topFriend.pfp_url}" class="top-friend-pfp" alt="${topFriend.username}">
                <div class="top-friend-info">
                    <div class="top-friend-username">@${topFriend.username}</div>
                    <div class="top-friend-label">Your top friend on Farcaster</div>
                </div>
            `;
        }

        // Invite top friend to vote
        window.inviteTopFriend = async function() {
            if (!topFriend) return;
            
            const modeEmojis = {
                studio: 'üé¨',
                market: 'üõí',
                social: 'üåê',
                battle: '‚öîÔ∏è'
            };
            
            const modeNames = {
                studio: 'STUDIO',
                market: 'MARKET',
                social: 'SOCIAL',
                battle: 'BATTLE'
            };
            
            const timeRemaining = getTimeUntilZabalUpdate();
            const inviteText = `Hey @${topFriend.username}! üëã\n\nI just voted ${modeEmojis[currentShareMode]} ${modeNames[currentShareMode]} on ZABAL Live Hub!\n\nWhat's your vote? Join me! üé®\n\n‚è∞ ZABAL Update #4 in ${timeRemaining}\nüìä ${SONGJAM_URL}\n\n${MINIAPP_URL}?source=share&vote=daily`;
            
            try {
                await window.farcasterSDK.actions.composeCast({
                    text: inviteText,
                    embeds: [MINIAPP_URL + '?source=share&vote=daily'],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ Invited top friend:', topFriend.username);
                showShareSuccess();
                setTimeout(() => closeShareModal(), 1500);
            } catch (error) {
                console.error('‚ùå Failed to invite friend:', error);
                showToast('error', 'Invitation Failed', 'Could not send invitation. Please try again.');
            }
        }

        // Challenge friends
        window.challengeFriends = async function() {
            const modeEmojis = {
                studio: '',
                market: '',
                social: '',
                battle: ''
            };
            
            const modeNames = {
                studio: 'STUDIO',
                market: 'MARKET',
                social: 'SOCIAL',
                battle: 'BATTLE'
            };
            
            // Get selected friends or use top 3
            const friendsToTag = selectedFriends.length > 0 
                ? selectedFriends 
                : bestFriends.slice(0, 3).map(f => f.username);
            
            const friendMentions = friendsToTag.map(u => `@${u}`).join(' ');
            
            const challengeText = `‚öîÔ∏è Challenge time!\n\n${friendMentions} I just voted ${modeEmojis[currentShareMode]} ${modeNames[currentShareMode]} on ZABAL!\n\nWhat's YOUR vote? üé®\n\n${MINIAPP_URL}?source=share&vote=daily`;
            
            try {
                await window.farcasterSDK.actions.composeCast({
                    text: challengeText,
                    embeds: [MINIAPP_URL + '?source=share&vote=daily'],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ Challenged friends:', friendsToTag);
                showShareSuccess();
                setTimeout(() => closeShareModal(), 1500);
            } catch (error) {
                console.error('‚ùå Failed to challenge friends:', error);
                showToast('error', 'Challenge Failed', 'Could not send challenge. Please try again.');
            }
        }

        // Initialize share preferences
        loadSharePreferences();
        
        // Update toggles after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            updateToggleUI();
            checkNotificationStatus();
        });

        // Enable notifications function
        window.enableNotifications = async function() {
            console.log('üîî Enabling notifications...');
            
            if (!window.farcasterSDK || !window.farcasterSDK.actions) {
                showToast('error', 'SDK Not Available', 'Please open in Warpcast to enable notifications');
                return;
            }

            try {
                // Call addMiniApp to prompt user to add the app and enable notifications
                const result = await window.farcasterSDK.actions.addMiniApp();
                
                console.log('‚úÖ Miniapp add result:', result);
                showToast('success', 'Notifications Enabled!', 'You\'ll receive daily reminders at 11 AM EST');
                
                // Update button state
                const btn = document.getElementById('enableNotificationsBtn');
                if (btn) {
                    btn.textContent = '‚úì Enabled';
                    btn.classList.add('enabled');
                }
                
                // Store in localStorage
                localStorage.setItem('notificationsEnabled', 'true');
                
            } catch (error) {
                console.error('‚ùå Failed to enable notifications:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                showToast('error', 'Enable Failed', error.message || 'Could not enable notifications. Please try again.');
            }
        }

        // Check notification status on load
        function checkNotificationStatus() {
            const enabled = localStorage.getItem('notificationsEnabled') === 'true';
            const btn = document.getElementById('enableNotificationsBtn');
            
            if (enabled && btn) {
                btn.textContent = '‚úì Enabled';
                btn.classList.add('enabled');
                // Don't disable - allow user to click again if needed
            }
        }

        // Multi-select voting system
        let selectedModes = [];

        window.toggleModeSelection = function(mode) {
            
            const card = document.querySelector(`.mode-card[data-mode="${mode}"]`);
            const checkbox = card.querySelector('.vote-checkbox-hidden');
            
            // Toggle selection
            if (selectedModes.includes(mode)) {
                selectedModes = selectedModes.filter(m => m !== mode);
                card.classList.remove('selected');
                checkbox.checked = false;
                console.log('‚ùå Deselected mode:', mode);
            } else {
                selectedModes.push(mode);
                card.classList.add('selected');
                checkbox.checked = true;
                console.log('‚úÖ Selected mode:', mode);
            }
        }

        // updateSubmitButton removed - no longer needed with instant voting
        function updateSubmitButton_DEPRECATED() {
            // This function is deprecated and should not be called
            return;
            
            const btn = document.getElementById('submitVotesBtn');
            const btnText = document.getElementById('submitBtnText');
            
            if (btn && btnText) {
                if (selectedModes.length === 0) {
                    btn.disabled = true;
                    btnText.textContent = 'Select a mode to continue';
                } else {
                    btn.disabled = false;
                    btnText.textContent = 'Lock In Your Choice';
                }
            }
        }

        // Show voted status indicator
        function showVotedStatus(mode) {
            const votedStatus = document.getElementById('votedStatus');
            const votedStatusMode = document.getElementById('votedStatusMode');
            const submitContainer = document.getElementById('submitVotesContainer');
            
            if (votedStatus && votedStatusMode && submitContainer) {
                // Update mode name
                const modeNames = {
                    studio: 'Studio Mode',
                    market: 'Market Mode',
                    social: 'Social Mode',
                    battle: 'Battle Mode'
                };
                votedStatusMode.textContent = modeNames[mode] || mode;
                
                // Show voted status, hide submit button
                votedStatus.classList.add('active');
                submitContainer.style.display = 'none';
                
                // Clear any selected mode cards
                selectedModes = [];
                document.querySelectorAll('.mode-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.vote-checkbox-hidden').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        }

        // Hide voted status and show submit button (for changing vote)
        function hideVotedStatus() {
            const votedStatus = document.getElementById('votedStatus');
            const submitContainer = document.getElementById('submitVotesContainer');
            
            if (votedStatus && submitContainer) {
                votedStatus.classList.remove('active');
                submitContainer.style.display = 'block';
            }
        }

        // Change vote - allow user to select different mode
        window.changeVote = function() {
            hideVotedStatus();
            showToast('info', 'Change Your Vote', 'Select a different mode to update your vote');
        }

        window.submitVotes = async function() {
            
            // Validate modes
            let validatedModes;
            try {
                validatedModes = window.Validator.validateModes(selectedModes);
            } catch (error) {
                console.error('‚ùå Invalid modes:', error.message);
                showToast('error', 'Invalid Selection', error.message);
                window.errorHandler?.handleError(error, { type: 'validation_error', context: 'submitVotes' });
                return;
            }
            
            if (validatedModes.length === 0) {
                showToast('info', 'No Selection', 'Please select at least one mode to vote for');
                return;
            }
            
            // Check authentication
            if (!isAuthenticated) {
                showToast('info', 'Farcaster Required', 'Open this page in Warpcast to vote on weekly social platforms!');
                return;
            }
            
            if (currentState !== StreamState.DECIDING) {
                showToast('info', 'Voting Closed', 'Stream is currently locked or live');
                return;
            }
            
            // Show loading state for batch submission
            window.loadingManager?.show('submitVotes', 'Submitting your votes...');
            
            try {
                // Submit each vote (skipModal = true to prevent individual modals)
                for (const mode of validatedModes) {
                    await vote(mode, true);
                }
                
                // Reload votes once after all votes submitted
                await loadVotes();
                
                // Hide loading state
                window.loadingManager?.hide('submitVotes');
                
                showToast('success', 'Votes Submitted!', `Voted for ${validatedModes.length} mode${validatedModes.length > 1 ? 's' : ''}`);
                
                // Store voted modes for sharing
                const votedModes = [...validatedModes];
                
                // Clear selections
                selectedModes = [];
                document.querySelectorAll('.vote-checkbox').forEach(cb => cb.checked = false);
                
                // Open share modal with all voted modes
                setTimeout(() => openShareModal(votedModes), 500);
                
            } catch (error) {
                console.error('‚ùå Error submitting votes:', error);
                window.loadingManager?.hide('submitVotes');
                showToast('error', 'Submission Failed', 'Could not submit votes. Please try again.');
            }
        }


        // Share vote to Farcaster - exposed to global scope
        window.shareVote = async function(modes, isAuto = false) {
            // Handle both single mode (string) and multiple modes (array)
            const votedModes = Array.isArray(modes) ? modes : [modes];
            const isWeekly = window.isWeeklyVote || false;
            console.log('üì§ Starting shareVote:', { modes: votedModes, isAuto, isWeekly, selectedFriends: selectedFriends.length });
            
            // STEP 3: Different copy for weekly social votes vs daily stream votes
            if (isWeekly) {
                // Weekly social platform vote
                const platform = votedModes[0]; // Single platform for weekly
                const platformEmojis = {
                    'X (Twitter)': 'üê¶',
                    'Farcaster': 'üü£',
                    'TikTok': 'üéµ',
                    'YouTube': 'üì∫',
                    'Instagram': 'üì∏'
                };
                
                const emoji = platformEmojis[platform] || 'üì±';
                
                // Use dynamic message generator for varied messages
                const messageGen = new window.ShareMessageGenerator();
                const userStreak = window.StateManager?.get('auth.streak') || 0;
                const isFirst = userStreak === 0;
                
                let castText = messageGen.generateWeeklySocialMessage(platform, {
                    streak: userStreak,
                    isFirstVote: isFirst
                });
                
                // Add friend tags if selected
                let friendTags = '';
                if (selectedFriends.length > 0) {
                    console.log('üë• Tagging friends:', selectedFriends);
                    // selectedFriends contains username strings, not objects
                    friendTags = '\n\n' + selectedFriends.map(f => `@${typeof f === 'string' ? f : f.username}`).join(' ');
                    castText += friendTags;
                }
                
                const finalCast = `${castText}\n\n${MINIAPP_URL}?source=share&vote=weekly`;
                
                console.log('üìù Weekly social cast text:', finalCast);
                
                try {
                    await window.farcasterSDK.actions.composeCast({
                        text: finalCast,
                        embeds: [MINIAPP_URL + '?source=share&vote=weekly'],
                        channelKey: 'zao'
                    });
                    console.log('‚úÖ Weekly social vote shared to Farcaster');
                    closeShareModal();
                    showToast('success', 'Shared!', 'Your weekly vote has been shared to Farcaster');
                } catch (error) {
                    console.error('‚ùå Failed to share weekly vote:', error);
                    showToast('error', 'Share Failed', 'Could not share. Please try again.');
                }
                
                return;
            }
            
            // Daily stream voting (original logic)
            const modeEmojis = {
                studio: 'üé¨',
                market: 'üõí',
                social: 'üåê',
                battle: '‚öîÔ∏è'
            };
            
            const modeNames = {
                studio: 'STUDIO',
                market: 'MARKET',
                social: 'SOCIAL',
                battle: 'BATTLE'
            };
            
            const modeDescriptions = {
                studio: 'Creative art sessions',
                market: 'NFT drops & trading',
                social: 'Community hangouts',
                battle: 'Competitive challenges'
            };
            
            // Calculate total votes and percentages
            const totalVotes = votes.studio + votes.market + votes.social + votes.battle;
            const getPercentage = (count) => totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
            
            // Find leader
            const leader = getLeader();
            
            // Create vote standings with visual bars and leader indicator
            const createBar = (count, isLeader) => {
                const pct = getPercentage(count);
                const barLength = Math.round(pct / 10); // 10% = 1 block
                const bar = '‚ñà'.repeat(Math.max(1, barLength));
                const leaderMark = isLeader ? ' üëë' : '';
                return `${bar} ${pct}%${leaderMark}`;
            };
            
            const standings = [
                `üé¨ Studio: ${votes.studio} ${createBar(votes.studio, leader === 'studio')}`,
                `üõí Market: ${votes.market} ${createBar(votes.market, leader === 'market')}`,
                `üåê Social: ${votes.social} ${createBar(votes.social, leader === 'social')}`,
                `‚öîÔ∏è Battle: ${votes.battle} ${createBar(votes.battle, leader === 'battle')}`
            ].join('\n');
            
            // Check for milestone
            const isMilestone = checkMilestone(totalVotes);
            
            // Use dynamic message generator for varied, personalized messages
            const messageGen = new window.ShareMessageGenerator();
            const userStreak = window.StateManager?.get('auth.streak') || 0;
            const userVotePower = window.StateManager?.get('auth.votePower') || 1;
            const isFirstVote = userStreak === 0;
            
            let castText;
            let callToAction;
            
            // For single mode votes, use personalized templates
            if (votedModes.length === 1) {
                const mode = votedModes[0];
                castText = messageGen.generateVoteMessage(mode, {
                    streak: userStreak,
                    votePower: userVotePower,
                    isFirstVote: isFirstVote
                });
                
                // Add current standings
                const votedModesText = votedModes.map(m => `${modeEmojis[m]} ${modeNames[m]}`).join(' + ');
                castText += `\n\nCurrent standings:\n${standings}`;
                callToAction = '';
            } else {
                // Multi-vote: use existing logic with slight variation
                const votedModesText = votedModes.map(m => `${modeEmojis[m]} ${modeNames[m]}`).join(' + ');
                const isMultiVote = votedModes.length > 1;
                
                if (isMilestone) {
                    castText = `üéâ WE HIT ${totalVotes} VOTES!\n\nJust voted ${votedModesText}${isMultiVote ? ' (multi-vote!)' : ''}\n\n${standings}\n\nJoin the celebration! üéä`;
                    callToAction = 'Vote & celebrate with us! üëá';
                } else if (votedModes.includes(leader)) {
                    castText = `${modeEmojis[leader]} ${modeNames[leader]} IS WINNING! üëë\n\nI voted: ${votedModesText}${isMultiVote ? ' üéØ' : ''}\n\n${standings}\n\n`;
                    callToAction = 'Help us dominate! Vote now üëá';
                } else {
                    castText = `Voted ${votedModesText} on ZABAL!${isMultiVote ? ' üéØ' : ''} üé®\n\n${standings}\n\n`;
                    callToAction = 'Your turn! Vote now üëá';
                }
            }
            
            // Check if multi-vote for mentions
            const isMultiVote = votedModes.length > 1;
            
            // Add @zaal mention with stream suggestion (only if we have valid modes)
            let zaalMention = '';
            if (votedModes.length > 0 && votedModes[0] && modeNames[votedModes[0]]) {
                zaalMention = isMultiVote 
                    ? `\n\n@zaal I think you should do a ${votedModes.map(m => modeNames[m]).join(' + ')} combo stream! üé®`
                    : `\n\n@zaal I think you should do a ${modeNames[votedModes[0]]} stream for your next stream! üé®`;
            }
            
            // Add friend tags if selected
            let friendTags = '';
            if (selectedFriends.length > 0) {
                console.log('üë• Tagging friends:', selectedFriends);
                friendTags = '\n\n' + selectedFriends.map(u => `@${u}`).join(' ') + ' what\'s your vote?';
            } else {
                console.log('üë§ No friends tagged');
            }
            
            // Add ZABAL Update countdown
            const timeRemaining = getTimeUntilZabalUpdate();
            const zabalUpdateInfo = `\n\n‚è∞ ZABAL Update #4 in ${timeRemaining}\nüìä ZABAL Empire Leaderboard\nüéµ ${SONGJAM_URL}`;
            
            // Add call to action and links
            castText += callToAction + zaalMention + friendTags + zabalUpdateInfo + '\n\n' + MINIAPP_URL + '?source=share&vote=daily';
            
            // Log cast details before sending
            console.log('üìù Cast text length:', castText.length);
            console.log('üîó Embeds:', [SONGJAM_URL, MINIAPP_URL]);
            console.log('üì¢ Channel:', 'zao');
            
            // Clear selected friends after sharing
            const taggedFriends = [...selectedFriends];
            selectedFriends = [];
            
            try {
                const result = await window.farcasterSDK.actions.composeCast({
                    text: castText,
                    embeds: [SONGJAM_URL, MINIAPP_URL + '?source=share&vote=daily'],
                    channelKey: 'zao'
                });
                
                console.log('‚úÖ composeCast result:', result);
                
                // Only show error if the result explicitly indicates failure
                // Note: User closing the composer is NOT a failure
                if (result && result.error) {
                    console.error('‚ùå Failed to share vote:', result.error);
                    showToast('error', 'Share Failed', 'Could not share to Farcaster. Please try again.');
                } else {
                    console.log('‚úÖ Vote shared to Farcaster successfully');
                    console.log('üë• Tagged friends in cast:', taggedFriends);
                    
                    // Track share for analytics
                    trackShare(votedModes[0]);
                    console.log('üìä Share tracked for mode:', votedModes[0]);
                    
                    // Show share success feedback
                    if (!isAuto) {
                        showShareSuccess();
                        setTimeout(() => closeShareModal(), 1500);
                    }
                }
            } catch (error) {
                // Only show error for actual exceptions, not user cancellations
                console.log('‚ö†Ô∏è Share action result:', error);
                // Don't show error toast - user may have just closed the composer
            }
        }

        // Track shares for analytics and potential rewards
        function trackShare(mode, userTotalVotes) {
            const shareCount = parseInt(localStorage.getItem('shareCount') || '0') + 1;
            localStorage.setItem('shareCount', shareCount.toString());
            localStorage.setItem('lastShareMode', mode);
            localStorage.setItem('lastShareTime', Date.now().toString());
            
            console.log('üìä Share tracked:', { shareCount, mode, userTotalVotes });
            
            // Check for share milestones
            if (shareCount === 1) {
                console.log('üéâ First share!');
            } else if (shareCount === 10) {
                console.log('üåü 10 shares milestone!');
            } else if (shareCount === 50) {
                console.log('üí´ 50 shares milestone!');
            }
        }

        // Show share success animation
        function showShareSuccess() {
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #e0ddaa 0%, #d4c96e 100%);
                color: #0a0a0a;
                padding: 20px 40px;
                border-radius: 12px;
                font-size: 1.2rem;
                font-weight: 800;
                z-index: 10001;
                animation: shareSuccess 1.5s ease;
                box-shadow: 0 8px 32px rgba(224, 221, 170, 0.4);
            `;
            successMsg.textContent = '‚úÖ Shared to /zao!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => successMsg.remove(), 1500);
        }
        

        function updateVotes() {
            console.log('üîÑ updateVotes() called');
            console.log('üìä Current votes:', votes);
            
            Object.keys(votes).forEach(mode => {
                const voteElement = document.querySelector(`[data-votes="${mode}"]`);
                if (voteElement) {
                    console.log(`üìù Updating ${mode} display to ${votes[mode]}`);
                    voteElement.textContent = votes[mode];
                } else {
                    console.warn(`‚ö†Ô∏è Vote element not found for mode: ${mode}`);
                }
            });

            // Vote button logic removed - using instant voting on card click
            if (userVote) {
                console.log('üë§ User has voted for:', userVote);
            } else {
                console.log('üë§ User has not voted yet');
            }
        }

        function getLeader() {
            const leader = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
            console.log('üèÜ Current leader:', leader, 'with', votes[leader], 'votes');
            return leader;
        }

        // Load and display personal stats
        async function loadPersonalStats() {
            if (!isAuthenticated || !userFID || !supabase) return;
            
            try {
                // Show stats section
                const statsSection = document.getElementById('personalStats');
                if (statsSection) {
                    statsSection.classList.add('active');
                }
                
                // Get total votes for this user
                const { data: userVotes, error: votesError } = await supabase
                    .from('votes')
                    .select('*')
                    .eq('fid', parseInt(userFID));
                
                if (votesError) {
                    console.error('Error loading user votes:', votesError);
                    return;
                }
                
                // Calculate stats
                const totalVotes = userVotes ? userVotes.length : 0;
                
                // Calculate favorite mode
                const modeCounts = {};
                if (userVotes) {
                    userVotes.forEach(vote => {
                        modeCounts[vote.mode] = (modeCounts[vote.mode] || 0) + 1;
                    });
                }
                const favoriteMode = Object.keys(modeCounts).length > 0
                    ? Object.keys(modeCounts).reduce((a, b) => modeCounts[a] > modeCounts[b] ? a : b)
                    : '‚Äî';
                
                const modeEmojis = {
                    studio: 'üé¨',
                    market: 'üõí',
                    social: 'üåê',
                    battle: '‚öîÔ∏è'
                };
                
                // Calculate streak (simplified - just check if voted today and yesterday)
                const today = getVoteDate();
                const estNow = getESTDate();
                const yesterday = new Date(estNow.getTime() - 86400000).toISOString().split('T')[0];
                
                const votedToday = userVotes?.some(v => v.vote_date === today);
                const votedYesterday = userVotes?.some(v => v.vote_date === yesterday);
                
                let streak = 0;
                if (votedToday) streak = 1;
                if (votedToday && votedYesterday) streak = 2; // Simplified - could be extended
                
                // Calculate vote power based on /zao activity and Neynar score
                const powerData = await calculateVotePower(userFID);
                userVotePower = powerData.power; // Cache for later use
                
                // Update UI
                document.getElementById('statTotalVotes').textContent = totalVotes;
                document.getElementById('statStreak').textContent = streak;
                document.getElementById('statFavoriteMode').textContent = 
                    favoriteMode !== '‚Äî' ? modeEmojis[favoriteMode] : '‚Äî';
                updateVotePowerDisplay(powerData);
                
                console.log('‚úÖ Personal stats loaded:', { totalVotes, streak, favoriteMode, votePower: powerData.power });
            } catch (err) {
                console.error('Error loading personal stats:', err);
            }
        }

        // VISUAL CHANGE 1 & 2: Update percentage bars and leading badge
        function updatePercentageBars() {
            const totalVotes = votes.studio + votes.market + votes.social + votes.battle;
            
            if (totalVotes === 0) {
                console.log('üìä [VISUAL] No votes yet, bars at 0%');
                return;
            }
            
            const modes = ['studio', 'market', 'social', 'battle'];
            let maxVotes = 0;
            let leadingMode = null;
            
            modes.forEach(mode => {
                const percentage = (votes[mode] / totalVotes) * 100;
                const fillEl = document.querySelector(`[data-percentage="${mode}"]`);
                
                if (fillEl) {
                    fillEl.style.width = `${percentage}%`;
                }
                
                if (votes[mode] > maxVotes) {
                    maxVotes = votes[mode];
                    leadingMode = mode;
                }
            });
            
            // Show/hide leading badges
            modes.forEach(mode => {
                const card = document.querySelector(`[data-mode="${mode}"]`);
                const badge = card?.querySelector('.leading-badge');
                
                if (badge) {
                    badge.style.display = (mode === leadingMode) ? 'inline-flex' : 'none';
                }
            });
            
            console.log('üìä [VISUAL] Percentage bars updated:', {
                totalVotes,
                leadingMode,
                percentages: modes.map(m => `${m}: ${((votes[m] / totalVotes) * 100).toFixed(1)}%`)
            });
        }
        
        function updateLeader() {
            console.log('üîÑ updateLeader() called');
            console.log('üìä Current votes:', votes);
            
            const leader = getLeader();
            
            console.log('üèÜ Highlighting leader:', leader, 'with', votes[leader], 'votes');
            
            // Remove leading class from all cards
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('leading');
                console.log('üóëÔ∏è Removed leading from:', card.dataset.mode);
            });

            // Add leading class to winner
            const leaderCard = document.querySelector(`[data-mode="${leader}"]`);
            if (leaderCard) {
                leaderCard.classList.add('leading');
                console.log('‚úÖ Added "leading" class to', leader);
                console.log('üéØ Leader card classes:', leaderCard.className);
            } else {
                console.error('‚ùå Could not find leader card for:', leader);
                console.log('üîç Available cards:', 
                    Array.from(document.querySelectorAll('.mode-card')).map(c => c.dataset.mode)
                );
            }

            // Update today section if it exists
            const todayMode = document.getElementById('todayMode');
            const todayDesc = document.getElementById('todayDesc');
            if (todayMode && todayDesc && leaderCard) {
                const modeName = leaderCard.querySelector('.mode-name').textContent;
                todayMode.textContent = modeName;
                todayDesc.textContent = `Leading with ${votes[leader]} votes`;
                console.log('‚úÖ Updated today section:', modeName);
            }
        }

        // Initialize
        /* ==============================================
           URL CONTEXT PARSING & SMART SCROLL
        ============================================== */

        // Parse URL context params and handle scroll intent
        function parseAndHandleURLContext() {
            const params = new URLSearchParams(window.location.search);
            const voteContext = params.get('vote');
            
            if (voteContext) {
                console.log('üîó [CONTEXT] URL context detected:', voteContext);
                
                // Clean URL after parsing (keep it clean)
                history.replaceState({}, document.title, window.location.pathname);
                
                // Return context for later handling (after init completes)
                return voteContext;
            }
            
            return null;
        }

        // Handle context scroll after initialization completes
        async function handleContextScroll(context) {
            if (!context) return;
            
            console.log('üìç [CONTEXT] Handling scroll for:', context);
            
            // Respect motion preferences
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const scrollBehavior = prefersReducedMotion ? 'auto' : 'smooth';
            
            if (context === 'daily') {
                // Scroll to daily voting section
                const dailySection = document.querySelector('.wheel-section');
                if (dailySection) {
                    dailySection.scrollIntoView({ behavior: scrollBehavior, block: 'center' });
                    
                    // Add temporary highlight to daily section
                    dailySection.style.outline = '2px solid rgba(79, 209, 197, 0.6)';
                    dailySection.style.outlineOffset = '8px';
                    dailySection.style.borderRadius = '12px';
                    
                    setTimeout(() => {
                        dailySection.style.outline = '';
                        dailySection.style.outlineOffset = '';
                    }, 1200);
                    
                    console.log('‚úÖ [CONTEXT] Scrolled to daily voting');
                }
            } else if (context === 'weekly') {
                // Check if weekly is locked or unlocked
                const weeklySection = document.getElementById('weeklyFocusSection');
                const isLocked = weeklySection?.classList.contains('locked');
                
                if (isLocked) {
                    // Weekly is locked - scroll to daily with CTA message
                    console.log('üîí [CONTEXT] Weekly locked - redirecting to daily');
                    const dailySection = document.querySelector('.wheel-section');
                    if (dailySection) {
                        dailySection.scrollIntoView({ behavior: scrollBehavior, block: 'center' });
                        
                        // Highlight daily section
                        dailySection.style.outline = '2px solid rgba(224, 221, 170, 0.6)';
                        dailySection.style.outlineOffset = '8px';
                        dailySection.style.borderRadius = '12px';
                        
                        setTimeout(() => {
                            dailySection.style.outline = '';
                            dailySection.style.outlineOffset = '';
                        }, 1200);
                        
                        // Show contextual toast
                        showToast('info', 'Vote Today First', 'Vote on today\'s stream to unlock weekly voting.');
                    }
                } else {
                    // Weekly is unlocked - scroll to weekly section
                    console.log('‚úÖ [CONTEXT] Weekly unlocked - scrolling to weekly');
                    if (weeklySection) {
                        weeklySection.scrollIntoView({ behavior: scrollBehavior, block: 'center' });
                        
                        // Highlight weekly section
                        weeklySection.style.outline = '2px solid rgba(79, 209, 197, 0.6)';
                        weeklySection.style.outlineOffset = '8px';
                        weeklySection.style.borderRadius = '12px';
                        
                        setTimeout(() => {
                            weeklySection.style.outline = '';
                            weeklySection.style.outlineOffset = '';
                        }, 1200);
                    }
                }
            }
        }

        async function initialize() {
            console.log('üöÄ Initializing app...');
            
            // Set up offline/online event listeners
            window.addEventListener('offline', handleOffline);
            window.addEventListener('online', handleOnline);
            
            // Check initial online status
            if (!navigator.onLine) {
                handleOffline();
            }
            
            // Parse URL context early (before clearing)
            const urlContext = parseAndHandleURLContext();
            
            updateHeroState();
            console.log('‚úÖ Hero state updated');
            
            // Initialize Farcaster authentication
            initializeFarcaster();
            checkLiveStatus();
            
            // Check live status every 2 minutes (using lifecycle manager)
            window.appLifecycle.addInterval(checkLiveStatus, 120000, 'live-status-check');
            
            // Manual controls for testing (remove in production)
            window.setLiveStatus = function(status) {
                localStorage.setItem('zabalLiveStatus', status);
                if (status === 'live') {
                    showLiveBanner();
                } else {
                    hideLiveBanner();
                }
            }
            
            // Load votes from database
            await loadVotes();
            
            // Update leader display after votes loaded
            updateLeader();
            console.log('‚úÖ Initial leader update complete');
            
            // Load vote history
            await loadVoteHistory();
            
            // Initialize weekly social voting with gating
            console.log('üéØ [INIT] Checking daily vote status for weekly gating...');
            const hasVotedToday = await checkDailyVoteStatus();
            
            if (hasVotedToday) {
                console.log('‚úÖ [INIT] User voted today - unlocking weekly voting');
                await initializeWeeklySocial();
                unlockWeeklyVoting(false); // Silent unlock on page load
            } else {
                console.log('üîí [INIT] User has not voted today - locking weekly voting');
                await initializeWeeklySocial(); // Still load results, just lock UI
                lockWeeklyVoting();
            }
            console.log('‚úÖ Weekly social voting initialized');
            
            // Initialize comments section
            await initializeComments();
            console.log('‚úÖ Comments section initialized');
            
            // Initialize real-time vote subscriptions
            subscribeToVoteUpdates();
            console.log('‚úÖ Real-time vote updates enabled');
            
            // Fallback polling every 60 seconds (reduced from 30s since we have realtime)
            window.appLifecycle.addInterval(loadVotes, 60000, 'vote-refresh');
            console.log('‚úÖ Vote refresh fallback interval set (60s)');
            
            // Refresh weekly social results every 30 seconds
            window.appLifecycle.addInterval(loadWeeklySocialResults, 30000, 'weekly-refresh');
            console.log('‚úÖ Weekly social refresh interval set (30s)');
            
            window.appLifecycle.addInterval(updateCountdown, 1000, 'countdown');
            updateCountdown();
            console.log('‚úÖ Countdown started');
            
            // Check if daily voting is already closed and show winning share card
            updateDailyWinningCard();
            
            console.log('üéâ ZABAL Live Hub ready!');
            
            // Handle context scroll after everything is initialized
            if (urlContext) {
                setTimeout(() => handleContextScroll(urlContext), 500);
            }
        }
        
        // ============================================
        // WEEKLY SOCIAL FOCUS VOTING LOGIC
        // ============================================
        
        // Get current week key (ISO week format: YYYY-Www)
        // Week runs Monday 00:00 UTC to Sunday 23:59 UTC
        function getCurrentWeekKey() {
            const now = new Date();
            const utcDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            
            // Get ISO week number
            const dayNum = utcDate.getUTCDay() || 7; // Make Sunday = 7
            utcDate.setUTCDate(utcDate.getUTCDate() + 4 - dayNum); // Thursday of current week
            const yearStart = new Date(Date.UTC(utcDate.getUTCFullYear(), 0, 1));
            const weekNum = Math.ceil((((utcDate - yearStart) / 86400000) + 1) / 7);
            
            const weekKey = `${utcDate.getUTCFullYear()}-W${String(weekNum).padStart(2, '0')}`;
            return weekKey;
        }
        
        /* ==============================================
           WEEKLY VOTING LOGIC
        ============================================== */

        // Show Farcaster client selection modal
        window.showFarcasterClientSelection = function() {
            const modal = document.getElementById('farcasterClientModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('üü£ [FARCASTER] Client selection modal opened');
            }
        }

        // Close Farcaster client selection modal
        window.closeFarcasterClientModal = function() {
            const modal = document.getElementById('farcasterClientModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('üü£ [FARCASTER] Client selection modal closed');
            }
        }

        // Submit Farcaster vote with selected client
        window.submitFarcasterWithClient = async function(client) {
            console.log('üü£ [FARCASTER] Client selected:', client);
            
            // Store the selected client
            localStorage.setItem('farcaster_client_choice', client);
            
            // Close the modal
            closeFarcasterClientModal();
            
            // Submit the Farcaster vote
            await submitWeeklySocialVote('Farcaster');
        }

        // Submit weekly social vote (single-select only) - DB-backed
        window.submitWeeklySocialVote = async function(platform) {
            try {
                
                // CRITICAL: Check if weekly voting is locked (gating)
                const section = document.getElementById('weeklyFocusSection');
                if (section?.classList.contains('locked')) {
                    return; // Silent fail - no error toast (UX gating, not error)
                }
                
                // Check if user is authenticated
                if (!isAuthenticated || !userFID) {
                    showToast('info', 'Farcaster Required', 'Open in Warpcast to participate in weekly voting!');
                    return;
                }
                
                if (!supabase) {
                    console.error('‚ùå [WEEKLY SOCIAL] Supabase not initialized');
                    showToast('error', 'Database Error', 'Database not connected. Please refresh the page.');
                    return;
                }
                
                // Show loading state
                window.loadingManager?.show('weeklyVote');
                
                // Validate FID before database operation (match daily voting pattern)
                const validatedFID = window.Validator.validateFID(userFID);
                
                // Calculate vote power SERVER-SIDE via serverless function
                let votePowerData;
                try {
                    const vpResponse = await fetch(`/api/calculate-vote-power?fid=${validatedFID}`);
                    if (vpResponse.ok) {
                        votePowerData = await vpResponse.json();
                        
                        // Cache the result in database
                        await supabase.rpc('update_vote_power_cache', {
                            p_fid: validatedFID,
                            p_vote_power: votePowerData.power,
                            p_zao_casts: votePowerData.zaoCasts,
                            p_neynar_score: votePowerData.neynarScore
                        });
                    } else {
                        console.warn('‚ö†Ô∏è [WEEKLY SOCIAL] Vote power calculation failed, using default');
                        votePowerData = { power: 1 };
                    }
                } catch (vpError) {
                    console.error('‚ùå [WEEKLY SOCIAL] Vote power error:', vpError);
                    votePowerData = { power: 1 };
                }
                
                // Normalize platform name to match database constraint
                const platformMap = {
                    'X (Twitter)': 'twitter',
                    'Farcaster': 'farcaster',
                    'TikTok': 'tiktok',
                    'YouTube': 'youtube',
                    'Instagram': 'instagram'
                };
                const normalizedPlatform = platformMap[platform] || platform.toLowerCase();
                
                // Call Supabase RPC to submit vote (vote_power read from cache server-side)
                const { data, error } = await supabase.rpc('submit_weekly_social_vote', {
                    user_fid: validatedFID,
                    platform_choice: normalizedPlatform
                });
                
                window.loadingManager?.hide('weeklyVote');
                
                if (error) {
                    console.error('‚ùå [WEEKLY SOCIAL] RPC error:', error);
                    console.error('‚ùå [WEEKLY SOCIAL] Full error object:', JSON.stringify(error, null, 2));
                    console.error('‚ùå [WEEKLY SOCIAL] Error details:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    showToast('error', 'Submission Failed', error.message || 'Could not submit vote. Please try again.');
                    return;
                }
                
                // Check if RPC call was successful
                if (!data || !data.success) {
                    console.error('‚ùå [WEEKLY SOCIAL] Vote failed:', data?.error || 'Unknown error');
                    showToast('error', 'Vote Failed', 'Could not submit vote. Please try again.');
                    return;
                }
                
                // Show appropriate feedback based on vote state
                if (data.previous_platform && data.changed) {
                    console.log('üîÑ [WEEKLY SOCIAL] Vote changed from', data.previous_platform, 'to', data.new_platform);
                    showToast('success', 'Vote Changed', `Changed from ${data.previous_platform} to ${data.new_platform}`, 3000, () => {
                        showShareButton('social', platform);
                    });
                } else if (data.previous_platform && !data.changed) {
                    console.log('‚úÖ [WEEKLY SOCIAL] Vote confirmed for', data.new_platform);
                    showToast('info', 'Vote Confirmed', `Still voting for ${data.new_platform}`, 3000, () => {
                        showShareButton('social', platform);
                    });
                } else {
                    console.log('‚úÖ [WEEKLY SOCIAL] First vote recorded for', data.new_platform);
                    showToast('success', 'Vote Recorded', `Voted for ${data.new_platform}`, 3000, () => {
                        showShareButton('social', platform);
                    });
                }
                
                // Update UI (but don't disable cards)
                await loadWeeklySocialResults();
                showWeeklySocialVotedState(platform);
                
                // Track social vote completion
                localStorage.setItem('completed_social_vote', platform);
                
            } catch (error) {
                console.error('‚ùå [WEEKLY SOCIAL] Error submitting vote:', error);
                showToast('error', 'Submission Failed', 'Could not record vote. Please try again.');
            }
        }
        
        // Load and display weekly social results - DB-backed
        async function loadWeeklySocialResults() {
            try {
                if (!supabase) {
                    log.error('loadWeeklySocialResults:no-supabase');
                    return;
                }
                
                // Call Supabase RPC to get results
                const { data, error } = await supabase.rpc('get_weekly_social_results');
                
                if (error) {
                    log.error('loadWeeklySocialResults:rpc-failed', error);
                    return;
                }
                
                const resultsContainer = document.getElementById('socialFocusResults');
                if (!resultsContainer) return;
                
                // If no results, show empty state
                if (!data || data.length === 0) {
                    resultsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 0.85rem; padding: 1rem;">Be the first to signal this.</div>';
                    return;
                }
                
                // Calculate total vote power and find max
                const totalVotePower = data.reduce((sum, item) => sum + parseFloat(item.total_power), 0);
                const maxVotePower = Math.max(...data.map(item => parseFloat(item.total_power)));
                
                // Find leading platform for emphasis message
                const leadingPlatform = data.find(item => parseFloat(item.total_power) === maxVotePower && maxVotePower > 0);
                
                // Update leader emphasis message
                const leaderMessage = document.getElementById('weeklyLeaderMessage');
                if (leaderMessage && leadingPlatform) {
                    leaderMessage.textContent = `Most of the community is backing ${leadingPlatform.platform} this week.`;
                    leaderMessage.style.display = 'block';
                } else if (leaderMessage) {
                    leaderMessage.style.display = 'none';
                }
                
                // Render results with leading badge
                resultsContainer.innerHTML = data
                    .map(item => {
                        const votePower = parseFloat(item.total_power);
                        const voterCount = parseInt(item.voter_count) || 0;
                        const percentage = totalVotePower > 0 ? (votePower / totalVotePower * 100) : 0;
                        const isLeading = votePower === maxVotePower && votePower > 0;
                        
                        return `
                            <div class="focus-result-item ${isLeading ? 'leading' : ''}">
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <span class="focus-result-name">${item.platform}</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            ${isLeading ? '<span class="leading-badge">üî• Most Backed</span>' : ''}
                                            <span class="focus-result-votes">${votePower.toFixed(1)}x</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                        <span style="font-size: 0.75rem; color: var(--text-gray);">${voterCount} voter${voterCount !== 1 ? 's' : ''}</span>
                                        <span style="font-size: 0.75rem; color: var(--text-gray);">${percentage.toFixed(1)}%</span>
                                    </div>
                                    <div class="focus-result-bar">
                                        <div class="focus-result-bar-fill" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    })
                    .join('');
                
                // Show appropriate card based on voting status
                if (leadingPlatform) {
                    const leaderVoterCount = parseInt(leadingPlatform.voter_count) || 0;
                    
                    // Check if weekly voting period has ended (Monday 5 PM ET)
                    const now = new Date();
                    const etNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
                    const dayOfWeek = etNow.getDay();
                    const hour = etNow.getHours();
                    const isWeeklyVotingClosed = (dayOfWeek === 1 && hour >= 17); // Monday after 5 PM
                    
                    if (isWeeklyVotingClosed) {
                        // Show final winning card after voting closes
                        updateWeeklyWinningCard(leadingPlatform.platform, leaderVoterCount);
                        updateWeeklyCurrentlyWinningCard(null, 0); // Hide currently winning
                    } else {
                        // Show currently winning card during active voting
                        updateWeeklyCurrentlyWinningCard(leadingPlatform.platform, leaderVoterCount);
                        updateWeeklyWinningCard(null, 0); // Hide final winning
                    }
                } else {
                    // No leader - hide both cards
                    updateWeeklyCurrentlyWinningCard(null, 0);
                    updateWeeklyWinningCard(null, 0);
                }
                
            } catch (error) {
                log.error('loadWeeklySocialResults:exception', error);
            }
        }
        
        // Show "you voted" state
        function showWeeklySocialVotedState(platform) {
            const stateEl = document.getElementById('weeklySocialVotedState');
            const platformEl = document.getElementById('weeklySocialVotedPlatform');
            
            if (stateEl && platformEl) {
                platformEl.textContent = `Your choice: ${platform}`;
                stateEl.style.display = 'flex';
            }            
        }
        
        // Initialize weekly social voting - DB-backed
        async function initializeWeeklySocial() {
            try {
                console.log('üéØ [WEEKLY SOCIAL] Initializing...');
                
                if (!supabase) {
                    console.error('‚ùå [WEEKLY SOCIAL] Supabase not initialized');
                    return;
                }
                
                // Load results from DB
                await loadWeeklySocialResults();
                
                // Check if user already voted this week (requires auth)
                if (isAuthenticated && userFID) {
                    console.log('üì§ [WEEKLY SOCIAL] Calling has_voted_this_week RPC for FID:', userFID);
                    
                    const { data, error } = await supabase.rpc('has_voted_this_week', {
                        user_fid: userFID
                    });
                    
                    if (error) {
                        console.error('‚ùå [WEEKLY SOCIAL] RPC error:', error);
                        return;
                    }
                    
                    console.log('üì• [WEEKLY SOCIAL] RPC response:', data);
                    
                    if (data && data.has_voted) {
                        const votedPlatform = data.platform;
                        console.log('‚úÖ [WEEKLY SOCIAL] User already voted for:', votedPlatform);
                        showWeeklySocialVotedState(votedPlatform);
                        // Cards remain clickable - users can change their vote
                    } else {
                        console.log('üó≥Ô∏è [WEEKLY SOCIAL] User has not voted this week - buttons enabled');
                    }
                } else {
                    console.log('‚ö†Ô∏è [WEEKLY SOCIAL] User not authenticated - voting disabled');
                }
                
                console.log('‚úÖ [WEEKLY SOCIAL] Initialized');
            } catch (error) {
                console.error('‚ùå [WEEKLY SOCIAL] Error initializing:', error);
            }
        }
        
        // ============================================
        // WEEKLY VOTING GATING LOGIC
        // ============================================
        
        // Get today's date in UTC (YYYY-MM-DD format)
        function getTodayUTC() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }
        
        // Get Monday of current week in ET timezone (YYYY-MM-DD format)
        function getCurrentWeekMonday() {
            const now = new Date();
            const et = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
            const dayOfWeek = et.getDay(); // 0 = Sunday, 1 = Monday
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // If Sunday, go back 6 days
            const monday = new Date(et);
            monday.setDate(et.getDate() + diff);
            return monday.toISOString().split('T')[0];
        }
        
        // Lock weekly voting section
        function lockWeeklyVoting() {
            const section = document.getElementById('weeklyFocusSection');
            const overlay = document.getElementById('weeklyUnlockOverlay');
            
            if (section && overlay) {
                section.classList.add('locked');
                overlay.style.display = 'block';
                console.log('üîí [WEEKLY GATING] Weekly voting locked');
            }
        }
        
        /* ==============================================
           WEEKLY GATING LOGIC
        ============================================== */

        // Unlock weekly voting section
        // showFeedback: if true, shows toast + scroll (for first unlock after daily vote)
        //               if false, silent unlock (for page load when already voted)
        function unlockWeeklyVoting(showFeedback = false) {
            const section = document.getElementById('weeklyFocusSection');
            const overlay = document.getElementById('weeklyUnlockOverlay');
            
            if (section && overlay) {
                section.classList.remove('locked');
                section.classList.add('unlocking');
                overlay.style.display = 'none';
                
                // Remove unlocking animation class after animation completes
                setTimeout(() => {
                    section.classList.remove('unlocking');
                }, 500);
                
                console.log('üîì [WEEKLY GATING] Weekly voting unlocked', showFeedback ? '(with feedback)' : '(silent)');
                
                // Only show toast + scroll on first unlock (after daily vote)
                if (showFeedback) {
                    showToast('success', 'Weekly Voting Unlocked!', 'You can now vote on social media focus');
                    
                    // Scroll weekly section into view (subtle)
                    setTimeout(() => {
                        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            }
        }
        
        // Show optional share button after vote actions
        function showShareButton(actionType, value) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            // Remove any existing share buttons
            const existingBtn = document.getElementById('floatingShareBtn');
            if (existingBtn) existingBtn.remove();
            
            const shareBtn = document.createElement('div');
            shareBtn.id = 'floatingShareBtn';
            shareBtn.className = 'floating-share-button';
            shareBtn.innerHTML = `
                <button onclick="handleShareClick('${actionType}', '${value}')" class="share-btn-primary">
                    <span class="share-icon">üöÄ</span>
                    Share to Farcaster
                </button>
                <button onclick="document.getElementById('floatingShareBtn').remove()" class="share-btn-close">
                    √ó
                </button>
            `;
            
            document.body.appendChild(shareBtn);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (shareBtn.parentElement) {
                    shareBtn.classList.add('fade-out');
                    setTimeout(() => shareBtn.remove(), 300);
                }
            }, 10000);
        }
        
        // Handle share button click - direct Farcaster composer (no modal)
        window.handleShareClick = function(actionType, value) {
            console.log('üöÄ [SHARE] handleShareClick called with:', { actionType, value });
            
            // Remove the floating button
            const btn = document.getElementById('floatingShareBtn');
            if (btn) {
                console.log('‚úÖ [SHARE] Removing floating button');
                btn.remove();
            }
            
            // Direct share - instant, fluid UX
            console.log('üéØ [SHARE] Calling window.shareToFarcaster...');
            console.log('üîç [SHARE] window.shareToFarcaster exists?', typeof window.shareToFarcaster);
            
            if (typeof window.shareToFarcaster === 'function') {
                window.shareToFarcaster();
            } else {
                console.error('‚ùå [SHARE] window.shareToFarcaster is not a function!');
            }
        };
        
        // CRITICAL FIX: Monitor popup for direct opening (bypassing shareToFarcaster)
        // This handles cases where something directly sets display:flex on the popup
        const friendTagPopup = document.getElementById('friendTagPopup');
        if (friendTagPopup) {
            console.log('üîß [POPUP MONITOR] Installing MutationObserver on friendTagPopup');
            console.log('üîß [POPUP MONITOR] Initial popup display:', friendTagPopup.style.display);
            
            let lastVisibleState = false;
            
            const observer = new MutationObserver((mutations) => {
                console.log('üëÅÔ∏è [POPUP MONITOR] Mutation detected, checking', mutations.length, 'mutations');
                
                mutations.forEach((mutation) => {
                    console.log('üëÅÔ∏è [POPUP MONITOR] Mutation type:', mutation.type, '| attribute:', mutation.attributeName);
                    
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const currentDisplay = friendTagPopup.style.display;
                        const computedDisplay = window.getComputedStyle(friendTagPopup).display;
                        const isVisible = currentDisplay === 'flex' || computedDisplay === 'flex';
                        
                        console.log('üëÅÔ∏è [POPUP MONITOR] Style changed:');
                        console.log('  - style.display:', currentDisplay);
                        console.log('  - computed display:', computedDisplay);
                        console.log('  - isVisible:', isVisible);
                        console.log('  - lastVisibleState:', lastVisibleState);
                        
                        if (isVisible && !lastVisibleState) {
                            console.log('üö® [POPUP MONITOR] Popup just became visible!');
                            console.log('üö® [POPUP MONITOR] Checking if friends need to be loaded...');
                            console.log('üö® [POPUP MONITOR] window.loadRandomizedFriends exists?', typeof window.loadRandomizedFriends);
                            console.log('üö® [POPUP MONITOR] window.bestFriends:', window.bestFriends?.length || 0);
                            
                            // Load friends if popup was opened without going through shareToFarcaster()
                            if (window.loadRandomizedFriends) {
                                console.log('‚úÖ [POPUP MONITOR] Calling loadRandomizedFriends("random")');
                                window.loadRandomizedFriends('random');
                            } else {
                                console.error('‚ùå [POPUP MONITOR] window.loadRandomizedFriends not found!');
                            }
                        }
                        
                        lastVisibleState = isVisible;
                    }
                });
            });
            
            observer.observe(friendTagPopup, {
                attributes: true,
                attributeFilter: ['style']
            });
            
            console.log('‚úÖ [POPUP MONITOR] MutationObserver installed and active');
        } else {
            console.error('‚ùå [POPUP MONITOR] friendTagPopup element not found!');
        }
        
        // DEPRECATED: Check if all 3 actions are complete and trigger share modal
        // Now using optional share buttons instead
        function checkAndTriggerShareModal() {
            const streamVote = localStorage.getItem('completed_stream_vote');
            const socialVote = localStorage.getItem('completed_social_vote');
            const comment = localStorage.getItem('completed_comment');
            
            console.log('üéØ [SHARE CHECK] Actions status:', { streamVote, socialVote, comment });
            
            // All 3 actions must be complete
            if (streamVote && socialVote && comment) {
                console.log('‚úÖ [SHARE CHECK] All actions complete - triggering share modal');
                
                // Build custom share message
                const modeEmojis = {
                    studio: 'üé¨',
                    market: 'üõí',
                    social: 'üåê',
                    battle: '‚öîÔ∏è'
                };
                
                const platformEmojis = {
                    farcaster: 'üü£',
                    twitter: 'üê¶',
                    youtube: 'üì∫',
                    tiktok: 'üéµ',
                    instagram: 'üì∏'
                };
                
                const streamEmoji = modeEmojis[streamVote] || '';
                const socialEmoji = platformEmojis[socialVote.toLowerCase()] || '';
                
                // Format: zm I voted for [emoji] [mode] for stream, [emoji] [platform] for social media, and commented "[comment]"
                const customMessage = `zm I voted for ${streamEmoji} ${streamVote} for stream, ${socialEmoji} ${socialVote} for social media, and commented "${comment}"`;
                
                // Clear completion flags
                localStorage.removeItem('completed_stream_vote');
                localStorage.removeItem('completed_social_vote');
                localStorage.removeItem('completed_comment');
                
                // DEPRECATED: No longer auto-triggering share modal
                // Users can now share via optional buttons after each action
                console.log('‚ÑπÔ∏è All actions complete. Users can share via optional buttons.');
            }
        }
        
        // Open share modal with custom message
        function openShareModalWithCustomMessage(customMessage) {
            const modal = document.getElementById('shareModal');
            if (!modal) return;
            
            console.log('üì§ Opening share modal with custom message:', customMessage);
            
            // Set custom message in the share text area if it exists
            const shareTextArea = modal.querySelector('textarea');
            if (shareTextArea) {
                shareTextArea.value = customMessage;
            }
            
            // Show modal
            modal.style.display = 'flex';
            
            // Trigger Farcaster share composer if available
            if (window.farcasterSDK?.actions?.openComposer) {
                window.farcasterSDK.actions.openComposer({
                    text: customMessage,
                    embeds: ['https://zabal.art']
                });
            }
        }
        
        // Check if user has voted today (hybrid: localStorage + DB)
        async function checkDailyVoteStatus() {
            try {
                const today = getTodayUTC();
                
                // 1. Check localStorage first (instant)
                const localVoted = localStorage.getItem('weekly_voted_this_week') === 'true';
                const votedDate = localStorage.getItem('weekly_voted_date');
                const currentWeekMonday = getCurrentWeekMonday();
                
                console.log('üîç [WEEKLY GATING] Checking weekly vote status:', { localVoted, votedDate, currentWeekMonday });
                
                // If localStorage says voted today, trust it (instant unlock)
                if (localVoted && votedDate === currentWeekMonday) {
                    console.log('‚úÖ [WEEKLY GATING] localStorage confirms vote today - instant unlock');
                    return true;
                }
                
                // If date mismatch, clear stale localStorage
                if (votedDate && votedDate !== today) {
                    console.log('üóëÔ∏è [WEEKLY GATING] Clearing stale localStorage (date mismatch)');
                    localStorage.removeItem('daily_voted_today');
                    localStorage.removeItem('daily_voted_date');
                }
                
                // 2. Check DB (authoritative)
                if (!supabase || !isAuthenticated || !userFID) {
                    console.log('‚ö†Ô∏è [WEEKLY GATING] Cannot check DB - not authenticated');
                    return false;
                }
                
                console.log('üì§ [WEEKLY GATING] Checking DB for weekly vote...');
                const { data, error } = await supabase.rpc('has_voted_this_week', {
                    user_fid: parseInt(userFID)
                });
                
                if (error) {
                    console.error('‚ùå [WEEKLY GATING] DB check error:', error);
                    return false;
                }
                
                console.log('üì• [WEEKLY GATING] DB response:', data);
                
                if (data === true) {
                    // Update localStorage to match DB
                    localStorage.setItem('weekly_voted_this_week', 'true');
                    localStorage.setItem('weekly_voted_date', getCurrentWeekMonday());
                    localStorage.setItem('daily_voted_date', today);
                    console.log('‚úÖ [WEEKLY GATING] DB confirms vote today - syncing localStorage');
                    return true;
                }
                
                console.log('‚ùå [WEEKLY GATING] No daily vote found');
                return false;
                
            } catch (error) {
                console.error('‚ùå [WEEKLY GATING] Error checking daily vote status:', error);
                return false;
            }
        }
        
        // ============================================
        // END WEEKLY SOCIAL FOCUS VOTING LOGIC
        // ============================================
        
        // ============================================
        // VOTE COMMENTS LOGIC
        // ============================================
        
        let currentCommentFilter = 'all';
        let allComments = [];
        
        // Initialize comments section
        async function initializeComments() {
            console.log('üí¨ [COMMENTS] Initializing...');
            
            // Set up character counter
            const commentInput = document.getElementById('commentInput');
            const charCount = document.getElementById('charCount');
            
            if (commentInput && charCount) {
                commentInput.addEventListener('input', () => {
                    const length = commentInput.value.length;
                    charCount.textContent = `${length}/500`;
                    
                    // Update button state
                    const submitBtn = document.getElementById('submitCommentBtn');
                    if (submitBtn) {
                        submitBtn.disabled = length === 0 || !isAuthenticated;
                    }
                });
            }
            
            // Load comments
            await loadComments();
            
            // Refresh comments every 30 seconds
            window.appLifecycle.addInterval(loadComments, 30000, 'comments-refresh');
            console.log('‚úÖ [COMMENTS] Initialized');
        }
        
        // Submit comment
        window.submitComment = async function() {
            const commentInput = document.getElementById('commentInput');
            const submitBtn = document.getElementById('submitCommentBtn');
            
            if (!commentInput || !submitBtn) return;
            
            const comment = commentInput.value.trim();
            
            if (!comment) {
                showToast('error', 'Empty Comment', 'Please write something before posting.');
                return;
            }
            
            if (!isAuthenticated || !userFID) {
                showToast('info', 'Farcaster Required', 'Open in Warpcast to post comments!');
                return;
            }
            
            // Get user's current vote mode
            const userVoteMode = userVote || localStorage.getItem('userVoteMode');
            
            if (!userVoteMode) {
                showToast('error', 'Vote First', 'Please vote for a mode before commenting.');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Posting...';
                
                const { data, error } = await supabase.rpc('upsert_vote_comment', {
                    p_fid: userFID,
                    p_username: username || `User ${userFID}`,
                    p_comment: comment,
                    p_vote_mode: userVoteMode
                });
                
                if (error) {
                    console.error('‚ùå [COMMENTS] Error:', error);
                    showToast('error', 'Comment Failed', 'Could not post comment. Please try again.');
                    return;
                }
                
                if (data && data[0]) {
                    const result = data[0];
                    if (result.success) {
                        showToast('success', 'Comment Posted', result.message, 3000, () => {
                            showShareButton('comment', comment);
                        });
                        
                        // Track comment completion
                        localStorage.setItem('completed_comment', comment);
                        
                        commentInput.value = '';
                        document.getElementById('charCount').textContent = '0/500';
                        
                        // Reload comments
                        await loadComments();
                    } else {
                        showToast('error', 'Comment Failed', result.message);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå [COMMENTS] Error submitting:', error);
                showToast('error', 'Submission Failed', 'Could not post comment. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post Comment';
            }
        }
        
        // Load comments
        async function loadComments() {
            try {
                if (!supabase) return;
                
                const { data, error } = await supabase.rpc('get_recent_comments', {
                    p_limit: 50
                });
                
                if (error) {
                    console.error('‚ùå [COMMENTS] Error loading:', error);
                    return;
                }
                
                allComments = data || [];
                displayComments();
                
            } catch (error) {
                console.error('‚ùå [COMMENTS] Error:', error);
            }
        }
        
        // Filter comments
        window.filterComments = function(mode) {
            currentCommentFilter = mode;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`)?.classList.add('active');
            
            displayComments();
        }
        
        // Display comments
        function displayComments() {
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;
            
            // Filter comments
            const filtered = currentCommentFilter === 'all' 
                ? allComments 
                : allComments.filter(c => c.vote_mode === currentCommentFilter);
            
            if (filtered.length === 0) {
                commentsList.innerHTML = `
                    <div class="comments-empty">
                        <div class="comments-empty-icon">üí¨</div>
                        <p>No comments yet. Be the first to share why you voted!</p>
                    </div>
                `;
                return;
            }
            
            // Render comments
            commentsList.innerHTML = filtered.map(comment => {
                const modeEmojis = {
                    studio: 'üé¨',
                    market: 'üõí',
                    social: 'üåê',
                    battle: '‚öîÔ∏è'
                };
                
                const modeNames = {
                    studio: 'Studio',
                    market: 'Market',
                    social: 'Social',
                    battle: 'Battle'
                };
                
                const timeAgo = getTimeAgo(new Date(comment.created_at));
                
                return `
                    <div class="comment-card">
                        <div class="comment-header">
                            <div class="comment-user">
                                <span class="comment-username">${escapeHtml(comment.username)}</span>
                                <span class="comment-mode-badge">
                                    ${modeEmojis[comment.vote_mode]} ${modeNames[comment.vote_mode]}
                                </span>
                            </div>
                            <span class="comment-time">${timeAgo}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(comment.comment)}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Helper: Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return `${Math.floor(seconds / 604800)}w ago`;
        }
        
        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ============================================
        // END VOTE COMMENTS LOGIC
        // ============================================
        
        // Toggle stats section expansion
        window.toggleStatsExpand = function() {
            const grid = document.getElementById('statsGrid');
            const icon = document.getElementById('statsToggleIcon');
            
            if (grid.style.display === 'none') {
                grid.style.display = 'grid';
                icon.classList.add('expanded');
            } else {
                grid.style.display = 'none';
                icon.classList.remove('expanded');
            }
        }

        // Update stats summary line
        function updateStatsSummary() {
            const summary = document.getElementById('statsSummary');
            const totalVotes = document.getElementById('statTotalVotes')?.textContent || '0';
            const votePower = document.getElementById('statVotePower')?.textContent || '1√ó';
            
            if (summary) {
                summary.textContent = `Your impact: ${totalVotes} votes cast ¬∑ ${votePower} power`;
            }
        }

        
        // Toggle vote history accordion
        window.toggleVoteHistory = function() {
            const header = document.querySelector('.accordion-header');
            const content = document.getElementById('voteHistoryAccordion');
            
            if (!header || !content) return;
            
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                header.classList.remove('active');
                content.classList.remove('expanded');
            } else {
                // Expand
                header.classList.add('active');
                content.classList.add('expanded');
            }
        }
        
        // Start the app
        initialize();
    </script>
    
    <!-- Production Enhancements -->
    <script src="js/production-enhancements.js"></script>
    
    <script>
        // Integrate production enhancements with existing code
        document.addEventListener('DOMContentLoaded', () => {
            // Show offline banner when offline
            const offlineBanner = document.getElementById('offlineBanner');
            window.addEventListener('offline', () => {
                if (offlineBanner) offlineBanner.classList.add('show');
            });
            window.addEventListener('online', () => {
                if (offlineBanner) offlineBanner.classList.remove('show');
            });
            
            // Add ARIA labels to mode cards
            document.querySelectorAll('.mode-card').forEach((card, index) => {
                const mode = card.dataset.mode;
                card.setAttribute('role', 'button');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Vote for ${mode} mode`);
                
                // Add keyboard support for mode cards
                card.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        card.click();
                    }
                });
            });
            
            // Add ARIA labels to buttons
            const submitBtn = document.getElementById('submitVotesBtn');
            if (submitBtn) {
                submitBtn.setAttribute('aria-label', 'Submit your votes');
            }
            
            // Show voting streak badge if exists
            const streak = window.dataPersistence.getVotingStreak();
            if (streak > 0) {
                const badge = document.createElement('div');
                badge.className = 'streak-badge';
                badge.innerHTML = `<span class="fire-emoji">üî•</span>${streak} day streak!`;
                badge.setAttribute('role', 'status');
                badge.setAttribute('aria-live', 'polite');
                document.body.appendChild(badge);
            }
        });
    </script>

</body>
</html>
